<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIONE - Sistem Informasi Log Book Dokumen</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* --- General Styles --- */
        body {
            background-color: #f8f9fa;
        }

        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        /* --- Dashboard Styles --- */
        .summary-card {
            border-left: 4px solid;
        }

        .border-blue {
            border-left-color: #004a9f;
        }

        .border-warning {
            border-left-color: #ffc107;
        }

        .border-danger {
            border-left-color: #dc3545;
        }

        /* --- Peminjaman & Pengembalian Styles --- */
        .signature-pad {
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            width: 100%;
            height: 150px;
            background-color: #ffffff;
            touch-action: none;
            /* Penting untuk layar sentuh */
        }

        .header-pinjam {
            background-color: #004a9f;
            color: white;
        }

        .header-kembali {
            background-color: #198754;
            color: white;
        }

        .header-penyerahan {
            background-color: #6f42c1;
            color: white;
        }

        /* Warna Ungu untuk Penyerahan */
        .highlight-row {
            background-color: #e9ecef;
        }

        /* --- PENGATURAN CETAK PDF NATIVE (ANTI-ERROR) --- */
        @media print {
            body {
                background-color: white !important;
            }

            nav.navbar {
                display: none !important;
            }

            /* Sembunyikan Navbar */
            button,
            .btn {
                display: none !important;
            }

            /* Sembunyikan semua tombol */
            .border-top.pt-3 {
                display: none !important;
            }

            /* Sembunyikan area bawah form */
            .card {
                border: none !important;
                box-shadow: none !important;
            }

            .container-fluid {
                margin-top: 0 !important;
            }

            /* Memastikan warna background header tercetak */
            .header-pinjam,
            .header-kembali,
            .header-penyerahan {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>

<body>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top shadow-sm">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold" href="#" onclick="switchTab('dashboard')">SIONE</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" id="nav-dashboard" href="#"
                            onclick="switchTab('dashboard')">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="nav-peminjaman" href="#" onclick="switchTab('peminjaman')">Form
                            Peminjaman</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="nav-pengembalian" href="#" onclick="switchTab('pengembalian')">Form
                            Pengembalian</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="nav-penyerahan" href="#" onclick="switchTab('penyerahan')">Form
                            Penyerahan Baru</a>
                    </li>
                    <!-- NAVIGATOR BARU: DATABASE -->
                    <li class="nav-item">
                        <a class="nav-link" id="nav-database" href="#" onclick="switchTab('database')">Database
                            Dokumen</a>
                    </li>
                    <!-- NAVIGATOR BARU: PENGATURAN ADMIN -->
                    <li class="nav-item">
                        <a class="nav-link text-warning" id="nav-pengaturan" href="#"
                            onclick="switchTab('pengaturan')">‚öôÔ∏è Pengaturan</a>
                    </li>
                </ul>
                <span class="navbar-text text-light small">
                    PT Surveyor Indonesia
                </span>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT CONTAINER -->
    <div class="container-fluid mt-4 mb-5 px-4">

        <!-- ========================================== -->
        <!-- VIEW 1: DASHBOARD & LOG BOOK               -->
        <!-- ========================================== -->
        <div id="view-dashboard" class="view-section active">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="mb-0 text-primary fw-bold">Dashboard Log Book Dokumen</h4>
                    <small class="text-muted">Sistem Informasi SIONE - PT Surveyor Indonesia</small>
                </div>
                <div>
                    <button class="btn btn-primary shadow-sm" onclick="switchTab('peminjaman')">+ Buat Peminjaman
                        Baru</button>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="card shadow-sm summary-card border-warning">
                        <div class="card-body">
                            <h6 class="text-muted mb-1">Sedang Dipinjam / Kembali Sebagian</h6>
                            <h3 class="mb-0 text-dark">12 <small class="text-muted fs-6">Transaksi</small></h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm summary-card border-danger">
                        <div class="card-body">
                            <h6 class="text-muted mb-1">Terlambat Dikembalikan</h6>
                            <h3 class="mb-0 text-danger">3 <small class="text-muted fs-6">Dokumen</small></h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm summary-card border-blue">
                        <div class="card-body">
                            <h6 class="text-muted mb-1">Total Transaksi (Bulan Ini)</h6>
                            <h3 class="mb-0 text-dark">45</h3>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h6 class="mb-0 fw-bold">Riwayat Transaksi Peminjaman</h6>

                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" style="width: 160px;">
                            <option value="all">Semua Status</option>
                            <option value="dipinjam">Sedang Dipinjam</option>
                            <option value="sebagian">Kembali Sebagian</option>
                            <option value="selesai">Selesai</option>
                        </select>
                        <input type="text" class="form-control form-control-sm" placeholder="Cari peminjam / No Dok..."
                            style="width: 250px;">
                        <button class="btn btn-sm btn-outline-secondary">Cari</button>
                    </div>
                </div>

                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID Transaksi</th>
                                    <th>Tgl Pinjam</th>
                                    <th>Peminjam</th>
                                    <th>Divisi</th>
                                    <th>Jml Dokumen</th>
                                    <th>Batas Waktu</th>
                                    <th>Status Keseluruhan</th>
                                    <th class="text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><span class="text-primary fw-bold">TRX-2602-001</span></td>
                                    <td>20 Feb 2026</td>
                                    <td>Budi Santoso</td>
                                    <td>IT</td>
                                    <td>2 Dokumen</td>
                                    <td>25 Feb 2026</td>
                                    <td><span class="badge bg-success">Selesai</span></td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-light border">Lihat Arsip</button>
                                    </td>
                                </tr>

                                <tr>
                                    <td><span class="text-primary fw-bold">TRX-2602-002</span></td>
                                    <td>23 Feb 2026</td>
                                    <td>Siti Aminah</td>
                                    <td>Finance</td>
                                    <td>1 Dokumen</td>
                                    <td>28 Feb 2026</td>
                                    <td><span class="badge bg-warning text-dark">Dipinjam (0/1)</span></td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-success"
                                            onclick="goToPengembalian('TRX-2602-002')">Terima Kembali</button>
                                    </td>
                                </tr>

                                <tr>
                                    <td><span class="text-primary fw-bold">TRX-2602-003</span></td>
                                    <td>10 Feb 2026</td>
                                    <td>Andi Pratama</td>
                                    <td>HR</td>
                                    <td>3 Dokumen</td>
                                    <td>15 Feb 2026</td>
                                    <td><span class="badge bg-danger">Terlambat!</span></td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-danger"
                                            onclick="kirimReminder('Andi Pratama', 'TRX-2602-003')">Kirim
                                            Reminder</button>
                                    </td>
                                </tr>

                                <tr class="table-info">
                                    <td><span class="text-primary fw-bold">TRX-2602-004</span></td>
                                    <td>24 Feb 2026</td>
                                    <td>Rina Marlina</td>
                                    <td>Pusat</td>
                                    <td>5 Dokumen</td>
                                    <td>27 Feb 2026</td>
                                    <td><span class="badge bg-info text-dark">Kembali Sebagian (3/5)</span></td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-info text-white fw-bold shadow-sm"
                                            data-bs-toggle="modal" data-bs-target="#modalDetail">Detail Dokumen</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- VIEW 2: FORM PEMINJAMAN                    -->
        <!-- ========================================== -->
        <div id="view-peminjaman" class="view-section">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="card shadow">
                        <div class="card-header header-pinjam d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Form Peminjaman Dokumen</h5>
                            <small>SIONE - PT Surveyor Indonesia</small>
                        </div>
                        <div class="card-body">
                            <form onsubmit="submitForm(event, 'peminjaman')">
                                <h6 class="text-primary border-bottom pb-2 mb-3">Informasi Peminjaman</h6>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label">Tanggal Peminjaman</label>
                                        <input type="text" class="form-control bg-light" value="25 Feb 2026" readonly>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Batas Waktu (Due Date)</label>
                                        <input type="date" id="inputBatasWaktu" class="form-control" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Divisi / Cabang</label>
                                        <select id="inputDivisiPinjam" class="form-select select-divisi-cabang"
                                            required>
                                            <option value="" selected>Pilih Divisi / Cabang...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Nama Peminjam</label>
                                        <input type="text" id="inputNamaPeminjam" class="form-control"
                                            placeholder="Masukkan nama peminjam" required>
                                    </div>
                                </div>

                                <h6 class="text-primary border-bottom pb-2 mb-3">Daftar Dokumen</h6>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-10">
                                        <input type="text" id="inputDokumen" class="form-control"
                                            list="listDokumenTersedia"
                                            placeholder="Ketik No / Nama Dokumen dari database...">
                                        <datalist id="listDokumenTersedia"></datalist>
                                    </div>
                                    <div class="col-md-2 d-grid">
                                        <button type="button" class="btn btn-secondary" onclick="tambahDokumen()">+
                                            Tambah</button>
                                    </div>
                                </div>

                                <div class="table-responsive mb-4">
                                    <table class="table table-bordered table-hover" id="tabelDokumen">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="20%">No Dokumen</th>
                                                <th width="60%">Nama Dokumen</th>
                                                <th width="20%" class="text-center">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="3" class="text-center text-muted" id="emptyRow">Belum ada
                                                    dokumen yang dipilih</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <h6 class="text-primary border-bottom pb-2 mb-3">Lampiran (Opsional)</h6>
                                <div class="mb-4">
                                    <label class="form-label">Surat/Permintaan Peminjaman Dokumen</label>
                                    <input class="form-control" type="file" accept=".pdf,.jpg,.jpeg,.png">
                                </div>

                                <h6 class="text-primary border-bottom pb-2 mb-3">Pengesahan</h6>
                                <div class="row g-4 mb-4">
                                    <div class="col-md-6 text-center">
                                        <label class="form-label fw-bold">Penerima (Peminjam)</label>
                                        <canvas id="ttdPeminjam" class="signature-pad"></canvas>
                                        <button type="button" class="btn btn-sm btn-outline-danger mt-2"
                                            onclick="padPeminjam.clear()">Hapus Tanda Tangan</button>
                                    </div>
                                    <div class="col-md-6 text-center">
                                        <label class="form-label fw-bold">Yang Menyerahkan (PIC Arsip)</label>
                                        <canvas id="ttdPicPinjam" class="signature-pad"></canvas>
                                        <button type="button" class="btn btn-sm btn-outline-danger mt-2"
                                            onclick="padPicPinjam.clear()">Hapus Tanda Tangan</button>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end gap-2 border-top pt-3">
                                    <button type="button" class="btn btn-light border"
                                        onclick="switchTab('dashboard')">Batal Kembali ke Dashboard</button>
                                    <button type="submit" class="btn btn-primary">Simpan Peminjaman & Cetak PDF</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- VIEW 3: FORM PENGEMBALIAN                  -->
        <!-- ========================================== -->
        <div id="view-pengembalian" class="view-section">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="card shadow">
                        <div class="card-header header-kembali d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Form Pengembalian Dokumen</h5>
                            <small>SIONE - PT Surveyor Indonesia</small>
                        </div>
                        <div class="card-body">

                            <div class="row mb-4 align-items-end bg-light p-3 rounded border">
                                <div class="col-md-8">
                                    <label class="form-label fw-bold">Cari No Dokumen / Transaksi (yang sedang
                                        dipinjam)</label>
                                    <input type="text" id="inputSearchTrx" class="form-control"
                                        list="listDokumenDipinjam" placeholder="Pilih atau Ketik No Dokumen...">
                                    <datalist id="listDokumenDipinjam"></datalist>
                                </div>
                                <div class="col-md-4 d-grid">
                                    <button type="button" class="btn btn-secondary"
                                        onclick="cariDokumenPengembalian()">Tampilkan Data</button>
                                </div>
                            </div>

                            <form onsubmit="submitForm(event, 'pengembalian')">
                                <h6 class="text-success border-bottom pb-2 mb-3">Detail Peminjaman Awal</h6>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-3">
                                        <label class="form-label text-muted">Tanggal Pinjam</label>
                                        <input type="text" class="form-control" value="23 Feb 2026" readonly disabled>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label text-muted">Peminjam Awal</label>
                                        <input type="text" class="form-control" value="Siti Aminah" readonly disabled>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label text-muted">Divisi</label>
                                        <input type="text" class="form-control" value="Finance" readonly disabled>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold text-dark">Tanggal Kembali (Sekarang)</label>
                                        <input type="text" class="form-control bg-warning bg-opacity-25"
                                            value="25 Feb 2026" readonly>
                                    </div>
                                </div>

                                <h6 class="text-success border-bottom pb-2 mb-3">Checklist Dokumen yang Dikembalikan
                                </h6>
                                <p class="text-muted small">Centang dokumen yang fisiknya diserahkan saat ini. Jika ada
                                    yang tidak dicentang, status menjadi Pengembalian Sebagian.</p>
                                <div class="table-responsive mb-4">
                                    <table class="table table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="10%" class="text-center">Kembali?</th>
                                                <th width="20%">No Dokumen</th>
                                                <th width="50%">Nama Dokumen</th>
                                                <th width="20%">Status Saat Ini</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabelDokumenKembali">
                                            <tr>
                                                <td colspan="4" class="text-center text-muted">Silakan cari dokumen di
                                                    atas lalu klik "Tampilkan Data"</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <h6 class="text-success border-bottom pb-2 mb-3">Informasi Pengembali</h6>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label">Nama yang Menyerahkan (Pengembali)</label>
                                        <input type="text" class="form-control" value="Siti Aminah">
                                        <small class="text-muted">Bisa diedit jika diwakilkan oleh staf lain.</small>
                                    </div>
                                </div>

                                <h6 class="text-success border-bottom pb-2 mb-3">Pengesahan Pengembalian</h6>
                                <div class="row g-4 mb-4">
                                    <div class="col-md-6 text-center">
                                        <label class="form-label fw-bold">Yang Menyerahkan (Pengembali)</label>
                                        <canvas id="ttdPengembali" class="signature-pad"></canvas>
                                        <button type="button" class="btn btn-sm btn-outline-danger mt-2"
                                            onclick="padPengembali.clear()">Hapus Tanda Tangan</button>
                                    </div>
                                    <div class="col-md-6 text-center">
                                        <label class="form-label fw-bold">Penerima (PIC Arsip)</label>
                                        <canvas id="ttdPicKembali" class="signature-pad"></canvas>
                                        <button type="button" class="btn btn-sm btn-outline-danger mt-2"
                                            onclick="padPicKembali.clear()">Hapus Tanda Tangan</button>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end gap-2 border-top pt-3">
                                    <button type="button" class="btn btn-light border"
                                        onclick="switchTab('dashboard')">Batal Kembali ke Dashboard</button>
                                    <button type="submit" class="btn btn-success">Konfirmasi & Cetak PDF</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- VIEW 4: FORM PENYERAHAN DOKUMEN BARU       -->
        <!-- ========================================== -->
        <div id="view-penyerahan" class="view-section">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="card shadow">
                        <div class="card-header header-penyerahan d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Form Penyerahan Dokumen Baru</h5>
                            <small>SIONE - PT Surveyor Indonesia</small>
                        </div>
                        <div class="card-body">

                            <div class="alert alert-info border-0 bg-info bg-opacity-10 d-flex align-items-center">
                                <div>
                                    <strong>Maklumat:</strong> Gunakan form ini untuk mendaftarkan atau menyerahkan
                                    dokumen fizikal baru ke bagian Arsip Pusat agar tercatat di dalam Log Book.
                                </div>
                            </div>

                            <form onsubmit="submitForm(event, 'penyerahan')">
                                <h6 class="text-purple border-bottom pb-2 mb-3" style="color: #6f42c1;">Informasi
                                    Penyerahan</h6>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-4">
                                        <label class="form-label text-muted">Tarikh Penyerahan</label>
                                        <input type="text" class="form-control" value="25 Feb 2026" readonly disabled>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Nama Penyerah</label>
                                        <input type="text" id="inputNamaPenyerah" class="form-control"
                                            placeholder="Masukkan nama" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Divisi / Cabang</label>
                                        <select id="inputDivisiPenyerahan" class="form-select select-divisi-cabang"
                                            required>
                                            <option value="" selected>Pilih Divisi / Cabang...</option>
                                        </select>
                                    </div>
                                </div>

                                <h6 class="text-purple border-bottom pb-2 mb-3" style="color: #6f42c1;">Senarai Dokumen
                                    Baru</h6>
                                <div class="row g-2 mb-3 align-items-end">
                                    <div class="col-md-3">
                                        <label class="form-label small text-muted mb-1">No Dokumen</label>
                                        <input type="text" id="inputNoDokumenPeny" class="form-control form-control-sm"
                                            placeholder="Contoh: DOC-2026-001">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label small text-muted mb-1">Nama Dokumen</label>
                                        <input type="text" id="inputNamaDokumenPeny"
                                            class="form-control form-control-sm" placeholder="Nama atau Judul Dokumen">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small text-muted mb-1">Tahun</label>
                                        <input type="number" id="inputTahunDokumenPeny"
                                            class="form-control form-control-sm" placeholder="Contoh: 2026">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small text-muted mb-1">Jenis Dokumen</label>
                                        <select id="inputJenisDokumenPeny" class="form-select form-select-sm">
                                            <option value="">Pilih Jenis...</option>
                                            <option value="SOP">SOP</option>
                                            <option value="Blueprint">Blueprint</option>
                                            <option value="Laporan">Laporan</option>
                                            <option value="Kontrak">Kontrak</option>
                                            <option value="Sertifikat">Sertifikat</option>
                                            <option value="BAST">BAST</option>
                                            <option value="Lainnya">Lainnya</option>
                                        </select>
                                    </div>
                                    <div class="col-md-1 d-grid">
                                        <button type="button" class="btn btn-secondary btn-sm"
                                            onclick="tambahDokumenPenyerahan()">+ Tambah</button>
                                    </div>
                                </div>

                                <div class="table-responsive mb-4">
                                    <table class="table table-bordered table-hover" id="tabelDokumenPenyerahan">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="15%">No Dokumen</th>
                                                <th width="35%">Nama Dokumen</th>
                                                <th width="10%">Tahun</th>
                                                <th width="15%">Jenis</th>
                                                <th width="25%" class="text-center">File & Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr id="emptyRowPenyerahan">
                                                <td colspan="5" class="text-center text-muted">Belum ada dokumen yang
                                                    ditambah</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <h6 class="text-purple border-bottom pb-2 mb-3" style="color: #6f42c1;">Pengesahan
                                    Penyerahan</h6>
                                <div class="row g-4 mb-4">
                                    <div class="col-md-6 text-center">
                                        <label class="form-label fw-bold">Yang Menyerahkan (Staf)</label>
                                        <canvas id="ttdPenyerah" class="signature-pad"></canvas>
                                        <button type="button" class="btn btn-sm btn-outline-danger mt-2"
                                            onclick="padPenyerah.clear()">Hapus Tanda Tangan</button>
                                    </div>
                                    <div class="col-md-6 text-center">
                                        <label class="form-label fw-bold">Penerima (PIC Arsip)</label>
                                        <canvas id="ttdPicPenyerahan" class="signature-pad"></canvas>
                                        <button type="button" class="btn btn-sm btn-outline-danger mt-2"
                                            onclick="padPicPenyerahan.clear()">Hapus Tanda Tangan</button>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end gap-2 border-top pt-3">
                                    <button type="button" class="btn btn-light border"
                                        onclick="switchTab('dashboard')">Batal Kembali ke Dashboard</button>
                                    <button type="submit" class="btn"
                                        style="background-color: #6f42c1; color: white;">Simpan & Cetak PDF</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- VIEW 5: DATABASE DOKUMEN                   -->
        <!-- ========================================== -->
        <div id="view-database" class="view-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="mb-0 text-primary fw-bold">Database Master Dokumen</h4>
                    <small class="text-muted">Katalog pangkalan data seluruh dokumen fisik yang tersimpan di arsip
                        pusat</small>
                </div>
                <div>
                    <button class="btn" style="background-color: #6f42c1; color: white;"
                        onclick="switchTab('penyerahan')">+ Register Dokumen Baru</button>
                </div>
            </div>

            <div class="card shadow">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h6 class="mb-0 fw-bold">Katalog Dokumen</h6>
                    <div class="d-flex gap-2">
                        <input type="text" class="form-control form-control-sm" placeholder="Cari No Dokumen / Judul..."
                            style="width: 250px;">
                        <button class="btn btn-sm btn-outline-secondary">Cari</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0" id="tabelDatabaseUtama">
                            <thead class="table-light">
                                <tr>
                                    <th width="15%">No Dokumen</th>
                                    <th width="30%">Nama / Judul Dokumen</th>
                                    <th width="10%">Tahun</th>
                                    <th width="10%">Jenis</th>
                                    <th width="15%">Status Arsip</th>
                                    <th width="20%" class="text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data akan dimuat otomatis oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- VIEW 6: PENGATURAN (ADMIN ONLY)            -->
        <!-- ========================================== -->
        <div id="view-pengaturan" class="view-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="mb-0 text-warning fw-bold">‚öôÔ∏è Pengaturan Sistem Admin</h4>
                    <small class="text-muted">Kelola data master referensi seperti Divisi dan Cabang</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-danger" onclick="logoutAdmin()">üîí Kunci & Logout</button>
                </div>
            </div>

            <div class="row g-4">
                <!-- Form Tambah Divisi -->
                <div class="col-md-5">
                    <div class="card shadow-sm border-warning">
                        <div class="card-header bg-warning bg-opacity-25 fw-bold">Tambah Divisi / Cabang Baru</div>
                        <div class="card-body">
                            <form onsubmit="submitMasterDivisi(event)">
                                <div class="mb-3">
                                    <label class="form-label">Kategori</label>
                                    <select id="inputKategoriDivisi" class="form-select" required>
                                        <option value="Kantor Pusat">Kantor Pusat</option>
                                        <option value="Cabang">Cabang Operasional</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Nama Divisi / Cabang</label>
                                    <input type="text" id="inputNamaDivisi" class="form-control"
                                        placeholder="Contoh: Divisi Pemasaran" required>
                                </div>
                                <button type="submit" class="btn btn-warning w-100 fw-bold">Simpan ke Master
                                    Data</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- List Divisi Saat Ini -->
                <div class="col-md-7">
                    <div class="card shadow-sm">
                        <div class="card-header bg-light fw-bold">Daftar Divisi & Cabang Aktif</div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-hover mb-0" id="tabelMasterDivisi">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>Kategori</th>
                                            <th>Nama Divisi / Cabang</th>
                                            <th class="text-center">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Rendered by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal Detail Dashboard -->
    <div class="modal fade" id="modalDetail" tabindex="-1" aria-labelledby="modalDetailLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold" id="modalDetailLabel">Detail Transaksi: TRX-2602-004</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row mb-4 bg-light p-3 rounded">
                        <div class="col-sm-4">
                            <span class="text-muted small">Peminjam:</span><br>
                            <strong>Rina Marlina (Pusat)</strong>
                        </div>
                        <div class="col-sm-4">
                            <span class="text-muted small">Tgl Pinjam:</span><br>
                            <strong>24 Feb 2026</strong>
                        </div>
                        <div class="col-sm-4">
                            <span class="text-muted small">Progress Pengembalian:</span><br>
                            <span class="badge bg-info text-dark fs-6">3 dari 5 Dokumen Selesai</span>
                        </div>
                    </div>
                    <h6 class="fw-bold mb-3 text-secondary">Rincian Per Dokumen:</h6>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>No Dokumen</th>
                                    <th>Nama Dokumen</th>
                                    <th class="text-center">Status</th>
                                    <th>Tgl Dikembalikan</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="text-muted">DOC-1005</td>
                                    <td class="text-muted">Laporan Audit Internal Q4</td>
                                    <td class="text-center"><span class="badge bg-success">Sudah Kembali</span></td>
                                    <td class="text-muted">25 Feb 2026</td>
                                </tr>
                                <tr class="table-warning">
                                    <td class="fw-bold">DOC-1008</td>
                                    <td class="fw-bold">Draft Perjanjian Sewa Gedung</td>
                                    <td class="text-center"><span class="badge bg-warning text-dark shadow-sm">Masih
                                            Dipinjam</span></td>
                                    <td class="text-muted fst-italic">- Belum -</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-success fw-bold" data-bs-dismiss="modal"
                        onclick="goToPengembalian('TRX-2602-004')">Terima Sisa Dokumen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Login Admin -->
    <div class="modal fade" id="modalLoginAdmin" tabindex="-1" aria-labelledby="modalLoginAdminLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content shadow-lg border-0">
                <div class="modal-header bg-dark text-white">
                    <h6 class="modal-title fw-bold" id="modalLoginAdminLabel">üîí Otorisasi Admin</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body p-4 text-center">
                    <p class="small text-muted mb-3">Masukkan kata sandi administrator untuk mengakses halaman
                        pengaturan.</p>
                    <div class="mb-3 text-start">
                        <input type="password" id="inputPasswordAdmin" class="form-control text-center"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeypress="if(event.key === 'Enter') prosesLoginAdmin()">
                    </div>
                    <div id="pesanErrorLogin" class="text-danger small mb-3 d-none fw-bold">Kata sandi salah!</div>
                    <button type="button" class="btn btn-warning w-100 fw-bold" onclick="prosesLoginAdmin()">Login
                        Sekarang</button>
                    <div class="mt-3 small text-muted">Hint: admin123</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>

    <script>
        // =============================================
        // SIONE - Frontend dengan Backend API (Node.js + SQLite)
        // =============================================

        // Gunakan http://localhost:3000 jika dibuka sebagai file lokal, jika tidak gunakan relative path
        const API = window.location.protocol === 'file:' ? 'http://localhost:3000' : '';

        if (window.location.protocol === 'file:') {
            console.warn("SIONE: Aplikasi dibuka sebagai file lokal. Menghubungkan ke API di http://localhost:3000");
        }
        let padPeminjam, padPicPinjam, padPengembali, padPicKembali, padPenyerah, padPicPenyerahan;
        let isAdminLoggedIn = false;
        let cachedDokumen = [];
        let cachedDivisi = [];

        // --- Helper: Format tanggal ---
        function formatTgl(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
        }
        function todayFormatted() { return formatTgl(new Date().toISOString()); }
        function todayISO() { return new Date().toISOString().split('T')[0]; }

        // --- Navigasi Tab ---
        function switchTab(tabId) {
            if (tabId === 'pengaturan' && !isAdminLoggedIn) {
                const loginModal = new bootstrap.Modal(document.getElementById('modalLoginAdmin'));
                loginModal.show();
                document.getElementById('modalLoginAdmin').addEventListener('shown.bs.modal', () => {
                    document.getElementById('inputPasswordAdmin').focus();
                }, { once: true });
                return;
            }
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + tabId).classList.add('active');
            document.getElementById('nav-' + tabId).classList.add('active');

            if (tabId === 'dashboard') loadDashboard();
            if (tabId === 'database') loadDatabase();
            if (tabId === 'pengaturan') loadDivisi();
            if (tabId === 'peminjaman' || tabId === 'penyerahan') loadDivisi();

            setTimeout(() => initSignaturesForView(tabId), 100);
        }

        // --- Login / Logout Admin ---
        function prosesLoginAdmin() {
            const pwd = document.getElementById('inputPasswordAdmin').value;
            const errMsg = document.getElementById('pesanErrorLogin');
            if (pwd === 'admin123') {
                isAdminLoggedIn = true; errMsg.classList.add('d-none');
                document.getElementById('inputPasswordAdmin').value = '';
                bootstrap.Modal.getInstance(document.getElementById('modalLoginAdmin')).hide();
                switchTab('pengaturan');
            } else {
                errMsg.classList.remove('d-none');
                document.getElementById('inputPasswordAdmin').value = '';
                document.getElementById('inputPasswordAdmin').focus();
            }
        }
        function logoutAdmin() { isAdminLoggedIn = false; alert("Sesi Admin telah dikunci kembali."); switchTab('dashboard'); }

        // --- Reminder & Navigasi ---
        function kirimReminder(nama, trxId) {
            if (confirm(`Kirim email peringatan keterlambatan kepada ${nama} (ID: ${trxId})?`)) {
                setTimeout(() => alert(`‚úÖ Email reminder berhasil dikirim ke ${nama}.`), 800);
            }
        }
        function goToPengembalian(trxId) {
            document.getElementById('inputSearchTrx').value = trxId;
            switchTab('pengembalian');
        }

        // --- PDF Print ---
        function generateAndSavePDF(callback) {
            setTimeout(() => { window.print(); setTimeout(() => { if (callback) callback(); }, 500); }, 300);
        }

        // =============================================
        // LOAD DATA DARI API
        // =============================================

        async function loadDashboard() {
            try {
                const [dashRes, trxRes] = await Promise.all([
                    fetch(API + '/api/dashboard').then(r => r.json()),
                    fetch(API + '/api/transaksi').then(r => r.json())
                ]);
                // Summary cards
                document.querySelector('.border-warning .card-body h3').innerHTML = `${dashRes.sedangDipinjam} <small class="text-muted fs-6">Transaksi</small>`;
                document.querySelector('.border-danger .card-body h3').innerHTML = `${dashRes.terlambat} <small class="text-muted fs-6">Dokumen</small>`;
                document.querySelector('.border-blue .card-body h3').textContent = dashRes.totalBulanIni;

                // Tabel transaksi
                const tbody = document.querySelector('#view-dashboard table tbody');
                tbody.innerHTML = '';
                if (trxRes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-3">Belum ada transaksi</td></tr>';
                    return;
                }
                trxRes.forEach(t => {
                    let badge = '', aksi = '';
                    const kembali = t.jml_kembali || 0;
                    if (t.status_keseluruhan === 'Selesai') {
                        badge = '<span class="badge bg-success">Selesai</span>';
                        aksi = `<button class="btn btn-sm btn-light border" onclick="lihatArsip('${t.id_transaksi}')">Lihat Arsip</button>`;
                    } else if (t.status_keseluruhan === 'Terlambat') {
                        badge = '<span class="badge bg-danger">Terlambat!</span>';
                        aksi = `<button class="btn btn-sm btn-danger" onclick="kirimReminder('${t.nama_peminjam}','${t.id_transaksi}')">Kirim Reminder</button>`;
                    } else if (t.status_keseluruhan === 'Kembali Sebagian') {
                        badge = `<span class="badge bg-info text-dark">Kembali Sebagian (${kembali}/${t.jml_dokumen})</span>`;
                        aksi = `<button class="btn btn-sm btn-info text-white fw-bold" onclick="showDetailModal('${t.id_transaksi}')">Detail Dokumen</button>`;
                    } else {
                        badge = `<span class="badge bg-warning text-dark">Dipinjam (${kembali}/${t.jml_dokumen})</span>`;
                        aksi = `<button class="btn btn-sm btn-success" onclick="goToPengembalian('${t.id_transaksi}')">Terima Kembali</button>`;
                    }
                    tbody.innerHTML += `<tr>
                    <td><span class="text-primary fw-bold">${t.id_transaksi}</span></td>
                    <td>${formatTgl(t.tgl_pinjam)}</td>
                    <td>${t.nama_peminjam}</td>
                    <td>${t.nama_divisi}</td>
                    <td>${t.jml_dokumen} Dokumen</td>
                    <td>${formatTgl(t.batas_waktu)}</td>
                    <td>${badge}</td>
                    <td class="text-center">${aksi}</td>
                </tr>`;
                });
            } catch (e) { console.error('Dashboard error:', e); }
        }

        function lihatArsip(id) { alert('Menampilkan arsip transaksi: ' + id); }

        async function showDetailModal(trxId) {
            try {
                const data = await fetch(API + '/api/transaksi/' + trxId).then(r => r.json());
                document.getElementById('modalDetailLabel').textContent = 'Detail Transaksi: ' + trxId;
                const modalBody = document.querySelector('#modalDetail .modal-body');
                const kembali = data.details.filter(d => d.status_dokumen === 'Sudah Kembali').length;
                modalBody.innerHTML = `
                <div class="row mb-4 bg-light p-3 rounded">
                    <div class="col-sm-4"><span class="text-muted small">Peminjam:</span><br><strong>${data.nama_peminjam} (${data.nama_divisi})</strong></div>
                    <div class="col-sm-4"><span class="text-muted small">Tgl Pinjam:</span><br><strong>${formatTgl(data.tgl_pinjam)}</strong></div>
                    <div class="col-sm-4"><span class="text-muted small">Progress:</span><br><span class="badge bg-info text-dark fs-6">${kembali} dari ${data.details.length} Selesai</span></div>
                </div>
                <h6 class="fw-bold mb-3 text-secondary">Rincian Per Dokumen:</h6>
                <div class="table-responsive"><table class="table table-bordered table-sm align-middle">
                    <thead class="table-light"><tr><th>No Dokumen</th><th>Nama Dokumen</th><th class="text-center">Status</th><th>Tgl Dikembalikan</th></tr></thead>
                    <tbody>${data.details.map(d => `<tr class="${d.status_dokumen === 'Dipinjam' ? 'table-warning' : ''}">
                        <td class="${d.status_dokumen === 'Dipinjam' ? 'fw-bold' : 'text-muted'}">${d.no_dokumen}</td>
                        <td class="${d.status_dokumen === 'Dipinjam' ? 'fw-bold' : 'text-muted'}">${d.nama_dokumen}</td>
                        <td class="text-center"><span class="badge ${d.status_dokumen === 'Sudah Kembali' ? 'bg-success' : 'bg-warning text-dark'}">${d.status_dokumen === 'Sudah Kembali' ? 'Sudah Kembali' : 'Masih Dipinjam'}</span></td>
                        <td class="text-muted">${d.tgl_dikembalikan ? formatTgl(d.tgl_dikembalikan) : '- Belum -'}</td>
                    </tr>`).join('')}</tbody>
                </table></div>`;
                document.querySelector('#modalDetail .modal-footer').innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                <button type="button" class="btn btn-success fw-bold" data-bs-dismiss="modal" onclick="goToPengembalian('${trxId}')">Terima Sisa Dokumen</button>`;
                new bootstrap.Modal(document.getElementById('modalDetail')).show();
            } catch (e) { console.error('Detail error:', e); }
        }

        async function loadDatabase() {
            try {
                cachedDokumen = await fetch(API + '/api/dokumen').then(r => r.json());
                renderDatabase();
            } catch (e) { console.error('Load DB error:', e); }
        }

        function renderDatabase() {
            const tbody = document.querySelector('#tabelDatabaseUtama tbody');
            tbody.innerHTML = '';
            if (cachedDokumen.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Database masih kosong</td></tr>'; return; }
            cachedDokumen.forEach(doc => {
                const sb = doc.status === 'Tersedia' ? 'bg-success' : (doc.status === 'Dipinjam' ? 'bg-warning text-dark' : 'bg-danger');
                tbody.innerHTML += `<tr>
                <td class="fw-bold text-primary">${doc.no_dokumen}</td><td>${doc.nama_dokumen}</td><td>${doc.tahun}</td>
                <td><span class="badge bg-secondary">${doc.jenis_dokumen}</span></td>
                <td><span class="badge ${sb}">${doc.status}</span></td>
                <td class="text-center"><div class="d-flex justify-content-center gap-1">
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="alert('Preview: ${doc.nama_dokumen}')">üëÅÔ∏è Preview</button>
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="alert('Download: ${doc.nama_dokumen}.pdf')">‚¨áÔ∏è Download</button>
                </div></td></tr>`;
            });
        }

        async function updateDatalists() {
            try {
                cachedDokumen = await fetch(API + '/api/dokumen').then(r => r.json());
                const listTersedia = document.getElementById('listDokumenTersedia');
                const listDipinjam = document.getElementById('listDokumenDipinjam');
                listTersedia.innerHTML = ''; listDipinjam.innerHTML = '';
                cachedDokumen.forEach(doc => {
                    const opt = document.createElement('option');
                    opt.value = `${doc.no_dokumen} - ${doc.nama_dokumen}`;
                    if (doc.status === 'Tersedia') listTersedia.appendChild(opt);
                    if (doc.status === 'Dipinjam') listDipinjam.appendChild(opt.cloneNode(true));
                });
            } catch (e) { console.error('Datalist error:', e); }
        }

        async function loadDivisi() {
            try {
                cachedDivisi = await fetch(API + '/api/divisi').then(r => r.json());
                renderDropdownDivisi();
            } catch (e) { console.error('Divisi error:', e); }
        }

        function renderDropdownDivisi() {
            const selects = document.querySelectorAll('.select-divisi-cabang');
            selects.forEach(sel => {
                sel.innerHTML = '<option value="" selected>Pilih Divisi / Cabang...</option>';
                const groups = {};
                cachedDivisi.forEach(d => { if (!groups[d.kategori]) groups[d.kategori] = []; groups[d.kategori].push(d); });
                for (const [kat, list] of Object.entries(groups)) {
                    const og = document.createElement('optgroup'); og.label = kat;
                    list.forEach(d => { const o = document.createElement('option'); o.value = d.id_divisi; o.textContent = d.nama_divisi; og.appendChild(o); });
                    sel.appendChild(og);
                }
            });
            renderTabelPengaturan();
        }

        function renderTabelPengaturan() {
            const tbody = document.querySelector('#tabelMasterDivisi tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            cachedDivisi.forEach(d => {
                tbody.innerHTML += `<tr>
                <td><span class="badge ${d.kategori === 'Kantor Pusat' ? 'bg-primary' : 'bg-info text-dark'}">${d.kategori}</span></td>
                <td>${d.nama_divisi}</td>
                <td class="text-center"><button class="btn btn-sm btn-outline-danger" onclick="hapusMasterDivisi(${d.id_divisi}, '${d.nama_divisi}')">Hapus</button></td>
            </tr>`;
            });
        }

        async function submitMasterDivisi(event) {
            event.preventDefault();
            const kategori = document.getElementById('inputKategoriDivisi').value;
            const nama = document.getElementById('inputNamaDivisi').value.trim();
            if (!nama) return;
            try {
                await fetch(API + '/api/divisi', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ kategori, nama_divisi: nama }) });
                document.getElementById('inputNamaDivisi').value = '';
                alert("Data Divisi/Cabang berhasil ditambahkan!"); loadDivisi();
            } catch (e) { alert('Gagal menyimpan: ' + e.message); }
        }

        async function hapusMasterDivisi(id, nama) {
            if (!confirm(`Yakin ingin menghapus ${nama}?`)) return;
            try {
                await fetch(API + '/api/divisi/' + id, { method: 'DELETE' }); loadDivisi();
            } catch (e) { alert('Gagal menghapus: ' + e.message); }
        }

        // =============================================
        // SUBMIT FORMS
        // =============================================

        async function submitForm(event, type) {
            event.preventDefault();
            const btn = event.target.querySelector('button[type="submit"]');
            const origText = btn.innerText;
            btn.innerText = "‚è≥ Menyimpan..."; btn.disabled = true;

            try {
                if (type === 'peminjaman') {
                    const rows = document.querySelectorAll('#tabelDokumen tbody tr:not(#emptyRow)');
                    if (rows.length === 0) { btn.innerText = origText; btn.disabled = false; return alert("Pilih minimal satu dokumen!"); }
                    const dokumen = [];
                    rows.forEach(r => { const td = r.querySelector('td'); if (td) dokumen.push(td.innerText); });
                    const body = {
                        batas_waktu: document.getElementById('inputBatasWaktu').value,
                        id_divisi: parseInt(document.getElementById('inputDivisiPinjam').value),
                        nama_peminjam: document.getElementById('inputNamaPeminjam').value,
                        dokumen,
                        ttd_peminjam: padPeminjam && !padPeminjam.isEmpty() ? padPeminjam.toDataURL() : 'n/a',
                        ttd_pic: padPicPinjam && !padPicPinjam.isEmpty() ? padPicPinjam.toDataURL() : 'n/a'
                    };
                    const res = await fetch(API + '/api/peminjaman', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);
                    generateAndSavePDF(() => {
                        document.querySelector('#tabelDokumen tbody').innerHTML = '<tr id="emptyRow"><td colspan="3" class="text-center text-muted">Belum ada dokumen yang dipilih</td></tr>';
                        btn.innerText = origText; btn.disabled = false;
                        if (padPeminjam) padPeminjam.clear(); if (padPicPinjam) padPicPinjam.clear();
                        form.reset(); alert(`‚úÖ Peminjaman ${data.id_transaksi} berhasil disimpan!`);
                        updateDatalists(); switchTab('dashboard');
                    });

                } else if (type === 'pengembalian') {
                    const checks = document.querySelectorAll('.check-kembali:checked');
                    if (checks.length === 0) { btn.innerText = origText; btn.disabled = false; return alert("Centang minimal satu dokumen!"); }
                    const dokumen_kembali = []; checks.forEach(c => dokumen_kembali.push(c.value));
                    const trxId = checks[0].dataset.trx;
                    const body = {
                        id_transaksi: trxId, dokumen_kembali,
                        nama_pengembali: event.target.querySelector('input[type="text"]').value || 'n/a',
                        ttd_pengembali: padPengembali && !padPengembali.isEmpty() ? padPengembali.toDataURL() : 'n/a',
                        ttd_pic: padPicKembali && !padPicKembali.isEmpty() ? padPicKembali.toDataURL() : 'n/a'
                    };
                    const res = await fetch(API + '/api/pengembalian', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);
                    generateAndSavePDF(() => {
                        document.getElementById('inputSearchTrx').value = '';
                        document.getElementById('tabelDokumenKembali').innerHTML = '<tr><td colspan="4" class="text-center text-muted">Silakan cari dokumen di atas</td></tr>';
                        btn.innerText = origText; btn.disabled = false;
                        if (padPengembali) padPengembali.clear(); if (padPicKembali) padPicKembali.clear();
                        alert("‚úÖ Pengembalian dokumen berhasil!"); updateDatalists(); switchTab('dashboard');
                    });

                } else if (type === 'penyerahan') {
                    const rows = document.querySelectorAll('#tabelDokumenPenyerahan tbody tr:not(#emptyRowPenyerahan)');
                    if (rows.length === 0) { btn.innerText = origText; btn.disabled = false; return alert("Tambah minimal satu dokumen!"); }
                    const dokumen = [];
                    rows.forEach(r => { const c = r.querySelectorAll('td'); if (c.length >= 4) dokumen.push({ no: c[0].innerText, nama: c[1].innerText, tahun: c[2].innerText, jenis: c[3].innerText }); });
                    const form = event.target;
                    const body = {
                        nama_penyerah: document.getElementById('inputNamaPenyerah').value,
                        id_divisi: parseInt(document.getElementById('inputDivisiPenyerahan').value),
                        dokumen,
                        ttd_penyerah: padPenyerah && !padPenyerah.isEmpty() ? padPenyerah.toDataURL() : 'n/a',
                        ttd_pic: padPicPenyerahan && !padPicPenyerahan.isEmpty() ? padPicPenyerahan.toDataURL() : 'n/a'
                    };
                    const res = await fetch(API + '/api/penyerahan', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);
                    generateAndSavePDF(() => {
                        document.querySelector('#tabelDokumenPenyerahan tbody').innerHTML = '<tr id="emptyRowPenyerahan"><td colspan="5" class="text-center text-muted">Belum ada dokumen yang ditambah</td></tr>';
                        btn.innerText = origText; btn.disabled = false;
                        if (padPenyerah) padPenyerah.clear(); if (padPicPenyerahan) padPicPenyerahan.clear();
                        form.reset(); alert(`‚úÖ Dokumen baru berhasil diserahkan! ID: ${data.id_penyerahan}`);
                        updateDatalists(); switchTab('database');
                    });
                }
            } catch (e) { btn.innerText = origText; btn.disabled = false; alert('‚ùå Error: ' + e.message); }
        }

        // =============================================
        // FUNGSI DOKUMEN (Tambah, Cari)
        // =============================================

        function tambahDokumen() {
            const inputVal = document.getElementById('inputDokumen').value;
            if (!inputVal) return alert("Pilih atau ketik dokumen terlebih dahulu!");
            const noDoc = inputVal.split(' - ')[0].trim();
            const doc = cachedDokumen.find(d => d.no_dokumen === noDoc && d.status === 'Tersedia');
            if (!doc) return alert("Dokumen tidak ditemukan atau sedang dipinjam!");
            const tbody = document.querySelector('#tabelDokumen tbody');
            for (let td of tbody.querySelectorAll('tr td:first-child')) { if (td.textContent === doc.no_dokumen) return alert("Dokumen sudah di keranjang!"); }
            const emptyRow = document.getElementById('emptyRow'); if (emptyRow) emptyRow.remove();
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="fw-bold">${doc.no_dokumen}</td><td>${doc.nama_dokumen}</td><td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove()">Hapus</button></td>`;
            tbody.appendChild(tr);
            document.getElementById('inputDokumen').value = '';
        }

        async function cariDokumenPengembalian() {
            const val = document.getElementById('inputSearchTrx').value;
            if (!val) return alert("Ketik ID Transaksi atau No Dokumen!");
            const tbody = document.getElementById('tabelDokumenKembali');
            try {
                // Cari berdasarkan ID transaksi dulu
                let trxId = val.split(' - ')[0].trim();
                const res = await fetch(API + '/api/transaksi/' + trxId);
                if (res.ok) {
                    const data = await res.json();
                    const dipinjam = data.details.filter(d => d.status_dokumen === 'Dipinjam');
                    if (dipinjam.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Semua dokumen sudah dikembalikan.</td></tr>'; return; }
                    // Set info peminjam
                    const infoFields = document.querySelectorAll('#view-pengembalian .form-control[readonly]');
                    if (infoFields[0]) infoFields[0].value = formatTgl(data.tgl_pinjam);
                    if (infoFields[1]) infoFields[1].value = data.nama_peminjam;
                    if (infoFields[2]) infoFields[2].value = data.nama_divisi;
                    if (infoFields[3]) infoFields[3].value = todayFormatted();
                    // Isi nama pengembali
                    const namaPengembali = document.querySelector('#view-pengembalian input[type="text"]:not([readonly]):not([id])');
                    if (namaPengembali) namaPengembali.value = data.nama_peminjam;

                    tbody.innerHTML = dipinjam.map(d => `<tr>
                    <td class="text-center align-middle"><input class="form-check-input check-kembali" type="checkbox" value="${d.no_dokumen}" data-trx="${data.id_transaksi}" style="transform:scale(1.5);" checked></td>
                    <td class="fw-bold">${d.no_dokumen}</td><td>${d.nama_dokumen}</td>
                    <td><span class="badge bg-warning text-dark">Dipinjam</span></td></tr>`).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger py-3"><i class="fw-bold">Transaksi tidak ditemukan.</i></td></tr>';
                }
            } catch (e) { tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger py-3">${e.message}</td></tr>`; }
        }

        function tambahDokumenPenyerahan() {
            const noDoc = document.getElementById('inputNoDokumenPeny').value.trim();
            const namaDoc = document.getElementById('inputNamaDokumenPeny').value.trim();
            const tahunDoc = document.getElementById('inputTahunDokumenPeny').value.trim();
            const jenisDoc = document.getElementById('inputJenisDokumenPeny').value;
            if (!noDoc || !namaDoc || !tahunDoc || !jenisDoc) return alert("Silakan lengkapi semua isian!");
            const tbody = document.querySelector('#tabelDokumenPenyerahan tbody');
            const emptyRow = document.getElementById('emptyRowPenyerahan'); if (emptyRow) emptyRow.remove();
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="fw-bold">${noDoc}</td><td>${namaDoc}</td><td>${tahunDoc}</td><td><span class="badge bg-secondary">${jenisDoc}</span></td>
            <td class="text-center"><div class="d-flex justify-content-center gap-1">
                <label class="btn btn-sm btn-outline-primary mb-0" style="cursor:pointer;"><input type="file" class="d-none" accept=".pdf" onchange="if(this.files[0]){this.nextElementSibling.textContent='‚úì Terlampir';this.parentElement.classList.replace('btn-outline-primary','btn-success');}"><span>üìé Attach</span></label>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove()">Hapus</button>
            </div></td>`;
            tbody.appendChild(tr);
            document.getElementById('inputNoDokumenPeny').value = ''; document.getElementById('inputNamaDokumenPeny').value = '';
            document.getElementById('inputTahunDokumenPeny').value = ''; document.getElementById('inputJenisDokumenPeny').value = '';
        }

        // --- Tanda Tangan ---
        function resizeCanvas(c) { const r = Math.max(window.devicePixelRatio || 1, 1); c.width = c.offsetWidth * r; c.height = c.offsetHeight * r; c.getContext("2d").scale(r, r); }
        function initSignaturesForView(view) {
            if (view === 'peminjaman') { const a = document.getElementById('ttdPeminjam'), b = document.getElementById('ttdPicPinjam'); if (!padPeminjam) { resizeCanvas(a); resizeCanvas(b); padPeminjam = new SignaturePad(a); padPicPinjam = new SignaturePad(b); } }
            else if (view === 'pengembalian') { const a = document.getElementById('ttdPengembali'), b = document.getElementById('ttdPicKembali'); if (!padPengembali) { resizeCanvas(a); resizeCanvas(b); padPengembali = new SignaturePad(a); padPicKembali = new SignaturePad(b); } }
            else if (view === 'penyerahan') { const a = document.getElementById('ttdPenyerah'), b = document.getElementById('ttdPicPenyerahan'); if (!padPenyerah) { resizeCanvas(a); resizeCanvas(b); padPenyerah = new SignaturePad(a); padPicPenyerahan = new SignaturePad(b); } }
        }

        // --- Set tanggal otomatis ---
        document.querySelectorAll('input[readonly][value*="Feb 2026"]').forEach(el => { el.value = todayFormatted(); });

        // --- INIT ---
        updateDatalists();
        loadDivisi();
        switchTab('dashboard');
    </script>
</body>

</html>