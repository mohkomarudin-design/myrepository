<!DOCTYPE html>
<html lang="id" class="scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>SI-ONE | Layanan Publik & Admin System</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#1e3a8a", // Navy Blue Corporate
                        secondary: "#3b82f6", // Bright Blue Action
                        accent: "#f59e0b", // Amber/Gold
                        "background-light": "#F8FAFC",
                        "background-dark": "#0F172A",
                        "status-new": "#F59E0B",
                        "status-deal": "#10B981",
                        "status-request": "#3B82F6",
                        "status-rejected": "#EF4444",
                    },
                    fontFamily: {
                        sans: ["Inter", "sans-serif"],
                        display: ["Plus Jakarta Sans", "sans-serif"],
                    },
                },
            },
        };
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .hero-pattern {
            background-color: #ffffff;
            background-image: radial-gradient(#1e3a8a 0.5px, transparent 0.5px), radial-gradient(#1e3a8a 0.5px, #ffffff 0.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            opacity: 0.03;
        }

        .chart-donut {
            background: conic-gradient(#22D3EE 0% 76%, #FACC15 76% 96%, #F87171 96% 100%);
            border-radius: 50%;
        }

        .chart-gauge {
            background: conic-gradient(#0891b2 0% 44%, #e2e8f0 44% 100%);
            border-radius: 50%;
        }

        /* Transition utility */
        .view-transition {
            transition: opacity 0.3s ease-in-out;
        }

        .hidden-view {
            display: none !important;
            opacity: 0;
        }

        /* Active Sidebar Item Style */
        .sidebar-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-right: 3px solid #3b82f6;
        }

        .sidebar-item-public.active {
            background-color: #1e3a8a;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(30, 58, 138, 0.1), 0 2px 4px -1px rgba(30, 58, 138, 0.06);
        }

        .sidebar-item-public:hover:not(.active) {
            background-color: #f1f5f9;
        }

        .custom-service-input {
            display: none;
        }

        #custom-toggle:checked~.custom-service-input {
            display: block;
        }

        /* Tab Nav Active State */
        .tab-nav-item.active {
            color: #1e3a8a;
            border-bottom: 2px solid #1e3a8a;
            font-weight: 600;
        }

        .tab-nav-item {
            color: #64748b;
            border-bottom: 2px solid transparent;
            font-weight: 500;
        }

        .tab-nav-item:hover {
            color: #1e3a8a;
        }

        /* Custom Scrollbar for Modals */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
</head>

<body class="bg-background-light text-slate-800 font-sans antialiased overflow-x-hidden">

    <!-- ========================================= -->
    <!-- VIEW 1: LANDING PAGE (Tersembunyi Default) -->
    <!-- ========================================= -->
    <div id="view-landing" class="hidden-view view-transition h-screen">
        <!-- Navbar -->
        <nav
            class="fixed w-full z-50 bg-white/80 backdrop-blur-md border-b border-slate-200 transition-all duration-300">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <div class="flex items-center gap-3">
                        <img src="logo publik.png" alt="SI-ONE" class="h-12 object-contain" />
                        <div class="leading-none">
                            <span class="block text-xl font-bold text-primary font-display tracking-tight">SI-ONE</span>
                            <span
                                class="block text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">Integrated
                                Assurance</span>
                        </div>
                    </div>
                    <div class="hidden md:flex items-center gap-3">
                        <button onclick="switchToPublicView()"
                            class="px-5 py-2.5 text-sm font-bold text-slate-600 hover:text-primary border border-transparent hover:border-slate-200 rounded-xl transition-all">
                            Masuk Layanan Publik
                        </button>
                        <button onclick="toggleLoginModal()"
                            class="px-5 py-2.5 text-sm font-bold text-white bg-primary hover:bg-blue-900 rounded-xl shadow-lg shadow-primary/20 transition-all flex items-center gap-2">
                            <span class="material-symbols-outlined text-[18px]">lock</span>
                            Admin Login
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Hero Section -->
        <section
            class="relative pt-32 pb-20 lg:pt-48 lg:pb-32 overflow-hidden h-screen flex items-center justify-center">
            <div class="absolute inset-0 hero-pattern z-0"></div>
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10 text-center">
                <div
                    class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-50 border border-blue-100 text-primary text-xs font-bold uppercase tracking-wider mb-6">
                    <span class="w-2 h-2 rounded-full bg-secondary animate-pulse"></span>
                    Sistem Terintegrasi V.2.0
                </div>
                <h1 class="text-4xl lg:text-6xl font-display font-bold text-slate-900 leading-tight mb-6">
                    Solusi Cerdas <br>
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary">Monitoring &
                        Pricing</span>
                </h1>
                <p class="text-lg text-slate-600 leading-relaxed max-w-2xl mx-auto mb-10">
                    Platform terpadu untuk pengelolaan penawaran, perhitungan pricing otomatis, dan monitoring progres
                    proyek secara real-time.
                </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="switchToPublicView()"
                        class="px-8 py-4 bg-secondary hover:bg-blue-600 text-white rounded-2xl font-bold text-lg shadow-xl shadow-blue-500/20 transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">public</span>
                        Masuk Layanan Publik
                    </button>
                    <button onclick="toggleLoginModal()"
                        class="px-8 py-4 bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 rounded-2xl font-bold text-lg transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">admin_panel_settings</span>
                        Login Admin
                    </button>
                </div>
            </div>
        </section>
    </div>

    <!-- ========================================= -->
    <!-- VIEW 2: PUBLIC INTERFACE (DEFAULT VIEW) -->
    <!-- ========================================= -->
    <div id="view-public" class="min-h-screen flex bg-[#F8FAFC]">
        <!-- Public Sidebar -->
        <aside class="w-64 bg-white border-r border-slate-200 flex-shrink-0 flex flex-col fixed h-full z-20 shadow-sm">
            <div class="p-6 border-b border-slate-100 cursor-pointer hover:bg-slate-50 transition-colors"
                onclick="switchToLandingView()">
                <div class="flex items-center gap-3">
                    <img src="logo publik.png" alt="SI-ONE Public" class="h-10 object-contain" />
                    <div>
                        <h1 class="font-bold text-xl leading-none text-primary tracking-tight">SI-ONE</h1>
                        <p class="text-[9px] text-slate-400 uppercase tracking-[0.2em] mt-1 leading-none font-bold">
                            Public Service</p>
                    </div>
                </div>
            </div>

            <nav class="flex-1 px-4 space-y-2 mt-6">
                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest px-3 mb-2">Menu Layanan</div>

                <button onclick="switchPublicSection('monitoring')" id="pub-nav-monitoring"
                    class="sidebar-item-public active w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all group text-left">
                    <span class="material-symbols-outlined text-[20px]">assignment</span>
                    <div>
                        <span class="font-semibold text-sm block">Monitoring</span>
                        <span class="text-[10px] opacity-70 block font-normal">Cek status pengajuan</span>
                    </div>
                </button>

                <button onclick="switchPublicSection('create')" id="pub-nav-create"
                    class="sidebar-item-public w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all group text-left text-slate-500">
                    <span class="material-symbols-outlined text-[20px]">add_circle</span>
                    <div>
                        <span class="font-semibold text-sm block">Buat Penawaran</span>
                        <span class="text-[10px] opacity-70 block font-normal">Ajukan proyek baru</span>
                    </div>
                </button>
            </nav>

            <div class="p-4 mt-auto">
                <div class="bg-blue-50 rounded-xl p-4 border border-blue-100 mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="material-symbols-outlined text-blue-600 text-lg">support_agent</span>
                        <span class="text-xs font-bold text-blue-800">Butuh Bantuan?</span>
                    </div>
                    <p class="text-[10px] text-blue-600 leading-relaxed mb-3">Tim kami siap membantu Anda 24/7 untuk
                        kendala teknis.</p>
                    <button
                        class="w-full py-2 bg-white text-blue-700 text-[10px] font-bold rounded-lg border border-blue-200 hover:bg-blue-50 transition-colors">Chat
                        Support</button>
                </div>
                <button onclick="toggleLoginModal()"
                    class="flex items-center gap-3 w-full px-4 py-3 text-slate-500 hover:bg-slate-50 hover:text-primary rounded-xl transition-all group text-left border border-transparent hover:border-slate-200">
                    <span class="material-symbols-outlined text-[20px]">lock</span>
                    <span class="text-sm font-semibold">Login Admin</span>
                </button>
            </div>
        </aside>

        <!-- Public Content -->
        <main class="flex-1 flex flex-col min-w-0 ml-64">
            <!-- Header Public -->
            <header
                class="h-20 bg-white/80 backdrop-blur-md border-b border-slate-200 flex items-center justify-between px-8 sticky top-0 z-10">
                <div class="flex items-center gap-4">
                    <h2 class="text-xl font-bold text-slate-800" id="public-page-title">Monitoring Penawaran</h2>
                </div>
                <div class="flex items-center gap-6">
                    <div class="hidden md:flex items-center gap-2">
                        <button
                            class="w-9 h-9 flex items-center justify-center text-slate-400 hover:bg-slate-50 hover:text-primary rounded-full transition-colors"
                            title="Informasi"><span class="material-symbols-outlined text-[20px]">info</span></button>
                        <button
                            class="w-9 h-9 flex items-center justify-center text-slate-400 hover:bg-slate-50 hover:text-primary rounded-full transition-colors"
                            title="Bantuan"><span
                                class="material-symbols-outlined text-[20px]">help_outline</span></button>
                    </div>
                    <div class="h-8 w-[1px] bg-slate-200"></div>
                    <div class="flex items-center gap-4">
                        <div class="text-right hidden sm:block">
                            <p class="text-sm font-bold text-slate-700 leading-tight uppercase tracking-tight">Tamu
                                Publik</p>
                            <p class="text-[10px] text-slate-400 font-medium tracking-wide uppercase">Akses Terbatas</p>
                        </div>
                        <div
                            class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center border border-slate-200 text-slate-500">
                            <span class="material-symbols-outlined text-[24px]">public</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Public Content Container -->
            <div class="flex-1 overflow-y-auto p-8">

                <!-- SECTION: MONITORING (Table) -->
                <div id="public-content-monitoring" class="space-y-6">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4">
                            <div class="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600">
                                <span class="material-symbols-outlined">assignment</span>
                            </div>
                            <div>
                                <p class="text-slate-500 text-xs font-bold uppercase tracking-wider">Total Pengajuan</p>
                                <h3 class="text-2xl font-bold text-slate-800">12</h3>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4">
                            <div
                                class="w-12 h-12 bg-amber-50 rounded-xl flex items-center justify-center text-amber-600">
                                <span class="material-symbols-outlined">pending</span>
                            </div>
                            <div>
                                <p class="text-slate-500 text-xs font-bold uppercase tracking-wider">Sedang Proses</p>
                                <h3 class="text-2xl font-bold text-slate-800">5</h3>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4">
                            <div
                                class="w-12 h-12 bg-emerald-50 rounded-xl flex items-center justify-center text-emerald-600">
                                <span class="material-symbols-outlined">check_circle</span>
                            </div>
                            <div>
                                <p class="text-slate-500 text-xs font-bold uppercase tracking-wider">Selesai/Deal</p>
                                <h3 class="text-2xl font-bold text-slate-800">3</h3>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div
                            class="p-6 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-center gap-4">
                            <h3 class="text-lg font-bold text-slate-800">Daftar Permintaan Terbaru</h3>
                            <div class="relative w-full sm:w-80">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-[18px]">search</span>
                                <input
                                    class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border-none rounded-xl text-sm focus:ring-2 focus:ring-primary/20 placeholder:text-slate-400"
                                    placeholder="Cari No. Tiket atau Perusahaan..." type="text" />
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50/50 border-b border-slate-100">
                                    <tr>
                                        <th
                                            class="px-6 py-4 text-[11px] font-bold text-slate-400 uppercase tracking-widest">
                                            Nama Perusahaan</th>
                                        <th
                                            class="px-6 py-4 text-[11px] font-bold text-slate-400 uppercase tracking-widest">
                                            No Permintaan</th>
                                        <th
                                            class="px-6 py-4 text-[11px] font-bold text-slate-400 uppercase tracking-widest">
                                            Layanan</th>
                                        <th
                                            class="px-6 py-4 text-[11px] font-bold text-slate-400 uppercase tracking-widest text-center">
                                            Status</th>
                                        <th
                                            class="px-6 py-4 text-[11px] font-bold text-slate-400 uppercase tracking-widest text-center">
                                            Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50">
                                    <tr class="hover:bg-slate-50/50 transition-colors group">
                                        <td class="px-6 py-5 font-semibold text-slate-700">PT Berkat Manunggul</td>
                                        <td class="px-6 py-5 text-sm text-slate-500 font-mono">#REQ-2024-001</td>
                                        <td class="px-6 py-5 text-sm text-slate-600">Inspeksi Teknik Migas</td>
                                        <td class="px-6 py-5 text-center">
                                            <span
                                                class="px-3 py-1.5 rounded-full text-[10px] font-bold text-orange-600 bg-orange-50 border border-orange-100 uppercase tracking-wider inline-block min-w-[100px]">Review
                                                Admin</span>
                                        </td>
                                        <td class="px-6 py-5 text-center">
                                            <div class="flex items-center justify-center gap-2">
                                                <button
                                                    class="text-primary hover:text-blue-700 font-bold text-xs">Detail</button>
                                                <button onclick="openPublicChatModal('#REQ-2024-001')"
                                                    class="p-1.5 rounded-lg text-primary bg-blue-50 hover:bg-primary hover:text-white transition-all flex items-center"
                                                    title="Chat dengan Admin">
                                                    <span
                                                        class="material-symbols-outlined text-[18px]">chat_bubble</span>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-slate-50/50 transition-colors group">
                                        <td class="px-6 py-5 font-semibold text-slate-700">PT Sinergi Elektro</td>
                                        <td class="px-6 py-5 text-sm text-slate-500 font-mono">#REQ-2024-002</td>
                                        <td class="px-6 py-5 text-sm text-slate-600">Sertifikasi SLO</td>
                                        <td class="px-6 py-5 text-center">
                                            <span
                                                class="px-3 py-1.5 rounded-full text-[10px] font-bold text-emerald-600 bg-emerald-50 border border-emerald-100 uppercase tracking-wider inline-block min-w-[100px]">Deal
                                                / PO</span>
                                        </td>
                                        <td class="px-6 py-5 text-center">
                                            <div class="flex items-center justify-center gap-2">
                                                <button
                                                    class="text-primary hover:text-blue-700 font-bold text-xs">Invoice</button>
                                                <button onclick="openPublicChatModal('#REQ-2024-002')"
                                                    class="p-1.5 rounded-lg text-primary bg-blue-50 hover:bg-primary hover:text-white transition-all flex items-center"
                                                    title="Chat dengan Admin">
                                                    <span
                                                        class="material-symbols-outlined text-[18px]">chat_bubble</span>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-slate-50/50 transition-colors group">
                                        <td class="px-6 py-5 font-semibold text-slate-700">PT Cakrawala Teknik</td>
                                        <td class="px-6 py-5 text-sm text-slate-500 font-mono">#REQ-2024-003</td>
                                        <td class="px-6 py-5 text-sm text-slate-600">NDT Radiography</td>
                                        <td class="px-6 py-5 text-center">
                                            <span
                                                class="px-3 py-1.5 rounded-full text-[10px] font-bold text-amber-600 bg-amber-50 border border-amber-100 uppercase tracking-wider inline-block min-w-[100px]">Negotiation</span>
                                        </td>
                                        <td class="px-6 py-5 text-center">
                                            <div class="flex items-center justify-center gap-2">
                                                <button
                                                    class="text-primary hover:text-blue-700 font-bold text-xs">Respons</button>
                                                <button onclick="openPublicChatModal('#REQ-2024-003')"
                                                    class="p-1.5 rounded-lg text-primary bg-blue-50 hover:bg-primary hover:text-white transition-all flex items-center"
                                                    title="Chat dengan Admin">
                                                    <span
                                                        class="material-symbols-outlined text-[18px]">chat_bubble</span>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SECTION: CREATE OFFER (Form) -->
                <div id="public-content-create" class="space-y-6 hidden">
                    <div class="max-w-[1000px] mx-auto space-y-4">
                        <section class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="p-1.5 bg-blue-50 rounded-lg">
                                    <span class="material-symbols-outlined text-primary !text-xl">corporate_fare</span>
                                </div>
                                <h2 class="text-base font-bold text-slate-800">Data Perusahaan</h2>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3">
                                <div class="space-y-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Nama
                                        Perusahaan</label>
                                    <input
                                        class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all outline-none text-sm"
                                        placeholder="Masukkan nama perusahaan" type="text" />
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Nama
                                        Pemohon</label>
                                    <input
                                        class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all outline-none text-sm"
                                        placeholder="Nama lengkap Anda" type="text" />
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Email
                                        Korespondensi</label>
                                    <input
                                        class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all outline-none text-sm"
                                        placeholder="contoh@email.com" type="email" />
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Nomor
                                        Handphone / WA</label>
                                    <input
                                        class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all outline-none text-sm"
                                        placeholder="08xx xxxx xxxx" type="tel" />
                                </div>
                            </div>
                        </section>

                        <section class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="p-1.5 bg-blue-50 rounded-lg">
                                        <span class="material-symbols-outlined text-primary !text-xl">list_alt</span>
                                    </div>
                                    <h2 class="text-base font-bold text-slate-800">Detail Item Layanan</h2>
                                </div>
                                <!-- Button removed as requested -->
                            </div>
                            <div class="space-y-3">
                                <div
                                    class="group border border-slate-200 rounded-xl p-4 hover:border-primary/20 transition-all bg-white">
                                    <div class="flex justify-between items-start mb-3">
                                        <div>
                                            <span
                                                class="text-[9px] font-black text-primary uppercase tracking-widest mb-0.5 block">Item
                                                01</span>
                                            <h3 class="text-sm font-bold text-slate-800">Konfigurasi Layanan</h3>
                                        </div>
                                        <button
                                            class="p-1 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all">
                                            <span class="material-symbols-outlined !text-lg">delete</span>
                                        </button>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                        <div class="space-y-1.5">
                                            <label
                                                class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Jenis
                                                Pekerjaan</label>
                                            <div class="space-y-2">
                                                <div class="relative">
                                                    <select id="offerServiceSelect"
                                                        onchange="onOfferServiceSelected(this.value)"
                                                        class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all outline-none text-sm appearance-none cursor-pointer">
                                                        <option disabled="" selected="" value="">Pilih jenis...</option>
                                                        <option value="lainnya">Lainnya</option>
                                                    </select>
                                                    <div
                                                        class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-slate-400">
                                                        <span
                                                            class="material-symbols-outlined !text-lg">expand_more</span>
                                                    </div>
                                                </div>
                                                <!-- Customize Layanan box shown when 'Lainnya' is selected -->
                                                <div id="customServiceDesc"
                                                    class="hidden mt-3 bg-blue-50/50 border border-blue-100 rounded-xl p-3 space-y-1.5">
                                                    <label
                                                        class="text-[9px] font-bold text-primary uppercase tracking-widest">Deskripsi
                                                        Layanan Kustom</label>
                                                    <textarea
                                                        class="w-full px-3 py-2 bg-white border border-blue-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all outline-none text-sm placeholder:text-slate-400"
                                                        rows="2"
                                                        placeholder="Jelaskan secara detail jenis pekerjaan yang Anda butuhkan..."></textarea>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Sistem Pembayaran Field -->
                                        <div class="space-y-1.5">
                                            <label
                                                class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Sistem
                                                Pembayaran</label>
                                            <div class="relative">
                                                <select id="offerPaymentTerms"
                                                    class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all outline-none text-sm appearance-none cursor-pointer">
                                                    <option disabled="" selected="" value="">Pilih termin...</option>
                                                    <option value="1">Full Payment (1 Termin)</option>
                                                    <option value="2">2 Termin Pembayaran</option>
                                                    <option value="3">3 Termin Pembayaran</option>
                                                    <option value="4">4 Termin Pembayaran</option>
                                                    <option value="5">5 Termin Pembayaran</option>
                                                </select>
                                                <div
                                                    class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-slate-400">
                                                    <span class="material-symbols-outlined !text-lg">expand_more</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Dynamic Pricing Parameter Fields -->
                                    <div id="dynamicPricingFields"
                                        class="col-span-1 md:col-span-2 lg:col-span-4 hidden">
                                        <div
                                            class="border border-emerald-200 rounded-xl p-4 bg-emerald-50/30 space-y-3">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span
                                                    class="material-symbols-outlined text-emerald-600 text-sm">tune</span>
                                                <label
                                                    class="text-[10px] font-bold text-emerald-600 uppercase tracking-widest">Parameter
                                                    Harga</label>
                                            </div>
                                            <div id="dynamicParamInputs" class="space-y-3"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Added "Tambah ke Daftar" Button Section -->
                            <div class="flex justify-end pt-2 border-t border-slate-100 mt-4">
                                <button type="button" onclick="addOfferItem()"
                                    class="bg-primary/10 text-primary hover:bg-primary hover:text-white px-5 py-2.5 rounded-xl font-bold text-xs transition-all flex items-center gap-2 border border-primary/20">
                                    <span class="material-symbols-outlined !text-[16px]">add_circle</span>
                                    Tambah ke Daftar
                                </button>
                            </div>
                        </section>

                        <!-- NEW SECTION: Daftar Item Penawaran (Table) -->
                        <section class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                            <div class="p-5 border-b border-slate-100 flex items-center gap-3">
                                <div class="p-1.5 bg-blue-50 rounded-lg">
                                    <span class="material-symbols-outlined text-primary !text-xl">inventory</span>
                                </div>
                                <h2 class="text-base font-bold text-slate-800">Daftar Item Penawaran</h2>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead
                                        class="bg-slate-50/50 border-b border-slate-100 text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                                        <tr>
                                            <th class="px-6 py-4">Jenis Pekerjaan</th>
                                            <th class="px-6 py-4">Rincian Permintaan</th>
                                            <th class="px-6 py-4 text-right">Harga</th>
                                            <th class="px-6 py-4 text-right">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="offerItemsBody" class="divide-y divide-slate-50 text-sm">
                                        <!-- Items will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <!-- Empty State -->
                            <div id="offerItemsEmptyState" class="p-8 text-center bg-slate-50/30">
                                <div
                                    class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-400">
                                    <span class="material-symbols-outlined text-2xl">inbox</span>
                                </div>
                                <p class="text-xs text-slate-500 font-medium">Belum ada item yang ditambahkan.</p>
                            </div>
                        </section>

                        <section class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="p-1.5 bg-blue-50 rounded-lg">
                                    <span class="material-symbols-outlined text-primary !text-xl">edit_note</span>
                                </div>
                                <h2 class="text-base font-bold text-slate-800">Catatan Tambahan</h2>
                            </div>
                            <div class="space-y-3">
                                <textarea
                                    class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all placeholder:text-slate-400 min-h-[80px] outline-none text-sm"
                                    placeholder="Tuliskan permintaan khusus atau spesifikasi tambahan di sini..."></textarea>
                            </div>
                        </section>

                        <div class="flex justify-end pt-4">
                            <button onclick="submitRequest()"
                                class="bg-primary text-white font-bold py-3 px-8 rounded-xl shadow-xl shadow-primary/20 text-sm flex items-center gap-2 hover:bg-blue-800 transition-all transform hover:-translate-y-0.5">
                                KIRIM PERMINTAAN
                                <span class="material-symbols-outlined !text-[18px]">send</span>
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- ========================================= -->
    <!-- VIEW 3: ADMIN DASHBOARD (SINGLE PAGE APP) -->
    <!-- ========================================= -->
    <div id="view-admin" class="hidden-view min-h-screen flex bg-slate-50">

        <!-- Sidebar Admin Lengkap -->
        <aside class="w-64 bg-primary text-white flex-shrink-0 hidden md:flex flex-col">
            <div class="h-16 flex items-center gap-3 px-6 border-b border-white/10">
                <img src="logo admin.png" alt="SI-ONE Admin" class="h-8 object-contain" />
                <span class="font-bold font-display tracking-tight">SI-ONE Admin</span>
            </div>

            <div class="p-4 space-y-6 overflow-y-auto flex-1">
                <div>
                    <div class="text-xs font-bold text-blue-300 uppercase tracking-wider mb-2 px-2">Main Menu</div>
                    <nav class="space-y-1">
                        <!-- Dashboard -->
                        <button onclick="switchAdminSection('dashboard')" id="nav-dashboard"
                            class="sidebar-item active w-full flex items-center gap-3 px-3 py-2 text-blue-100 hover:bg-white/5 hover:text-white rounded-lg transition-colors text-left">
                            <span class="material-symbols-outlined text-[20px]">dashboard</span>
                            <span class="text-sm font-medium">Dashboard</span>
                        </button>

                        <!-- Monitoring & Pricing -->
                        <button onclick="switchAdminSection('pricing')" id="nav-pricing"
                            class="sidebar-item w-full flex items-center gap-3 px-3 py-2 text-blue-100 hover:bg-white/5 hover:text-white rounded-lg transition-colors text-left">
                            <span class="material-symbols-outlined text-[20px]">query_stats</span>
                            <span class="text-sm font-medium">Monitoring & Pricing</span>
                        </button>

                        <!-- Permintaan Masuk -->
                        <button onclick="switchAdminSection('requests')" id="nav-requests"
                            class="sidebar-item w-full flex items-center gap-3 px-3 py-2 text-blue-100 hover:bg-white/5 hover:text-white rounded-lg transition-colors text-left">
                            <span class="material-symbols-outlined text-[20px]">request_quote</span>
                            <span class="text-sm font-medium">Permintaan Masuk</span>
                            <span id="sidebarNewRequestBadge"
                                class="ml-auto bg-rose-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-md hidden"></span>
                        </button>

                        <!-- Monitoring Progres -->
                        <button onclick="switchAdminSection('monitoring')" id="nav-monitoring"
                            class="sidebar-item w-full flex items-center gap-3 px-3 py-2 text-blue-100 hover:bg-white/5 hover:text-white rounded-lg transition-colors text-left">
                            <span class="material-symbols-outlined text-[20px]">donut_large</span>
                            <span class="text-sm font-medium">Monitoring Progres</span>
                        </button>
                    </nav>
                </div>

                <div id="nav-configuration-wrapper">
                    <div class="text-xs font-bold text-blue-300 uppercase tracking-wider mb-2 px-2">Configuration</div>
                    <nav class="space-y-1">
                        <!-- REMOVED: Parameter Harga Button -->

                        <!-- CONFIGURATION LINK -->
                        <button onclick="switchAdminSection('configuration')" id="nav-configuration"
                            class="sidebar-item w-full flex items-center gap-3 px-3 py-2 text-blue-100 hover:bg-white/5 hover:text-white rounded-lg transition-colors text-left">
                            <span class="material-symbols-outlined text-[20px]">domain</span>
                            <span class="text-sm font-medium">Cabang & Divisi</span>
                        </button>
                    </nav>
                </div>
            </div>

            <div class="p-4 border-t border-white/10">
                <button onclick="showLogoutModal()"
                    class="flex items-center gap-3 px-3 py-2 w-full text-blue-100 hover:text-white hover:bg-white/5 rounded-lg transition-colors group">
                    <span
                        class="material-symbols-outlined text-[20px] group-hover:text-rose-300 transition-colors">logout</span>
                    <span class="text-sm font-medium group-hover:text-rose-100 transition-colors">Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
            <!-- Header Admin -->
            <header
                class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 sm:px-6 lg:px-8">
                <div class="flex items-center gap-4">
                    <button class="md:hidden text-slate-500 hover:text-primary">
                        <span class="material-symbols-outlined">menu</span>
                    </button>
                    <h2 class="text-lg font-bold text-slate-800" id="page-title">Executive Dashboard</h2>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="openNotificationModal()"
                        class="relative p-2 text-slate-400 hover:text-primary transition-colors">
                        <span class="material-symbols-outlined">notifications</span>
                        <span id="notif-badge-indicator"
                            class="absolute top-1.5 right-1.5 w-4 h-4 text-[10px] font-bold text-white flex items-center justify-center bg-rose-500 rounded-full border border-white hidden"></span>
                    </button>
                    <!-- Message / Chat Icon -->
                    <button onclick="openAdminChatModal()"
                        class="relative p-2 text-slate-400 hover:text-primary transition-colors">
                        <span class="material-symbols-outlined">mail</span>
                    </button>
                    <div class="flex items-center gap-3 pl-4 border-l border-slate-200 cursor-pointer"
                        onclick="openAdminConfigModal()">
                        <div class="text-right hidden sm:block">
                            <div class="text-sm font-bold text-slate-700">Administrator</div>
                            <div class="text-xs text-slate-500">Divisi Komersial</div>
                        </div>
                        <div
                            class="w-9 h-9 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 hover:bg-slate-200 transition-colors">
                            <span class="material-symbols-outlined">person</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Dynamic Content Sections -->
            <div class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">

                <!-- SECTION 1: DASHBOARD (Stats & Charts & Controls) -->
                <div id="admin-content-dashboard" class="space-y-6">

                    <!-- Dashboard Navigation Bar / Control Header -->
                    <div class="flex flex-col md:flex-row justify-between items-end md:items-center gap-4 mb-2">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Rangkuman Statistik</h2>
                            <p class="text-sm text-slate-500 mt-1">Update terakhir: Kamis, 12 Feb 2026 â€¢ 09:00 WIB</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <!-- Period Filter -->
                            <div class="relative">
                                <select
                                    class="appearance-none bg-white border border-slate-200 pl-4 pr-10 py-2.5 rounded-xl text-sm font-bold text-slate-700 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none cursor-pointer shadow-sm hover:bg-slate-50 transition-colors">
                                    <option>Tahun 2026</option>
                                    <option>Tahun 2025</option>
                                </select>
                                <div
                                    class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-slate-500">
                                    <span class="material-symbols-outlined text-[18px]">calendar_today</span>
                                </div>
                            </div>

                            <!-- Region Filter -->
                            <div class="relative hidden sm:block">
                                <select
                                    class="appearance-none bg-white border border-slate-200 pl-4 pr-10 py-2.5 rounded-xl text-sm font-bold text-slate-700 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none cursor-pointer shadow-sm hover:bg-slate-50 transition-colors">
                                    <option>Semua Cabang</option>
                                    <option>Jakarta</option>
                                    <option>Surabaya</option>
                                    <option>Balikpapan</option>
                                </select>
                                <div
                                    class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-slate-500">
                                    <span class="material-symbols-outlined text-[18px]">location_on</span>
                                </div>
                            </div>

                            <!-- Export Button -->
                            <button
                                class="bg-white border border-slate-200 text-slate-700 hover:text-primary hover:border-primary px-4 py-2.5 rounded-xl text-sm font-bold shadow-sm transition-all flex items-center gap-2">
                                <span class="material-symbols-outlined text-[20px]">download</span>
                                <span class="hidden sm:inline">Export</span>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-12 gap-6">
                        <!-- Chart Bar Target -->
                        <div
                            class="col-span-12 lg:col-span-7 bg-white p-6 border border-slate-200 shadow-sm rounded-2xl">
                            <div class="mb-6">
                                <h3 class="font-bold text-sm uppercase tracking-widest text-slate-400">Target
                                    Disentralisasi</h3>
                                <p class="text-xs text-slate-500 mt-1">Performance by regional branches</p>
                            </div>
                            <div class="space-y-4" id="branchPerformanceBars">
                                <p class="text-xs text-slate-400 italic">Memuat data cabang...</p>
                            </div>
                        </div>
                        <!-- Gauge Chart -->
                        <div
                            class="col-span-12 lg:col-span-5 bg-white p-6 border border-slate-200 shadow-sm rounded-2xl flex flex-col items-center justify-center">
                            <div class="text-center mb-4">
                                <h3 class="font-bold text-sm uppercase tracking-widest text-slate-400">Target RKAP 2026
                                </h3>
                            </div>
                            <div class="relative w-40 h-40 flex items-center justify-center">
                                <div class="chart-gauge w-full h-full"></div>
                                <div
                                    class="absolute inset-4 bg-white rounded-full flex items-center justify-center shadow-md">
                                    <span class="text-2xl font-black text-slate-800">44%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Priority Updates Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left: Activity Feed / Priority Items -->
                        <div class="lg:col-span-2 bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-slate-800">Aktivitas Prioritas Tinggi</h3>
                                <button class="text-xs text-primary font-bold hover:underline">Lihat Semua</button>
                            </div>
                            <div class="space-y-4">
                                <!-- Item 1 -->
                                <div
                                    class="flex items-start gap-4 bg-slate-50/50 p-4 rounded-xl border border-slate-100 hover:border-slate-200 transition-all cursor-pointer">
                                    <div class="mt-1">
                                        <div
                                            class="w-8 h-8 rounded-lg bg-cyan-50 border border-cyan-100 flex items-center justify-center text-cyan-600">
                                            <span
                                                class="material-symbols-outlined text-sm font-bold">check_circle</span>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-sm text-slate-800">Inspeksi SLO Fasilitas Migas</h4>
                                        <p class="text-xs text-slate-500 mt-1">12 Februari 2026 â€¢ Area Blok Mahakam
                                        </p>
                                        <div class="mt-2 flex items-center gap-2">
                                            <span
                                                class="text-[10px] font-bold bg-white border border-slate-200 text-slate-500 px-2 py-0.5 rounded">#001060226</span>
                                            <span
                                                class="text-[10px] font-bold text-rose-600 bg-rose-50 px-2 py-0.5 rounded border border-rose-100">PRIORITY:
                                                HIGH</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Item 2 -->
                                <div
                                    class="flex items-start gap-4 bg-slate-50/50 p-4 rounded-xl border border-slate-100 hover:border-slate-200 transition-all cursor-pointer opacity-80 hover:opacity-100">
                                    <div class="mt-1">
                                        <div
                                            class="w-8 h-8 rounded-lg bg-indigo-50 border border-indigo-100 flex items-center justify-center text-indigo-600">
                                            <span class="material-symbols-outlined text-sm font-bold">article</span>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-sm text-slate-800">Verifikasi Dokumen Teknik</h4>
                                        <p class="text-xs text-slate-500 mt-1">11 Februari 2026 â€¢ PT Pertamina Hulu
                                        </p>
                                        <div class="mt-2 flex items-center gap-2">
                                            <span
                                                class="text-[10px] font-bold bg-white border border-slate-200 text-slate-500 px-2 py-0.5 rounded">#001060225</span>
                                            <span
                                                class="text-[10px] font-bold text-amber-600 bg-amber-50 px-2 py-0.5 rounded border border-amber-100">REVIEW</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Mini Stat / Quick Action -->
                        <div
                            class="bg-gradient-to-br from-primary to-blue-900 rounded-2xl p-6 text-white flex flex-col justify-between shadow-lg relative overflow-hidden">
                            <div class="relative z-10">
                                <div
                                    class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center mb-4 backdrop-blur-sm border border-white/20">
                                    <span class="material-symbols-outlined">trending_up</span>
                                </div>
                                <h3 class="text-lg font-bold mb-1">Total Revenue</h3>
                                <p class="text-blue-200 text-xs mb-4">Year to Date (YTD)</p>
                                <div class="text-3xl font-black tracking-tight">Rp 12.8 M</div>
                                <div class="mt-2 flex items-center gap-1 text-xs font-medium text-emerald-300">
                                    <span class="material-symbols-outlined text-sm">arrow_upward</span>
                                    +12.5% vs Last Year
                                </div>
                            </div>
                            <!-- Decor -->
                            <div class="absolute -bottom-8 -right-8 w-32 h-32 bg-white/5 rounded-full blur-2xl"></div>
                            <div class="absolute top-8 right-8 w-16 h-16 bg-blue-500/20 rounded-full blur-xl"></div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 2: MONITORING & PRICING -->
                <div id="admin-content-pricing" class="space-y-6 hidden">

                    <!-- Monitoring & Pricing Navigation Bar -->
                    <div class="flex flex-col md:flex-row justify-between items-end md:items-center gap-4 mb-2">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Manajemen Pricing</h2>
                            <p class="text-sm text-slate-500 mt-1">Kelola layanan, parameter harga, dan margin</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="openEditServiceModal()"
                                class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-emerald-500/20 transition-all flex items-center gap-2">
                                <span class="material-symbols-outlined text-[20px]">add</span>
                                <span>Tambah</span>
                            </button>
                        </div>
                    </div>

                    <!-- Sub-Menu / Action Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <button
                            class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all text-left group">
                            <div
                                class="w-10 h-10 rounded-lg bg-blue-50 text-primary flex items-center justify-center mb-3 group-hover:bg-primary group-hover:text-white transition-colors">
                                <span class="material-symbols-outlined">tune</span>
                            </div>
                            <h4 class="font-bold text-slate-700 text-sm">Parameter Harga</h4>
                            <p class="text-xs text-slate-500 mt-1">Atur manpower & alat</p>
                        </button>
                        <button
                            class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all text-left group">
                            <div
                                class="w-10 h-10 rounded-lg bg-blue-50 text-primary flex items-center justify-center mb-3 group-hover:bg-primary group-hover:text-white transition-colors">
                                <span class="material-symbols-outlined">calculate</span>
                            </div>
                            <h4 class="font-bold text-slate-700 text-sm">Simulasi Harga</h4>
                            <p class="text-xs text-slate-500 mt-1">Hitung margin & HPP</p>
                        </button>
                        <button
                            class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all text-left group">
                            <div
                                class="w-10 h-10 rounded-lg bg-blue-50 text-primary flex items-center justify-center mb-3 group-hover:bg-primary group-hover:text-white transition-colors">
                                <span class="material-symbols-outlined">verified_user</span>
                            </div>
                            <h4 class="font-bold text-slate-700 text-sm">Approval Margin</h4>
                            <p class="text-xs text-slate-500 mt-1">Persetujuan direksi</p>
                        </button>
                        <button
                            class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all text-left group">
                            <div
                                class="w-10 h-10 rounded-lg bg-blue-50 text-primary flex items-center justify-center mb-3 group-hover:bg-primary group-hover:text-white transition-colors">
                                <span class="material-symbols-outlined">history</span>
                            </div>
                            <h4 class="font-bold text-slate-700 text-sm">History Penawaran</h4>
                            <p class="text-xs text-slate-500 mt-1">Arsip data penawaran</p>
                        </button>
                    </div>

                    <!-- Grid (Charts & Tables) -->
                    <div class="grid grid-cols-12 gap-6">
                        <div
                            class="col-span-12 lg:col-span-5 bg-white p-6 border border-slate-200 shadow-sm rounded-2xl flex flex-col items-center">
                            <div class="w-full mb-6">
                                <h3 class="font-bold text-sm uppercase tracking-widest text-slate-400">Resource
                                    Allocation</h3>
                            </div>
                            <div class="relative w-48 h-48 flex items-center justify-center">
                                <div class="chart-donut w-full h-full"></div>
                                <div
                                    class="absolute inset-8 bg-white rounded-full flex flex-col items-center justify-center shadow-inner">
                                    <span class="text-2xl font-black text-slate-800">76%</span>
                                    <span class="text-[9px] font-bold text-slate-400 uppercase">Available</span>
                                </div>
                            </div>
                        </div>
                        <div
                            class="col-span-12 lg:col-span-7 bg-white p-6 border border-slate-200 shadow-sm rounded-2xl">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-slate-800">Daftar Layanan & Proyek</h3>
                            </div>
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-slate-400 uppercase font-bold border-b border-slate-100">
                                    <tr>
                                        <th class="py-3 font-bold">Nama Layanan</th>
                                        <th class="py-3 font-bold">Estimasi Harga</th>
                                        <th class="py-3 font-bold">Status</th>
                                        <th class="py-3 font-bold text-right">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    <tr class="group hover:bg-slate-50 transition-colors">
                                        <td class="py-3 text-slate-600 font-medium">Inspeksi SLO Fasilitas Migas</td>
                                        <td class="py-3 font-bold text-slate-800">Rp 150.000.000</td>
                                        <td class="py-3"><span
                                                class="bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-[10px] font-bold tracking-wide">ON
                                                PROGRESS</span></td>
                                        <td class="py-3 text-right">
                                            <div class="flex items-center justify-end gap-1">
                                                <button
                                                    onclick="if(confirm('Hapus layanan ini?')) this.closest('tr').remove()"
                                                    class="p-1.5 text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors"
                                                    title="Hapus">
                                                    <span class="material-symbols-outlined text-[18px]">delete</span>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr class="group hover:bg-slate-50 transition-colors">
                                        <td class="py-3 text-slate-600 font-medium">Audit SMK3 & ISO 45001</td>
                                        <td class="py-3 font-bold text-slate-800">Rp 45.000.000</td>
                                        <td class="py-3"><span
                                                class="bg-cyan-100 text-cyan-700 px-2 py-0.5 rounded text-[10px] font-bold tracking-wide">AVAILABLE</span>
                                        </td>
                                        <td class="py-3 text-right">
                                            <div class="flex items-center justify-end gap-1">
                                                <button
                                                    onclick="if(confirm('Hapus layanan ini?')) this.closest('tr').remove()"
                                                    class="p-1.5 text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors"
                                                    title="Hapus">
                                                    <span class="material-symbols-outlined text-[18px]">delete</span>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SECTION 3: PERMINTAAN MASUK -->
                <div id="admin-content-requests" class="space-y-6 hidden">
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <!-- Navigation Tabs -->
                        <div class="px-6 pt-4 border-b border-slate-100 flex gap-6 text-sm">
                            <button onclick="filterRequests('All')"
                                class="tab-nav-item active pb-3 transition-colors">All</button>
                            <button onclick="filterRequests('New Request')"
                                class="tab-nav-item pb-3 transition-colors flex items-center gap-1">
                                New Request <span id="badgeNewRequestCount"
                                    class="bg-status-new/10 text-status-new px-1.5 rounded-md text-[10px] font-bold">0</span>
                            </button>
                            <button onclick="filterRequests('Reviewing')"
                                class="tab-nav-item pb-3 transition-colors">Reviewing</button>
                            <button onclick="filterRequests('Negotiation')"
                                class="tab-nav-item pb-3 transition-colors">Negotiation</button>
                            <button onclick="filterRequests('Deal')"
                                class="tab-nav-item pb-3 transition-colors">Deal</button>
                            <button onclick="filterRequests('Rejected')"
                                class="tab-nav-item pb-3 transition-colors">Rejected</button>
                        </div>

                        <!-- Filter Bar -->
                        <div class="p-4 bg-slate-50/50 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div class="flex items-center gap-3 w-full md:w-auto">
                                <label class="text-xs font-bold text-slate-500 uppercase">Urutkan:</label>
                                <select id="adminRequestsSort"
                                    onchange="adminRequestsSortBy=this.value; adminRequestsCurrentPage=1; applyAdminRequestsFilters();"
                                    class="bg-white border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-primary focus:border-primary p-2 outline-none">
                                    <option>Terbaru</option>
                                    <option>Terlama</option>
                                    <option>Nilai Tertinggi</option>
                                    <option>Nilai Terendah</option>
                                </select>
                            </div>
                            <div class="relative w-full md:w-96">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">search</span>
                                <input type="text" id="adminRequestsSearch"
                                    placeholder="Cari nama perusahaan atau ID..."
                                    oninput="adminRequestsFilterSearch=this.value; adminRequestsCurrentPage=1; applyAdminRequestsFilters();"
                                    class="w-full pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary/20 outline-none text-sm shadow-sm">
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-50 text-slate-500 uppercase font-bold text-xs">
                                    <tr>
                                        <th class="px-6 py-3">Nama Klien</th>
                                        <th class="px-6 py-3">Layanan</th>
                                        <th class="px-6 py-3 text-center">Status</th>
                                        <th class="px-6 py-3 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="adminRequestsBody" class="divide-y divide-slate-100">
                                    <tr>
                                        <td colspan="4" class="px-6 py-8 text-center text-slate-400 italic">Memuat data
                                            permintaan...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div id="adminRequestsPaginationContainer"
                            class="px-6 py-4 border-t border-slate-100 flex items-center justify-between">
                            <p class="text-xs text-slate-500">Showing <span class="font-bold text-slate-800">0</span>
                                of <span class="font-bold text-slate-800">0</span> results</p>
                        </div>
                    </div>
                </div>

                <!-- SECTION 5: MONITORING PROGRES (Updated Card View) -->
                <div id="admin-content-monitoring" class="space-y-6 hidden">
                    <!-- Search & Filter Header -->
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                        <div class="relative w-full md:w-96">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">search</span>
                            <input type="text" placeholder="Cari proyek atau klien..."
                                class="w-full pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary/20 outline-none text-sm shadow-sm">
                        </div>
                    </div>

                    <!-- Projects Grid (Dynamic) -->
                    <div id="monitoringProgressGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        <div class="col-span-full text-center py-12 text-slate-400">
                            <span class="material-symbols-outlined text-4xl mb-2">hourglass_empty</span>
                            <p class="text-sm">Memuat proyek...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 6: CONFIGURATION (Cabang & Divisi) -->
            <div id="admin-content-configuration" class="space-y-6 hidden">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-2">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Konfigurasi Cabang & Divisi</h2>
                        <p class="text-sm text-slate-500 mt-1">Manajemen entitas bisnis untuk target desentralisasi
                        </p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="handleAddConfig()"
                            class="bg-primary hover:bg-blue-900 text-white px-5 py-2.5 rounded-xl flex items-center gap-2 font-medium transition-all shadow-md"
                            id="btnTambahConfig">
                            <span class="material-symbols-outlined text-[20px]">add_circle</span>
                            <span id="textTambahConfig">Tambah Cabang</span>
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="border-b border-slate-200 flex bg-slate-50/50 px-6 overflow-x-auto">
                        <button onclick="switchConfigTab('cabang')" id="tab-cabang"
                            class="px-6 py-4 text-sm font-semibold border-b-[3px] border-primary text-primary flex items-center gap-2 transition-colors whitespace-nowrap">
                            <span class="material-symbols-outlined text-[20px]">domain</span>
                            Data Kantor Cabang
                        </button>
                        <button onclick="switchConfigTab('divisi')" id="tab-divisi"
                            class="px-6 py-4 text-sm font-medium text-slate-500 hover:text-primary border-b-[3px] border-transparent flex items-center gap-2 transition-colors whitespace-nowrap">
                            <span class="material-symbols-outlined text-[20px]">account_tree</span>
                            Data Divisi Bisnis
                        </button>
                        <button onclick="switchConfigTab('akses')" id="tab-akses"
                            class="px-6 py-4 text-sm font-medium text-slate-500 hover:text-primary border-b-[3px] border-transparent flex items-center gap-2 transition-colors whitespace-nowrap">
                            <span class="material-symbols-outlined text-[20px]">admin_panel_settings</span>
                            Manajemen Hak Akses
                        </button>
                    </div>

                    <div class="p-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div class="relative w-full max-w-sm">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400">
                                <span class="material-symbols-outlined text-[20px]">search</span>
                            </span>
                            <input
                                class="w-full pl-10 pr-4 py-2.5 border border-slate-300 bg-white rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all text-sm"
                                placeholder="Cari data..." type="text" />
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="p-2 border border-slate-300 rounded-lg hover:bg-slate-50 text-slate-600"
                                title="Filter">
                                <span class="material-symbols-outlined text-[20px]">filter_list</span>
                            </button>
                            <button class="p-2 border border-slate-300 rounded-lg hover:bg-slate-50 text-slate-600"
                                title="Export">
                                <span class="material-symbols-outlined text-[20px]">download</span>
                            </button>
                        </div>
                    </div>

                    <!-- Tab Content: Cabang -->
                    <div id="content-config-cabang" class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr
                                    class="bg-slate-50 text-slate-500 uppercase text-[11px] font-bold tracking-widest border-y border-slate-200">
                                    <th class="px-6 py-4">Nama Cabang</th>
                                    <th class="px-6 py-4">Kode</th>
                                    <th class="px-6 py-4">Lokasi</th>
                                    <th class="px-6 py-4 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="branchesTableBody" class="divide-y divide-slate-200 text-sm">
                                <tr>
                                    <td colspan="4" class="px-6 py-8 text-center text-slate-400 italic">Memuat data
                                        cabang...</td>
                                </tr>
                            </tbody>
                        </table>
                        <div
                            class="px-6 py-4 border-t border-slate-200 bg-slate-50/30 flex justify-between items-center text-xs text-slate-500">
                            <span id="branchCountInfo" class="font-medium">Memuat...</span>
                        </div>
                    </div>

                    <!-- Tab Content: Divisi -->
                    <div id="content-config-divisi" class="overflow-x-auto hidden">
                        <!-- ... existing table content ... -->
                        </tbody>
                        </table>
                        <div
                            class="px-6 py-4 border-t border-slate-200 bg-slate-50/30 flex justify-between items-center text-xs text-slate-500">
                            <span class="font-medium">Menampilkan 1-3 dari 8 divisi</span>
                            <div class="flex gap-2">
                                <button
                                    class="px-3 py-1.5 border border-slate-300 rounded-lg hover:bg-slate-100 transition-colors disabled:opacity-50"
                                    disabled="">Previous</button>
                                <button
                                    class="px-3 py-1.5 border border-slate-300 rounded-lg hover:bg-slate-100 transition-colors">Next</button>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Hak Akses (NEW) -->
                    <div id="content-config-akses" class="overflow-x-auto hidden">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr
                                    class="bg-slate-50 text-slate-500 uppercase text-[11px] font-bold tracking-widest border-y border-slate-200">
                                    <th class="px-6 py-4">Nama Pengguna</th>
                                    <th class="px-6 py-4">Role / Hak Akses</th>
                                    <th class="px-6 py-4">Email & WA</th>
                                    <th class="px-6 py-4 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody" class="divide-y divide-slate-200 text-sm">
                                <tr>
                                    <td colspan="4" class="px-6 py-8 text-center text-slate-400 italic">Memuat data
                                        pengguna...</td>
                                </tr>
                            </tbody>
                        </table>
                        <div
                            class="px-6 py-4 border-t border-slate-200 bg-slate-50/30 flex justify-between items-center text-xs text-slate-500">
                            <span id="userCountInfo" class="font-medium">Memuat...</span>
                        </div>
                    </div>
                </div>
            </div>

    </div>
    </main>
    </div>

    <!-- ================= MODALS ================= -->

    <!-- Admin Configuration Modal (NEW) -->
    <div id="adminConfigModal"
        class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm hidden">
        <div
            class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] transform transition-all">
            <!-- Header -->
            <div
                class="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-white sticky top-0 z-10">
                <div class="flex items-center gap-3">
                    <button onclick="closeAdminConfigModal()"
                        class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-slate-100 transition-colors">
                        <span class="material-symbols-outlined text-slate-600">arrow_back</span>
                    </button>
                    <h3 class="text-lg font-bold text-slate-800">Admin Configuration</h3>
                </div>
                <button onclick="closeAdminConfigModal()"
                    class="text-primary font-bold text-sm hover:underline">Cancel</button>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-6 custom-scrollbar bg-white">

                <!-- Profile Image -->
                <div class="flex flex-col items-center gap-4 mb-6">
                    <div class="relative group">
                        <div
                            class="w-24 h-24 rounded-full bg-slate-100 ring-4 ring-primary/10 overflow-hidden shadow-sm flex items-center justify-center">
                            <img id="adminConfigProfileImg" class="w-full h-full object-cover hidden">
                            <span id="adminConfigProfileIcon"
                                class="material-symbols-outlined text-5xl text-slate-400">person</span>
                        </div>
                        <input type="file" id="adminConfigProfileUpload" class="hidden" accept="image/*"
                            onchange="previewAdminProfileImage(event)">
                        <button onclick="document.getElementById('adminConfigProfileUpload').click()"
                            class="absolute bottom-0 right-0 bg-primary text-white p-2 rounded-full border-4 border-white shadow-md hover:bg-blue-700 transition-colors">
                            <span class="material-symbols-outlined text-[16px]">edit</span>
                        </button>
                    </div>
                    <div class="text-center">
                        <h4 id="adminConfigDisplayTitle" class="text-xl font-bold text-slate-800">Administrator</h4>
                        <p id="adminConfigDisplayRole" class="text-sm text-slate-500">System Administrator</p>
                    </div>
                </div>

                <!-- Personal Info -->
                <div class="space-y-4 mb-6 px-1">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="material-symbols-outlined text-primary text-xl">person</span>
                        <h4 class="text-sm font-bold text-slate-800">Personal Information</h4>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1.5">Full Name</label>
                            <input id="adminConfigFullName" type="text"
                                class="w-full px-4 py-3 bg-white border border-slate-200 rounded-xl text-sm font-medium text-slate-800 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1.5">Email Address</label>
                            <input id="adminConfigEmail" type="email"
                                class="w-full px-4 py-3 bg-white border border-slate-200 rounded-xl text-sm font-medium text-slate-800 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400">
                        </div>
                    </div>
                </div>

                <div class="h-px bg-slate-100 my-4 mx-1"></div>

                <!-- Security -->
                <div class="space-y-4 px-1">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="material-symbols-outlined text-primary text-xl">lock</span>
                        <h4 class="text-sm font-bold text-slate-800">Security</h4>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1.5">Current Password</label>
                            <div class="relative">
                                <input id="adminConfigCurrPass" type="password" placeholder="Current password"
                                    class="w-full px-4 py-3 bg-white border border-slate-200 rounded-xl text-sm font-medium text-slate-800 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all pr-10">
                                <button onclick="togglePasswordVisibility('adminConfigCurrPass', this)"
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-primary">
                                    <span class="material-symbols-outlined text-[20px]">visibility</span>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1.5">New Password</label>
                            <div class="relative">
                                <input id="adminConfigNewPass" type="password" placeholder="Create new password"
                                    class="w-full px-4 py-3 bg-white border border-slate-200 rounded-xl text-sm font-medium text-slate-800 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all pr-10">
                                <button onclick="togglePasswordVisibility('adminConfigNewPass', this)"
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-primary">
                                    <span class="material-symbols-outlined text-[20px]">visibility_off</span>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1.5">Confirm New Password</label>
                            <div class="relative">
                                <input id="adminConfigConfPass" type="password" placeholder="Repeat new password"
                                    class="w-full px-4 py-3 bg-white border border-slate-200 rounded-xl text-sm font-medium text-slate-800 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all pr-10">
                                <button onclick="togglePasswordVisibility('adminConfigConfPass', this)"
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-primary">
                                    <span class="material-symbols-outlined text-[20px]">visibility_off</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Logout Option -->
                <div class="mt-8 pt-4 border-t border-slate-100">
                    <button onclick="closeAdminConfigModal(); showLogoutModal();"
                        class="w-full py-3 border border-rose-200 text-rose-600 hover:bg-rose-50 rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">logout</span>
                        Log Out Session
                    </button>
                </div>

            </div>

            <!-- Footer -->
            <div class="p-4 border-t border-slate-100 bg-white sticky bottom-0 z-10">
                <button onclick="saveAdminConfig()"
                    class="w-full bg-primary hover:bg-blue-800 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-primary/20 transition-all text-sm active:scale-[0.98]">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal"
        class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm hidden">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100">
            <div class="bg-primary p-6 text-center">
                <span class="material-symbols-outlined text-white text-4xl mb-2">lock</span>
                <h2 class="text-xl font-bold text-white">Admin Login</h2>
            </div>
            <div class="p-6 space-y-4">
                <form onsubmit="handleDemoLogin(event)">
                    <input type="text" value="admin" class="w-full px-4 py-2 border rounded-lg mb-4">
                    <input type="password" value="password" class="w-full px-4 py-2 border rounded-lg mb-4">
                    <button type="submit"
                        class="w-full py-3 bg-primary text-white font-bold rounded-lg hover:bg-blue-900">Masuk
                        Dashboard</button>
                </form>
                <button onclick="toggleLoginModal()" class="w-full text-slate-400 text-sm">Batal</button>
            </div>
        </div>
    </div>

    <!-- Logout Modal -->
    <div id="logoutModal"
        class="fixed inset-0 z-[150] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm hidden">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-2xl p-6 text-center">
            <h3 class="text-lg font-bold text-slate-900 mb-2">Konfirmasi Logout</h3>
            <div class="flex gap-3 mt-6">
                <button onclick="closeLogoutModal()"
                    class="flex-1 py-2.5 border rounded-xl text-slate-600 font-bold">Batal</button>
                <button onclick="confirmLogout()" class="flex-1 py-2.5 bg-rose-600 text-white font-bold rounded-xl">Ya,
                    Keluar</button>
            </div>
        </div>
    </div>

    <!-- Service Customize Modal - REMOVED -->
    </div>
    </div>

    <!-- Progress Update Modal -->
    <div id="progressUpdateModal"
        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm hidden">
        <div class="w-full max-w-xl bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
            <!-- Modal Header -->
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div>
                    <h3 class="font-bold text-slate-800 text-lg">Update Progress Proyek</h3>
                    <p class="text-xs text-slate-500" id="progressModalProjectName">PT Sinergi Elektro</p>
                </div>
                <button onclick="closeProgressModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Modal Content (Teknis Pembayaran) -->
            <div class="p-6 space-y-6 max-h-[70vh] overflow-y-auto bg-slate-50/30">
                <!-- Opsi Sistem Pembayaran -->
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 block">Sistem
                        Pembayaran / Termin</label>
                    <div class="relative">
                        <select id="paymentTerms" onchange="generateTerms()"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none text-sm font-semibold appearance-none cursor-pointer">
                            <option value="1">Full Payment (1 Termin)</option>
                            <option value="2">2 Termin Pembayaran</option>
                            <option value="3" selected>3 Termin Pembayaran</option>
                            <option value="4">4 Termin Pembayaran</option>
                            <option value="5">5 Termin Pembayaran</option>
                        </select>
                        <div class="absolute inset-y-0 right-4 flex items-center pointer-events-none text-slate-400">
                            <span class="material-symbols-outlined">expand_more</span>
                        </div>
                    </div>
                </div>

                <!-- Total Progress Visual -->
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Progress Proyek
                            Keseluruhan</label>
                        <span class="text-2xl font-black text-primary transition-colors"
                            id="modalProgressText">0%</span>
                    </div>
                    <div class="h-3 w-full bg-slate-100 rounded-full overflow-hidden shadow-inner">
                        <div id="modalProgressFill"
                            class="h-full bg-primary rounded-full transition-all duration-500 ease-out"
                            style="width: 0%"></div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2 text-right">Dihitung otomatis berdasarkan termin yang
                        diselesaikan</p>
                </div>

                <!-- Dynamic Terms Container -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 block">Status
                        Penyelesaian Termin</label>
                    <div id="termsContainer" class="space-y-3">
                        <!-- Term rows will be generated here by JavaScript -->
                    </div>
                </div>

            </div>

            <!-- Modal Footer -->
            <div class="px-6 py-4 border-t border-slate-100 flex justify-end gap-3 bg-white">
                <button onclick="closeProgressModal()"
                    class="px-4 py-2.5 text-slate-500 font-bold text-sm hover:bg-slate-50 hover:text-slate-700 rounded-xl transition-all border border-transparent hover:border-slate-200">Batal</button>
                <button onclick="alert('Progress Berhasil Diupdate!'); closeProgressModal();"
                    class="px-6 py-2.5 bg-primary text-white font-bold text-sm rounded-xl shadow-lg shadow-primary/20 hover:bg-blue-900 transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined text-[18px]">save</span> Simpan Perubahan
                </button>
            </div>
        </div>
    </div>

    <!-- Share Wallet Modal -->
    <div id="walletModal"
        class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm hidden">
        <div
            class="w-full max-w-2xl bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200 transform transition-all">
            <!-- Modal Header -->
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div>
                    <h3 class="font-bold text-slate-800 text-lg">Distribusi Share Wallet</h3>
                    <p class="text-xs text-slate-500" id="walletModalProjectName">PT Mega Konstruksi</p>
                </div>
                <button onclick="closeWalletModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="p-6 space-y-6 max-h-[70vh] overflow-y-auto bg-slate-50/30">

                <!-- Summary Card -->
                <div
                    class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-xl p-5 border border-emerald-100 flex justify-between items-center shadow-sm">
                    <div>
                        <p class="text-[10px] font-bold text-emerald-600 uppercase tracking-wider mb-2">Total Margin
                            Bersih (Net)</p>
                        <div class="flex items-center">
                            <span class="text-2xl font-black text-emerald-700 mr-2">Rp</span>
                            <input type="number" id="walletTotalMarginInput" value="45000000"
                                class="w-full sm:w-56 px-3 py-1.5 bg-white border border-emerald-200 rounded-xl text-xl font-black text-emerald-700 focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 outline-none transition-all shadow-sm"
                                oninput="calcWallet()">
                        </div>
                    </div>
                    <div
                        class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 shadow-inner">
                        <span class="material-symbols-outlined text-2xl">account_balance_wallet</span>
                    </div>
                </div>

                <!-- Distribution List -->
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex justify-between items-center mb-4 pb-3 border-b border-slate-100">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider block">Alokasi Pembagian
                            Keuntungan</label>
                        <span class="text-xs font-bold text-slate-500 px-2.5 py-1 bg-slate-100 rounded-lg"
                            id="walletRemaining">Sisa: 0%</span>
                    </div>

                    <div class="space-y-4" id="walletDistributionList">
                        <!-- Item 1 -->
                        <div class="flex flex-col sm:flex-row items-center gap-3">
                            <div class="w-full sm:flex-1 relative">
                                <label class="text-[10px] font-bold text-slate-400 block mb-1">Penerima Alokasi</label>
                                <div class="relative">
                                    <select
                                        class="w-full px-3 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all appearance-none cursor-pointer">
                                        <option value="Divisi Operasional" selected>Divisi Operasional</option>
                                        <option value="Divisi Pemasaran / Sales">Divisi Pemasaran / Sales</option>
                                        <option value="Manajemen / Kas Perusahaan">Manajemen / Kas Perusahaan</option>
                                        <option value="Pihak Ketiga / Vendor">Pihak Ketiga / Vendor</option>
                                    </select>
                                    <div
                                        class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-slate-400">
                                        <span class="material-symbols-outlined text-lg">expand_more</span>
                                    </div>
                                </div>
                            </div>
                            <div class="w-full sm:w-28 relative">
                                <label class="text-[10px] font-bold text-slate-400 block mb-1">Porsi (%)</label>
                                <input type="number" value="40"
                                    class="wallet-percent w-full px-3 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-700 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none pr-8 text-right transition-all"
                                    oninput="calcWallet()">
                                <span class="absolute right-3 top-[34px] text-sm font-bold text-slate-400">%</span>
                            </div>
                            <div class="w-full sm:flex-1 relative">
                                <label class="text-[10px] font-bold text-slate-400 block mb-1">Nominal Diterima</label>
                                <span class="absolute left-3 top-[34px] text-sm font-bold text-slate-400">Rp</span>
                                <input type="text" readonly value="18.000.000"
                                    class="wallet-nominal w-full px-3 py-2.5 pl-9 bg-emerald-50/50 border border-emerald-100 rounded-xl text-sm font-bold text-emerald-700 outline-none text-right">
                            </div>
                        </div>
                        <!-- Item 2 -->
                        <div class="flex flex-col sm:flex-row items-center gap-3">
                            <div class="w-full sm:flex-1 relative">
                                <select
                                    class="w-full px-3 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all appearance-none cursor-pointer">
                                    <option value="Divisi Operasional">Divisi Operasional</option>
                                    <option value="Divisi Pemasaran / Sales" selected>Divisi Pemasaran / Sales</option>
                                    <option value="Manajemen / Kas Perusahaan">Manajemen / Kas Perusahaan</option>
                                    <option value="Pihak Ketiga / Vendor">Pihak Ketiga / Vendor</option>
                                </select>
                                <div
                                    class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-slate-400">
                                    <span class="material-symbols-outlined text-lg">expand_more</span>
                                </div>
                            </div>
                            <div class="w-full sm:w-28 relative">
                                <input type="number" value="30"
                                    class="wallet-percent w-full px-3 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-700 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none pr-8 text-right transition-all"
                                    oninput="calcWallet()">
                                <span
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-sm font-bold text-slate-400">%</span>
                            </div>
                            <div class="w-full sm:flex-1 relative">
                                <span
                                    class="absolute left-3 top-1/2 -translate-y-1/2 text-sm font-bold text-slate-400">Rp</span>
                                <input type="text" readonly value="13.500.000"
                                    class="wallet-nominal w-full px-3 py-2.5 pl-9 bg-emerald-50/50 border border-emerald-100 rounded-xl text-sm font-bold text-emerald-700 outline-none text-right">
                            </div>
                        </div>
                        <!-- Item 3 -->
                        <div class="flex flex-col sm:flex-row items-center gap-3">
                            <div class="w-full sm:flex-1 relative">
                                <select
                                    class="w-full px-3 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all appearance-none cursor-pointer">
                                    <option value="Divisi Operasional">Divisi Operasional</option>
                                    <option value="Divisi Pemasaran / Sales">Divisi Pemasaran / Sales</option>
                                    <option value="Manajemen / Kas Perusahaan" selected>Manajemen / Kas Perusahaan
                                    </option>
                                    <option value="Pihak Ketiga / Vendor">Pihak Ketiga / Vendor</option>
                                </select>
                                <div
                                    class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-slate-400">
                                    <span class="material-symbols-outlined text-lg">expand_more</span>
                                </div>
                            </div>
                            <div class="w-full sm:w-28 relative">
                                <input type="number" value="30"
                                    class="wallet-percent w-full px-3 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-700 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none pr-8 text-right transition-all"
                                    oninput="calcWallet()">
                                <span
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-sm font-bold text-slate-400">%</span>
                            </div>
                            <div class="w-full sm:flex-1 relative">
                                <span
                                    class="absolute left-3 top-1/2 -translate-y-1/2 text-sm font-bold text-slate-400">Rp</span>
                                <input type="text" readonly value="13.500.000"
                                    class="wallet-nominal w-full px-3 py-2.5 pl-9 bg-emerald-50/50 border border-emerald-100 rounded-xl text-sm font-bold text-emerald-700 outline-none text-right">
                            </div>
                        </div>
                    </div>

                    <button onclick="addWalletRecipient()"
                        class="mt-4 w-full py-2.5 border-2 border-dashed border-slate-200 text-slate-500 rounded-xl text-xs font-bold hover:bg-slate-50 hover:text-primary hover:border-primary/50 transition-all flex items-center justify-center gap-1">
                        <span class="material-symbols-outlined text-[16px]">add</span> Tambah Penerima
                    </button>
                </div>

            </div>

            <!-- Modal Footer -->
            <div class="px-6 py-4 border-t border-slate-100 flex justify-end gap-3 bg-white">
                <button onclick="closeWalletModal()"
                    class="px-4 py-2.5 text-slate-500 font-bold text-sm hover:bg-slate-50 hover:text-slate-700 rounded-xl transition-all border border-transparent hover:border-slate-200">Batal</button>
                <button onclick="alert('Distribusi Share Wallet Berhasil Disimpan!'); closeWalletModal();"
                    class="px-6 py-2.5 bg-emerald-500 text-white font-bold text-sm rounded-xl shadow-lg shadow-emerald-500/20 hover:bg-emerald-600 transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined text-[18px]">check_circle</span> Konfirmasi Pembagian
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Service Modal -->
    <div id="editServiceModal"
        class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm hidden">
        <div
            class="relative bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden border border-slate-200 transform transition-all">
            <div class="p-8">
                <div class="flex items-center justify-between mb-8">
                    <h3 class="text-xl font-bold text-slate-800">Edit Layanan & Pricing</h3>
                    <button onclick="closeEditServiceModal()"
                        class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 transition-colors text-slate-400">
                        <span class="material-symbols-outlined text-[20px]">close</span>
                    </button>
                </div>
                <form class="space-y-5" onsubmit="event.preventDefault(); saveService();">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Nama
                            Layanan / Proyek</label>
                        <input id="editServiceName"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded-xl text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all font-semibold outline-none text-slate-800"
                            type="text" placeholder="Masukkan nama layanan" />
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Pemilik
                            Portofolio</label>
                        <div class="relative">
                            <select id="editServiceOwner" onchange="loadCategoryOptions(this.value)"
                                class="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded-xl text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all font-semibold outline-none text-slate-800 appearance-none cursor-pointer">
                                <option value="">-- Pilih Divisi --</option>
                            </select>
                            <span
                                class="absolute right-3 top-1/2 -translate-y-1/2 material-symbols-outlined text-slate-400 pointer-events-none">expand_more</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Bidang
                                / Sektor</label>
                            <div class="relative">
                                <select id="editServiceCategory"
                                    class="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded-xl text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all font-semibold outline-none appearance-none text-slate-800 cursor-pointer">
                                    <option value="">-- Pilih BIdang / Sektor --</option>
                                </select>
                                <span
                                    class="absolute right-3 top-1/2 -translate-y-1/2 material-symbols-outlined text-slate-400 pointer-events-none">expand_more</span>
                            </div>
                        </div>
                        <div>
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Status</label>
                            <div class="relative">
                                <select id="editServiceStatus"
                                    class="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded-xl text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all font-semibold outline-none appearance-none text-slate-800 cursor-pointer">
                                    <option value="On Progress">On Progress</option>
                                    <option value="Available">Available</option>
                                    <option value="Revised">Revised</option>
                                </select>
                                <span
                                    class="absolute right-3 top-1/2 -translate-y-1/2 material-symbols-outlined text-slate-400 pointer-events-none">expand_more</span>
                            </div>
                        </div>
                    </div>
                    <div class="pt-4 flex gap-3">
                        <button type="submit"
                            class="flex-1 py-4 bg-primary text-white rounded-xl font-bold text-sm shadow-lg shadow-primary/30 hover:bg-blue-900 transition-all active:scale-[0.98]">
                            Simpan Layanan
                        </button>
                        <button type="button"
                            onclick="event.preventDefault(); saveService(true).then(() => openParameterModal());"
                            class="py-4 px-6 bg-emerald-500 text-white rounded-xl font-bold text-sm shadow-lg shadow-emerald-500/30 hover:bg-emerald-600 transition-all active:scale-[0.98]">
                            Simpan & Parameter
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Pricing Parameters Modal -->
    <div id="parameterModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-[70] p-4 hidden">
        <div
            class="bg-white w-full max-w-md rounded-2xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden border border-slate-200">
            <div class="p-6 pb-0 flex justify-between items-start">
                <div>
                    <h2 class="text-xl font-bold text-slate-800">Parameter Penentuan Harga</h2>
                    <p class="text-sm text-slate-500 mt-1" id="parameterModalSubtitle">Inspeksi Peralatan Baru Pesawat
                        Uap</p>
                </div>
                <button onclick="closeParameterModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-6 overflow-y-auto space-y-5">
                <!-- Dynamic parameter boxes container -->
                <div id="parameterBoxesContainer" class="space-y-4">
                    <div
                        class="param-box space-y-1.5 relative group border border-slate-100 rounded-xl p-4 hover:border-slate-200 transition-all">
                        <button type="button" onclick="this.closest('.param-box').remove()"
                            class="absolute top-2 right-2 p-1 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all opacity-0 group-hover:opacity-100">
                            <span class="material-symbols-outlined !text-lg">close</span>
                        </button>
                        <label class="text-sm font-medium text-slate-700">Spesifikasi Alat</label>
                        <input
                            class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-900 placeholder:text-slate-400 focus:ring-2 focus:ring-[#3498db]/20 focus:border-[#3498db] transition-all outline-none"
                            placeholder="Contoh: Boiler, Pressure Vessel, etc." type="text" />
                    </div>
                    <div
                        class="param-box space-y-1.5 relative group border border-slate-100 rounded-xl p-4 hover:border-slate-200 transition-all">
                        <button type="button" onclick="this.closest('.param-box').remove()"
                            class="absolute top-2 right-2 p-1 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all opacity-0 group-hover:opacity-100">
                            <span class="material-symbols-outlined !text-lg">close</span>
                        </button>
                        <label class="text-sm font-medium text-slate-700">Jumlah Jalur Pipa <span
                                class="text-xs text-slate-400 font-normal">(Jika Pekerjaan Pipa)</span></label>
                        <input
                            class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-900 placeholder:text-slate-400 focus:ring-2 focus:ring-[#3498db]/20 focus:border-[#3498db] transition-all outline-none"
                            placeholder="0" type="number" />
                    </div>
                    <div
                        class="param-box space-y-1.5 relative group border border-slate-100 rounded-xl p-4 hover:border-slate-200 transition-all">
                        <button type="button" onclick="this.closest('.param-box').remove()"
                            class="absolute top-2 right-2 p-1 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all opacity-0 group-hover:opacity-100">
                            <span class="material-symbols-outlined !text-lg">close</span>
                        </button>
                        <label class="text-sm font-medium text-slate-700">Diameter dan Tinggi Tanki <span
                                class="text-xs text-slate-400 font-normal">(Jika Pekerjaan Tanki)</span></label>
                        <input
                            class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-900 placeholder:text-slate-400 focus:ring-2 focus:ring-[#3498db]/20 focus:border-[#3498db] transition-all outline-none"
                            placeholder="m / mm" type="text" />
                    </div>
                    <div
                        class="param-box space-y-1.5 relative group border border-slate-100 rounded-xl p-4 hover:border-slate-200 transition-all">
                        <button type="button" onclick="this.closest('.param-box').remove()"
                            class="absolute top-2 right-2 p-1 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all opacity-0 group-hover:opacity-100">
                            <span class="material-symbols-outlined !text-lg">close</span>
                        </button>
                        <label class="text-sm font-medium text-slate-700">Jumlah Tangki <span
                                class="text-xs text-slate-400 font-normal">(Jika Pekerjaan Tanki)</span></label>
                        <input
                            class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-900 placeholder:text-slate-400 focus:ring-2 focus:ring-[#3498db]/20 focus:border-[#3498db] transition-all outline-none"
                            placeholder="0" type="number" />
                    </div>
                    <div
                        class="param-box space-y-1.5 relative group border border-slate-100 rounded-xl p-4 hover:border-slate-200 transition-all">
                        <button type="button" onclick="this.closest('.param-box').remove()"
                            class="absolute top-2 right-2 p-1 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all opacity-0 group-hover:opacity-100">
                            <span class="material-symbols-outlined !text-lg">close</span>
                        </button>
                        <label class="text-sm font-medium text-slate-700">Metode Pengujian</label>
                        <input
                            class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-900 placeholder:text-slate-400 focus:ring-2 focus:ring-[#3498db]/20 focus:border-[#3498db] transition-all outline-none"
                            placeholder="Contoh: UT, Radiography, etc." type="text" />
                    </div>
                </div>
                <div class="pt-2 flex justify-center">
                    <button type="button" onclick="openAddParameterDetailModal()"
                        class="flex items-center gap-2 px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-full text-sm font-semibold transition-all shadow-sm hover:shadow-md">
                        <span class="material-symbols-outlined text-sm">add</span>
                        Tambah Parameter
                    </button>
                </div>
            </div>
            <div class="p-6 pt-2 border-t border-slate-100">
                <button onclick="alert('Parameter harga berhasil disimpan!'); closeParameterModal();"
                    class="w-full bg-[#3498db] hover:bg-blue-600 text-white font-semibold py-3 rounded-lg shadow-lg shadow-[#3498db]/20 transition-all active:scale-[0.98]">
                    Simpan
                </button>
            </div>
        </div>
    </div>

    <!-- Add Parameter Detail Modal -->
    <div id="addParameterDetailModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-[80] p-4 hidden">
        <div
            class="bg-white w-full max-w-[420px] rounded-xl shadow-2xl overflow-hidden border border-slate-200 transform transition-all">
            <div class="px-6 pt-6 pb-2 flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-800">Paramameter</h2>
                <button onclick="closeAddParameterDetailModal()"
                    class="text-slate-400 hover:text-slate-600 transition-colors">
                    <span class="material-symbols-outlined text-xl leading-none">close</span>
                </button>
            </div>
            <form class="p-6 space-y-5"
                onsubmit="event.preventDefault(); addParameterToContainer(this); closeAddParameterDetailModal();">
                <div class="space-y-1.5">
                    <label class="block text-sm font-medium text-slate-600">Nama Parameter</label>
                    <input
                        class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-[#3498db]/50 focus:border-[#3498db] transition-all outline-none"
                        placeholder="Masukkan nama parameter" type="text" />
                </div>
                <div class="space-y-1.5">
                    <label class="block text-sm font-medium text-slate-600">Harga Persatuan</label>
                    <input
                        class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-[#3498db]/50 focus:border-[#3498db] transition-all outline-none"
                        placeholder="0" type="number" />
                </div>
                <div class="space-y-1.5 relative">
                    <label class="block text-sm font-medium text-slate-600">Satuan</label>
                    <div class="relative">
                        <select id="paramSatuanSelect"
                            class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-800 appearance-none focus:ring-2 focus:ring-[#3498db]/50 focus:border-[#3498db] transition-all cursor-pointer outline-none">
                            <option value="">Pilih Satuan</option>
                            <option value="meter">Meter (m)</option>
                            <option value="milimeter">Milimeter (mm)</option>
                            <option value="centimeter">Centimeter (cm)</option>
                            <option value="kilometer">Kilometer (km)</option>
                            <option value="inch">Inch (in)</option>
                            <option value="kg">Kilogram (Kg)</option>
                            <option value="gram">Gram (g)</option>
                            <option value="ton">Ton</option>
                            <option value="liter">Liter (L)</option>
                            <option value="unit">Unit</option>
                            <option value="buah">Buah</option>
                            <option value="set">Set</option>
                            <option value="lot">Lot</option>
                            <option value="titik">Titik</option>
                            <option value="jam">Jam</option>
                            <option value="hari">Hari</option>
                            <option value="bulan">Bulan</option>
                            <option value="tahun">Tahun</option>
                            <option value="persen">Persen (%)</option>
                            <option value="lainnya">Lainnya...</option>
                        </select>
                        <div id="paramSatuanCustom" class="hidden mt-2">
                            <input type="text"
                                class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-[#3498db]/50 focus:border-[#3498db] transition-all outline-none"
                                placeholder="Ketik satuan kustom..." />
                        </div>
                        <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-slate-400">
                            <span class="material-symbols-outlined text-sm">arrow_drop_down</span>
                        </div>
                    </div>
                </div>
                <div class="space-y-1.5">
                    <label class="block text-sm font-medium text-slate-600">Total Harga Satuan</label>
                    <input
                        class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-500 focus:ring-0 cursor-not-allowed outline-none"
                        readonly="" type="text" value="0" />
                </div>
                <div class="pt-4">
                    <button
                        class="w-full bg-[#3498db] hover:bg-[#2980b9] text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 outline-none"
                        type="submit">
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Request Additional Data Modal -->
    <div id="requestDataModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-[90] hidden">
        <div
            class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col overflow-hidden border border-slate-200 transform transition-all">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-white">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center text-blue-600">
                        <span class="material-symbols-outlined">find_in_page</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-900">Request Additional Data</h1>
                        <p class="text-xs text-slate-500">Lengkapi informasi yang dibutuhkan dari klien</p>
                    </div>
                </div>
                <button onclick="closeRequestDataModal()"
                    class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition-colors">
                    <span class="material-symbols-outlined text-xl font-light">close</span>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 max-h-[70vh]">
                <div class="bg-slate-50 rounded-xl p-4 mb-6 border border-slate-100">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Nama Klien</p>
                            <p class="text-sm font-semibold text-slate-700" id="reqDataClientName">PT. Megah Sejahtera
                                Mandiri</p>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">No. Request
                            </p>
                            <p class="text-sm font-mono font-semibold text-slate-700" id="reqDataNo">REQ/20231024/0082
                            </p>
                        </div>
                    </div>
                </div>
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Pesan ke Klien</label>
                        <textarea
                            class="w-full rounded-xl border-slate-200 focus:ring-primary/20 focus:border-primary text-sm placeholder:text-slate-400 outline-none transition-all"
                            placeholder="Tuliskan detail data atau dokumen tambahan yang diperlukan secara spesifik..."
                            rows="4"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-3">Dokumen yang Diperlukan</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <label
                                class="flex items-center p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer transition-colors group">
                                <input class="rounded border-slate-300 text-primary focus:ring-primary h-4 w-4"
                                    type="checkbox" />
                                <span
                                    class="ml-3 text-sm text-slate-600 group-hover:text-primary transition-colors">Drawing
                                    Teknik</span>
                            </label>
                            <label
                                class="flex items-center p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer transition-colors group">
                                <input class="rounded border-slate-300 text-primary focus:ring-primary h-4 w-4"
                                    type="checkbox" />
                                <span
                                    class="ml-3 text-sm text-slate-600 group-hover:text-primary transition-colors">Izin
                                    Lingkungan (AMDAL)</span>
                            </label>
                            <label
                                class="flex items-center p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer transition-colors group">
                                <input class="rounded border-slate-300 text-primary focus:ring-primary h-4 w-4"
                                    type="checkbox" />
                                <span
                                    class="ml-3 text-sm text-slate-600 group-hover:text-primary transition-colors">Spesifikasi
                                    Teknis Detail</span>
                            </label>
                            <label
                                class="flex items-center p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer transition-colors group">
                                <input class="rounded border-slate-300 text-primary focus:ring-primary h-4 w-4"
                                    type="checkbox" />
                                <span
                                    class="ml-3 text-sm text-slate-600 group-hover:text-primary transition-colors">Foto
                                    Area Lapangan</span>
                            </label>
                            <label
                                class="flex items-center p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer transition-colors group">
                                <input class="rounded border-slate-300 text-primary focus:ring-primary h-4 w-4"
                                    type="checkbox" />
                                <span
                                    class="ml-3 text-sm text-slate-600 group-hover:text-primary transition-colors">Sertifikat
                                    Alat Sebelumnya</span>
                            </label>
                            <label
                                class="flex items-center p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer transition-colors group">
                                <input class="rounded border-slate-300 text-primary focus:ring-primary h-4 w-4"
                                    type="checkbox" />
                                <span
                                    class="ml-3 text-sm text-slate-600 group-hover:text-primary transition-colors">Data
                                    Koordinat Lokasi</span>
                            </label>
                        </div>
                        <div class="mt-3">
                            <button class="text-xs text-blue-600 font-medium hover:underline flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">add</span> Tambah dokumen lainnya
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="px-6 py-5 bg-slate-50 border-t border-slate-100 flex justify-end items-center gap-3">
                <button onclick="closeRequestDataModal()"
                    class="px-6 py-2.5 rounded-lg border border-slate-300 text-slate-600 font-bold text-sm hover:bg-slate-100 transition-all">
                    Batalkan
                </button>
                <button onclick="alert('Permintaan Data Terkirim ke Klien!'); closeRequestDataModal();"
                    class="px-6 py-2.5 rounded-lg bg-primary hover:bg-blue-900 text-white font-bold text-sm shadow-lg shadow-primary/20 transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined text-lg">send</span>
                    Kirim Permintaan Data
                </button>
            </div>
        </div>
    </div>

    <!-- Negotiation Modal -->
    <div id="negotiationModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-[90] hidden">
        <div
            class="bg-white w-full max-w-5xl max-h-[90vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden border border-slate-200 transform transition-all">
            <div class="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div>
                    <h1 class="text-2xl font-bold text-slate-900 flex items-center gap-3">
                        <span class="bg-blue-50 text-blue-600 p-2 rounded-lg flex items-center justify-center">
                            <span class="material-symbols-outlined">compare_arrows</span>
                        </span>
                        Counter-Offer Comparison
                    </h1>
                    <p class="text-slate-500 text-sm mt-1">Review and compare the client's counter-offer against our
                        initial proposal.</p>
                </div>
                <button onclick="closeNegotiationModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-8 custom-scrollbar">
                <div
                    class="grid grid-cols-12 gap-4 pb-4 mb-2 border-b border-slate-200 text-xs font-bold uppercase tracking-wider text-slate-400 px-4">
                    <div class="col-span-5">Items &amp; Parameters</div>
                    <div class="col-span-3 text-right">Harga Awal (Admin)</div>
                    <div class="col-span-4 text-right">Harga Klien (Counter)</div>
                </div>

                <div class="mb-8">
                    <div class="bg-slate-50 px-4 py-2 rounded-lg mb-3">
                        <h3 class="text-sm font-bold text-slate-800">Item 1: Sertifikasi Instalasi Penyalur Petir</h3>
                    </div>
                    <div class="space-y-2">
                        <div
                            class="grid grid-cols-12 gap-4 px-4 py-3 items-center hover:bg-slate-50 rounded-xl transition-colors">
                            <div class="col-span-5">
                                <p class="text-sm font-semibold text-slate-700">Lokasi</p>
                                <p class="text-xs text-slate-500">Jl. Gajah Mada No. 123, Jakarta Barat</p>
                            </div>
                            <div class="col-span-3 text-right font-mono text-sm text-slate-600">12.000.000</div>
                            <div class="col-span-4 flex items-center justify-end gap-3">
                                <span class="font-mono text-sm font-bold text-slate-900">10.000.000</span>
                                <span
                                    class="text-[10px] px-2 py-0.5 bg-red-100 text-red-600 rounded-full font-bold">-16.6%</span>
                            </div>
                        </div>
                        <div
                            class="grid grid-cols-12 gap-4 px-4 py-3 items-center hover:bg-slate-50 rounded-xl transition-colors">
                            <div class="col-span-5">
                                <p class="text-sm font-semibold text-slate-700">Spesifikasi Alat</p>
                                <p class="text-xs text-slate-500">Kurn R-150</p>
                            </div>
                            <div class="col-span-3 text-right font-mono text-sm text-slate-600">5.000.000</div>
                            <div class="col-span-4 flex items-center justify-end gap-3">
                                <span class="font-mono text-sm font-bold text-slate-900">5.000.000</span>
                                <span
                                    class="text-[10px] px-2 py-0.5 bg-slate-100 text-slate-500 rounded-full font-bold">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-8">
                    <div class="bg-slate-50 px-4 py-2 rounded-lg mb-3">
                        <h3 class="text-sm font-bold text-slate-800">Item 2: NDT Radiography</h3>
                    </div>
                    <div class="space-y-2">
                        <div
                            class="grid grid-cols-12 gap-4 px-4 py-3 items-center hover:bg-slate-50 rounded-xl transition-colors">
                            <div class="col-span-5">
                                <p class="text-sm font-semibold text-slate-700">Lokasi</p>
                                <p class="text-xs text-slate-500">Cilegon Site</p>
                            </div>
                            <div class="col-span-3 text-right font-mono text-sm text-slate-600">12.500.000</div>
                            <div class="col-span-4 flex items-center justify-end gap-3">
                                <span class="font-mono text-sm font-bold text-slate-900">12.000.000</span>
                                <span
                                    class="text-[10px] px-2 py-0.5 bg-red-100 text-red-600 rounded-full font-bold">-4.0%</span>
                            </div>
                        </div>
                        <div
                            class="grid grid-cols-12 gap-4 px-4 py-3 items-center hover:bg-slate-50 rounded-xl transition-colors">
                            <div class="col-span-5">
                                <p class="text-sm font-semibold text-slate-700">Parameter Jumlah Spot</p>
                                <p class="text-xs text-slate-500">120 Spots</p>
                            </div>
                            <div class="col-span-3 text-right font-mono text-sm text-slate-600">250.000.000</div>
                            <div class="col-span-4 flex items-center justify-end gap-3">
                                <span class="font-mono text-sm font-bold text-slate-900">210.000.000</span>
                                <span
                                    class="text-[10px] px-2 py-0.5 bg-red-100 text-red-600 rounded-full font-bold">-16.0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 border-t border-slate-200 pt-8">
                    <div class="grid grid-cols-12 gap-8">
                        <div class="col-span-6">
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <h4 class="text-xs font-bold text-blue-800 uppercase tracking-widest mb-2">Catatan
                                    Negosiasi</h4>
                                <p class="text-sm text-blue-700/80 leading-relaxed">
                                    Klien meminta pemotongan biaya pada parameter Lokasi dan Jumlah Spot Radiography
                                    dikarenakan volume pekerjaan yang berkelanjutan selama 6 bulan ke depan.
                                </p>
                            </div>
                        </div>
                        <div class="col-span-6 space-y-3">
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-slate-500">Subtotal Awal</span>
                                <span class="font-mono font-medium text-slate-700">450.000.000</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-slate-500">Subtotal Client Counter</span>
                                <span class="font-mono font-medium text-slate-700">410.000.000</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-slate-500">Total PPN (11%)</span>
                                <span class="font-mono font-medium text-slate-700">45.100.000</span>
                            </div>
                            <div class="pt-3 border-t border-slate-200 flex justify-between items-end">
                                <div>
                                    <span class="block text-xs font-bold text-slate-400 uppercase">Grand Total (Incl.
                                        Tax)</span>
                                    <span class="text-2xl font-black text-slate-900 font-mono">455.100.000</span>
                                </div>
                                <div class="text-right">
                                    <span class="block text-[10px] font-bold text-red-500 uppercase">Margin
                                        Impact</span>
                                    <span class="text-lg font-bold text-red-500 font-mono">-40.000.000</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="px-8 py-6 bg-slate-50 border-t border-slate-100 flex flex-wrap gap-4 justify-end">
                <button onclick="openRespondCounterOfferModal()"
                    class="px-6 py-2.5 rounded-lg border border-slate-300 text-slate-600 font-bold text-sm hover:bg-slate-100 transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined text-base">refresh</span> Negosiasi Ulang
                </button>
                <button onclick="closeNegotiationModal()"
                    class="px-6 py-2.5 rounded-lg border border-red-200 text-red-500 font-bold text-sm hover:bg-red-50 transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined text-base">close</span> Reject
                </button>
                <button onclick="alert('Deal Berhasil, PO Generated!'); closeNegotiationModal();"
                    class="px-8 py-2.5 rounded-lg bg-primary text-white font-bold text-sm hover:bg-blue-800 shadow-lg shadow-primary/20 transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined text-base">check_circle</span> Deal, Generate PO &amp; Send
                    to Client
                </button>
            </div>
        </div>
    </div>

    <!-- Respond Counter-Offer Modal -->
    <div id="respondCounterOfferModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-[95] hidden">
        <div
            class="w-full max-w-5xl bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col border border-slate-200 transform transition-all max-h-[90vh]">
            <div class="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div>
                    <h1 class="text-2xl font-bold text-slate-900 flex items-center gap-3">
                        <span class="bg-blue-50 text-blue-600 p-2 rounded-lg flex items-center justify-center">
                            <span class="material-symbols-outlined">compare_arrows</span>
                        </span>
                        Respond Counter-Offer
                    </h1>
                    <p class="text-sm text-slate-500 mt-1">Review client counter-offers and set final pricing to
                        generate PO.</p>
                </div>
                <button onclick="closeRespondCounterOfferModal()"
                    class="text-slate-400 hover:text-slate-600 transition-colors">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-8 custom-scrollbar bg-slate-50/30">
                <div
                    class="grid grid-cols-12 gap-4 pb-4 mb-4 px-4 text-xs font-bold uppercase tracking-wider text-slate-400 border-b border-slate-200">
                    <div class="col-span-4">Items &amp; Parameters</div>
                    <div class="col-span-2 text-right">Harga Awal</div>
                    <div class="col-span-3 text-right">Harga Klien</div>
                    <div class="col-span-3 text-right">Harga Baru (Final)</div>
                </div>

                <!-- Item 1 -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm mb-6 overflow-hidden">
                    <div class="bg-slate-50 px-4 py-2 border-b border-slate-100">
                        <span class="text-xs font-bold text-primary">ITEM 1: SERTIFIKASI INSTALASI PENYALUR PETIR</span>
                    </div>
                    <div
                        class="grid grid-cols-12 gap-4 p-4 items-center border-b border-slate-50 hover:bg-slate-50/50 transition-colors">
                        <div class="col-span-4">
                            <p class="text-xs text-slate-400 uppercase font-medium">Lokasi</p>
                            <p class="text-sm font-semibold text-slate-800">Jl. Gajah Mada No. 45, Jakarta Barat</p>
                        </div>
                        <div class="col-span-2 text-right">
                            <p class="text-sm font-semibold text-slate-600">12.000.000</p>
                        </div>
                        <div class="col-span-3 text-right">
                            <p class="text-sm font-bold text-blue-500">10.000.000</p>
                        </div>
                        <div class="col-span-3">
                            <input
                                class="w-full text-right bg-blue-50/50 border border-blue-200 focus:ring-2 focus:ring-primary/20 focus:border-primary rounded-lg text-sm font-bold text-slate-900 outline-none"
                                placeholder="Set Price" type="number" value="10500000" />
                        </div>
                    </div>
                    <div class="grid grid-cols-12 gap-4 p-4 items-center hover:bg-slate-50/50 transition-colors">
                        <div class="col-span-4">
                            <p class="text-xs text-slate-400 uppercase font-medium">Spesifikasi</p>
                            <p class="text-sm font-semibold text-slate-800">Kuat Arus &gt; 100kA</p>
                        </div>
                        <div class="col-span-2 text-right">
                            <p class="text-sm font-semibold text-slate-600">5.000.000</p>
                        </div>
                        <div class="col-span-3 text-right">
                            <p class="text-sm font-bold text-blue-500">4.000.000</p>
                        </div>
                        <div class="col-span-3">
                            <input
                                class="w-full text-right bg-blue-50/50 border border-blue-200 focus:ring-2 focus:ring-primary/20 focus:border-primary rounded-lg text-sm font-bold text-slate-900 outline-none"
                                placeholder="Set Price" type="number" value="4500000" />
                        </div>
                    </div>
                </div>

                <!-- Item 2 -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm mb-6 overflow-hidden">
                    <div class="bg-slate-50 px-4 py-2 border-b border-slate-100">
                        <span class="text-xs font-bold text-primary">ITEM 2: NDT RADIOGRAPHY</span>
                    </div>
                    <div class="grid grid-cols-12 gap-4 p-4 items-center hover:bg-slate-50/50 transition-colors">
                        <div class="col-span-4">
                            <p class="text-xs text-slate-400 uppercase font-medium">Metode</p>
                            <p class="text-sm font-semibold text-slate-800">X-Ray (Iridium 192)</p>
                        </div>
                        <div class="col-span-2 text-right">
                            <p class="text-sm font-semibold text-slate-600">8.500.000</p>
                        </div>
                        <div class="col-span-3 text-right">
                            <p class="text-sm font-bold text-blue-500">7.500.000</p>
                        </div>
                        <div class="col-span-3">
                            <input
                                class="w-full text-right bg-blue-50/50 border border-blue-200 focus:ring-2 focus:ring-primary/20 focus:border-primary rounded-lg text-sm font-bold text-slate-900 outline-none"
                                placeholder="Set Price" type="number" value="8000000" />
                        </div>
                    </div>
                </div>

                <!-- Item 3 -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm mb-8 overflow-hidden">
                    <div class="bg-slate-50 px-4 py-2 border-b border-slate-100">
                        <span class="text-xs font-bold text-primary">ITEM 3: TAMBAHAN LAYANAN</span>
                    </div>
                    <div class="grid grid-cols-12 gap-4 p-4 items-center hover:bg-slate-50/50 transition-colors">
                        <div class="col-span-4">
                            <p class="text-sm italic text-slate-500">"Biaya operasional sudah termasuk akomodasi tim
                                lapangan selama 3 hari kerja."</p>
                        </div>
                        <div class="col-span-2 text-right">
                            <p class="text-sm font-semibold text-slate-600">2.500.000</p>
                        </div>
                        <div class="col-span-3 text-right">
                            <p class="text-sm font-bold text-blue-500">2.000.000</p>
                        </div>
                        <div class="col-span-3">
                            <input
                                class="w-full text-right bg-blue-50/50 border border-blue-200 focus:ring-2 focus:ring-primary/20 focus:border-primary rounded-lg text-sm font-bold text-slate-900 outline-none"
                                placeholder="Set Price" type="number" value="2250000" />
                        </div>
                    </div>
                </div>

                <!-- Footer Calc -->
                <div class="grid grid-cols-12 gap-8 border-t border-slate-200 pt-6 mt-6">
                    <div class="col-span-7">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Final Admin Remarks
                            (Internal/Optional)</label>
                        <textarea
                            class="w-full bg-white border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none p-4 placeholder:text-slate-400"
                            placeholder="Add notes for the PO generation..." rows="4"></textarea>
                    </div>
                    <div class="col-span-5 flex flex-col gap-3">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-slate-500 font-medium">SUBTOTAL</span>
                            <div class="flex gap-4">
                                <span class="text-slate-400 line-through">28.000.000</span>
                                <span class="font-bold text-slate-800">25.250.000</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-slate-500 font-medium">PPN 11%</span>
                            <span class="font-bold text-slate-800">2.777.500</span>
                        </div>
                        <div class="flex justify-between items-center text-sm pb-3 border-b border-slate-200">
                            <span class="text-slate-500 font-medium">DISKON KHUSUS</span>
                            <span class="font-bold text-red-500">- 500.000</span>
                        </div>
                        <div class="flex justify-between items-end pt-2">
                            <span class="text-lg font-bold text-slate-800">GRAND TOTAL</span>
                            <div class="text-right">
                                <span class="block text-2xl font-black text-primary">Rp 27.527.500</span>
                                <span class="text-[10px] text-slate-400 font-medium italic mt-1 block">TERBILANG: Dua
                                    puluh tujuh juta lima ratus dua puluh tujuh ribu lima ratus rupiah</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-8 py-6 bg-white border-t border-slate-100 flex justify-between items-center">
                <div class="flex gap-3">
                    <button onclick="closeRespondCounterOfferModal()"
                        class="px-6 py-2.5 rounded-xl border border-slate-300 text-slate-600 font-semibold text-sm hover:bg-slate-50 transition-all">
                        SAVE DRAFT
                    </button>
                    <button onclick="closeRespondCounterOfferModal()"
                        class="px-6 py-2.5 rounded-xl bg-red-50 text-red-600 font-semibold text-sm hover:bg-red-100 transition-all flex items-center gap-2">
                        <span class="material-symbols-outlined text-base">block</span>
                        REJECT
                    </button>
                </div>
                <div class="flex gap-3">
                    <button onclick="sendPenawaran(); closeRespondCounterOfferModal();"
                        class="px-8 py-2.5 rounded-xl bg-primary text-white font-bold text-sm hover:bg-blue-800 transition-all flex items-center gap-2 shadow-lg shadow-primary/20">
                        <span class="material-symbols-outlined text-base">description</span>
                        DEAL, GENERATE PO AND SEND TO CLIENT
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Request Pricing Modal -->
    <div id="newRequestModal"
        class="fixed inset-0 z-[95] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm hidden">
        <div
            class="relative w-full max-w-6xl bg-white rounded-2xl shadow-2xl overflow-hidden border border-slate-200 flex flex-col max-h-[90vh]">
            <!-- Header -->
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white">
                <div>
                    <h2 class="text-xl font-bold text-primary">Detail Permintaan</h2>
                    <p class="text-xs text-slate-500 mt-1" id="newRequestSubtitle">Memuat data permintaan...</p>
                </div>
                <button onclick="closeNewRequestModal()" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                    <span class="material-symbols-outlined text-slate-400">close</span>
                </button>
            </div>

            <!-- Content (dynamic) -->
            <div class="flex-1 overflow-y-auto p-6 lg:p-8 bg-[#fdfbf7] custom-scrollbar">
                <div id="newRequestModalContent" class="space-y-8">
                    <p class="text-center text-slate-400 py-8">Memuat data...</p>
                </div>
            </div>

            <!-- Footer Actions -->
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex flex-wrap gap-3 items-center justify-end">
                <button onclick="closeNewRequestModal()"
                    class="px-5 py-2.5 text-slate-500 hover:text-slate-700 text-sm font-semibold transition-all">
                    TUTUP
                </button>
                <button id="btnIncompleteData" onclick="markDataIncomplete()"
                    class="hidden px-6 py-2.5 bg-rose-500 hover:bg-rose-600 text-white rounded-full text-sm font-bold transition-all shadow-lg shadow-rose-500/20 uppercase tracking-wide flex items-center">
                    <span>Data Tidak Lengkap</span>
                    <span class="material-symbols-outlined text-sm ml-2">warning</span>
                </button>
                <button id="btnNegotiate" onclick="negotiateRequest()"
                    class="hidden px-6 py-2.5 bg-amber-500 hover:bg-amber-600 text-white rounded-full text-sm font-bold transition-all shadow-lg shadow-amber-500/20 uppercase tracking-wide flex items-center">
                    <span>Negotiation</span>
                    <span class="material-symbols-outlined text-sm ml-2">handshake</span>
                </button>
                <button id="btnSendOffer" onclick="sendOfferFromModal()"
                    class="hidden px-8 py-2.5 bg-primary hover:bg-blue-800 text-white rounded-full text-sm font-bold transition-all shadow-lg shadow-blue-900/20 uppercase tracking-wide flex items-center">
                    <span>Kirim Penawaran</span>
                    <span class="material-symbols-outlined text-sm ml-2">send</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Complete Data Modal -->
    <div id="completeDataModal"
        class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm hidden">
        <div
            class="w-full max-w-xl bg-white rounded-2xl shadow-2xl border border-slate-200 flex flex-col overflow-hidden max-h-[90vh]">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-white">
                <div>
                    <h3 class="text-xl font-bold text-primary">Lengkapi Data Permintaan</h3>
                    <p class="text-[12px] text-slate-500 mt-1">Permintaan No: <span id="completeDataReqNo"
                            class="text-primary font-bold"></span></p>
                </div>
                <button onclick="closeCompleteDataModal()"
                    class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-400 transition-colors">
                    <span class="material-symbols-outlined text-[24px]">close</span>
                </button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar">
                <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6">
                    <div class="flex gap-3">
                        <span class="material-symbols-outlined text-amber-500 mt-0.5">info</span>
                        <div>
                            <h4 class="font-bold text-amber-800 text-sm">Data Tidak Lengkap</h4>
                            <p class="text-xs text-amber-700 mt-1">Admin SI-ONE menandai permintaan ini belum lengkap.
                                Silakan tambahkan informasi yang kurang di bawah ini agar kami dapat memproses penawaran
                                Anda.</p>
                        </div>
                    </div>
                </div>
                <div id="completeDataParams" class="mb-6 hidden">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Parameter yang Dibutuhkan:</label>
                    <ul
                        class="list-disc list-inside text-sm text-slate-600 space-y-1 bg-slate-50 p-4 rounded-xl border border-slate-200">
                    </ul>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Informasi Tambahan <span
                                class="text-rose-500">*</span></label>
                        <textarea id="completeDataNotes" rows="5"
                            class="w-full px-4 py-3 bg-white border border-slate-200 rounded-xl text-slate-900 focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all outline-none text-sm placeholder:text-slate-400"
                            placeholder="Tuliskan spesifikasi produk, lokasi detail, atau informasi penting lainnya yang sebelumnya tidak lengkap..."></textarea>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex justify-end gap-3">
                <button type="button" onclick="closeCompleteDataModal()"
                    class="px-6 py-2.5 text-slate-500 hover:text-slate-700 text-sm font-semibold rounded-xl hover:bg-slate-200/50 transition-all">Batal</button>
                <button type="button" onclick="submitCompletedData()"
                    class="px-6 py-2.5 bg-primary text-white rounded-xl font-bold text-sm shadow-lg shadow-primary/30 hover:bg-blue-800 transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined text-[18px]">send</span> Kirim Data
                </button>
            </div>
        </div>
    </div>

    <!-- Public Chat Modal -->
    <div id="publicChatModal"
        class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm hidden">
        <div
            class="w-full max-w-xl bg-white rounded-xl shadow-[0_20px_60px_-15px_rgba(0,0,0,0.3)] border border-slate-200 flex flex-col overflow-hidden h-[600px] max-h-[85vh] transform transition-all scale-100">
            <!-- Header -->
            <div class="px-6 py-5 border-b border-slate-100 flex items-center justify-between bg-white shrink-0">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-primary/5 text-primary rounded-xl flex items-center justify-center">
                        <span class="material-symbols-outlined text-[28px]">chat_bubble</span>
                    </div>
                    <div>
                        <h3 class="text-base font-bold text-primary leading-tight">Chat dengan PT Surveyor Indonesia
                        </h3>
                        <p class="text-[12px] text-slate-500 font-medium mt-0.5">Permintaan No: <span
                                id="chatModalReqNo" class="text-primary font-bold">#001060226</span></p>
                    </div>
                </div>
                <button onclick="closePublicChatModal()"
                    class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-400 transition-colors">
                    <span class="material-symbols-outlined text-[24px]">close</span>
                </button>
            </div>

            <!-- Body -->
            <div id="chatModalBody" class="flex-1 overflow-y-auto p-6 space-y-6 bg-[#FBFCFE]">
                <div class="flex justify-center">
                    <span
                        class="text-[10px] font-bold text-slate-400 bg-white border border-slate-100 px-4 py-1 rounded-full uppercase tracking-widest shadow-sm">Memuat
                        pesan...</span>
                </div>
            </div>

            <!-- Footer Input -->
            <div class="p-5 bg-white border-t border-slate-100 shrink-0">
                <div
                    class="flex items-center gap-3 bg-slate-50 p-2 rounded-2xl border border-slate-200 focus-within:ring-2 focus-within:ring-primary/20 focus-within:bg-white transition-all">
                    <input type="file" id="publicChatAttachment" class="hidden"
                        onchange="handlePublicChatAttachment(event)" />
                    <button onclick="document.getElementById('publicChatAttachment').click()"
                        class="p-2 text-slate-400 hover:text-primary transition-colors flex items-center justify-center">
                        <span class="material-symbols-outlined text-[24px]">attach_file</span>
                    </button>
                    <span id="publicChatAttachmentName"
                        class="text-[10px] text-slate-500 max-w-[80px] truncate hidden"></span>
                    <input id="chatModalInput"
                        class="flex-1 bg-transparent border-none focus:ring-0 text-sm py-2 placeholder:text-slate-400 outline-none"
                        placeholder="Ketik pesan Anda..." type="text"
                        onkeypress="if(event.key === 'Enter') sendPublicChatMessage()" />
                    <button onclick="sendPublicChatMessage()"
                        class="w-11 h-11 bg-primary text-white rounded-full flex items-center justify-center shadow-lg shadow-primary/30 hover:brightness-110 active:scale-95 transition-all">
                        <span class="material-symbols-outlined text-[22px]">send</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Chat Modal -->
    <div id="adminChatModal"
        class="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 hidden">
        <div
            class="bg-white w-full max-w-4xl h-[600px] rounded-[12px] shadow-2xl flex flex-col overflow-hidden border border-slate-200">
            <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between">
                <h3 class="text-primary font-bold text-lg">Pesan Masuk</h3>
                <button class="text-slate-400 hover:text-red-500 transition-colors" onclick="closeAdminChatModal()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="flex-1 flex overflow-hidden">
                <div class="w-1/3 border-r border-slate-100 flex flex-col bg-slate-50/50">
                    <div class="p-4 border-b border-slate-100">
                        <div class="relative">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">search</span>
                            <input
                                class="w-full pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-lg text-xs focus:ring-1 focus:ring-primary outline-none"
                                placeholder="Cari percakapan..." type="text" />
                        </div>
                    </div>
                    <div id="adminChatThreadList" class="flex-1 overflow-y-auto custom-scrollbar">
                        <!-- Threads will be loaded here -->
                        <div class="p-4 text-center text-xs text-slate-400 italic">Memuat percakapan...</div>
                    </div>
                </div>
                <div class="flex-1 flex flex-col bg-white">
                    <div id="adminChatHeader"
                        class="p-4 border-b border-slate-100 flex items-center justify-between bg-slate-50/30 hidden">
                        <div>
                            <h4 id="adminChatActiveName" class="font-bold text-slate-800 text-sm">Pilih Percakapan</h4>
                            <p id="adminChatActiveReq" class="text-[10px] text-slate-400"></p>
                        </div>
                    </div>
                    <div id="adminChatBody" class="flex-1 p-6 overflow-y-auto space-y-4 custom-scrollbar">
                        <div class="flex flex-col items-center justify-center h-full text-slate-400 italic text-sm">
                            Pilih tiket di sebelah kiri untuk melihat pesan
                        </div>
                    </div>
                    <div class="p-4 border-t border-slate-100">
                        <div class="flex items-center gap-2">
                            <input type="file" id="adminChatAttachment" class="hidden"
                                onchange="handleAdminChatAttachment(event)" />
                            <button class="p-2 text-slate-400 hover:text-primary transition-colors"
                                onclick="document.getElementById('adminChatAttachment').click()">
                                <span class="material-symbols-outlined">attach_file</span>
                            </button>
                            <span id="adminChatAttachmentName"
                                class="text-[10px] text-slate-500 max-w-[80px] truncate hidden"></span>
                            <input id="adminChatInput" onkeypress="if(event.key === 'Enter') sendAdminChatMessage()"
                                class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm focus:ring-1 focus:ring-primary outline-none"
                                placeholder="Ketik pesan..." type="text" disabled />
                            <button onclick="sendAdminChatMessage()" id="adminChatSendBtn" disabled
                                class="w-10 h-10 bg-primary hover:bg-blue-800 text-white rounded-xl flex items-center justify-center shadow-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="material-symbols-outlined">send</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Panel Modal -->
    <div id="notificationModal" class="fixed inset-0 z-[120] flex justify-end hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm z-0" onclick="closeNotificationModal()"></div>
        <aside
            class="relative z-10 w-full max-w-md bg-white h-screen shadow-2xl flex flex-col overflow-hidden border-l border-slate-200 transform transition-transform translate-x-0">
            <div class="p-6 border-b border-slate-100">
                <div class="flex items-center justify-between mb-1">
                    <h1 class="text-2xl font-bold text-slate-900">Notifications</h1>
                    <button onclick="closeNotificationModal()"
                        class="text-slate-400 hover:text-slate-600 transition-colors">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <p id="notif-count-text" class="text-sm text-slate-500">You have 4 unread alerts</p>
            </div>
            <div class="px-6 py-4 flex items-center justify-between border-b border-slate-100">
                <div class="flex gap-2">
                    <button id="btn-notif-all" onclick="switchNotifTab('all')"
                        class="px-4 py-1.5 bg-primary text-white text-sm font-medium rounded-full shadow-sm shadow-primary/20 transition-all">All</button>
                    <button id="btn-notif-unread" onclick="switchNotifTab('unread')"
                        class="px-4 py-1.5 bg-slate-100 text-slate-600 text-sm font-medium rounded-full hover:bg-slate-200 transition-colors">Unread</button>
                    <button id="btn-notif-archive" onclick="switchNotifTab('archive')"
                        class="px-4 py-1.5 bg-slate-100 text-slate-600 text-sm font-medium rounded-full hover:bg-slate-200 transition-colors">Archive</button>
                </div>
                <button onclick="markAllNotifsRead()" class="text-xs font-semibold text-primary hover:underline">Mark
                    all as read</button>
            </div>
            <div id="notification-list" class="flex-1 overflow-y-auto custom-scrollbar">
                <!-- Dynamic items will be injected here -->
                <div id="dynamic-notification-container" class="w-full"></div>

                <!-- Empty State for Archive (Hidden by default) -->
                <div id="notif-empty-state" class="hidden h-full flex-col items-center justify-center p-10 text-center">
                    <div
                        class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4 text-slate-300">
                        <span class="material-symbols-outlined text-3xl">inbox</span>
                    </div>
                    <p class="text-sm text-slate-500 font-medium">No notifications here</p>
                </div>
            </div>
            <div class="p-6 bg-slate-50 border-t border-slate-100">
                <button onclick="openNotificationSettingsModal()"
                    class="w-full bg-primary hover:bg-blue-700 text-white font-semibold py-4 rounded-xl shadow-lg shadow-primary/30 flex items-center justify-center gap-2 transition-all">
                    <span class="material-symbols-outlined text-[20px]">settings</span>
                    Manage Notifications Settings
                </button>
            </div>
        </aside>
    </div>

    <!-- NEW: Notification Settings Modal -->
    <div id="notificationSettingsModal"
        class="fixed inset-0 z-[130] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm hidden">
        <div
            class="bg-white w-full max-w-md rounded-2xl shadow-2xl border border-slate-200 overflow-hidden transform transition-all scale-100 flex flex-col max-h-[90vh]">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-white shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-500">
                        <span class="material-symbols-outlined">settings</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-slate-800">Notification Settings</h3>
                        <p class="text-xs text-slate-500">Manage your alert preferences</p>
                    </div>
                </div>
                <button onclick="closeNotificationSettingsModal()"
                    class="text-slate-400 hover:text-slate-600 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1 space-y-6">
                <!-- Channels -->
                <div class="space-y-4">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Channels</h4>

                    <div
                        class="flex items-center justify-between p-3 rounded-xl border border-slate-100 hover:border-slate-200 transition-colors">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-slate-400">mail</span>
                            <div>
                                <p class="text-sm font-bold text-slate-700">Email Notifications</p>
                                <p class="text-[10px] text-slate-500">Receive updates via email</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" checked class="sr-only peer">
                            <div
                                class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary">
                            </div>
                        </label>
                    </div>

                    <div
                        class="flex items-center justify-between p-3 rounded-xl border border-slate-100 hover:border-slate-200 transition-colors">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-slate-400">notifications_active</span>
                            <div>
                                <p class="text-sm font-bold text-slate-700">Push Notifications</p>
                                <p class="text-[10px] text-slate-500">Real-time browser alerts</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" checked class="sr-only peer">
                            <div
                                class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary">
                            </div>
                        </label>
                    </div>

                    <!-- WhatsApp Notification (NEW) -->
                    <div
                        class="flex items-center justify-between p-3 rounded-xl border border-slate-100 hover:border-slate-200 transition-colors">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-slate-400">forum</span>
                            <div>
                                <p class="text-sm font-bold text-slate-700">WhatsApp</p>
                                <p class="text-[10px] text-slate-500">Receive alerts via WA message</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" checked class="sr-only peer">
                            <div
                                class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-emerald-500">
                            </div>
                        </label>
                    </div>
                </div>

                <hr class="border-slate-100">

                <!-- Specific Events -->
                <div class="space-y-3">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Alert Types</h4>

                    <label class="flex items-center justify-between cursor-pointer group">
                        <span class="text-sm font-medium text-slate-700 group-hover:text-primary transition-colors">New
                            Requests</span>
                        <input type="checkbox" checked
                            class="rounded border-slate-300 text-primary focus:ring-primary h-4 w-4">
                    </label>
                    <label class="flex items-center justify-between cursor-pointer group">
                        <span
                            class="text-sm font-medium text-slate-700 group-hover:text-primary transition-colors">Status
                            Changes (Deal/Reject)</span>
                        <input type="checkbox" checked
                            class="rounded border-slate-300 text-primary focus:ring-primary h-4 w-4">
                    </label>
                    <label class="flex items-center justify-between cursor-pointer group">
                        <span
                            class="text-sm font-medium text-slate-700 group-hover:text-primary transition-colors">Counter-Offers</span>
                        <input type="checkbox" checked
                            class="rounded border-slate-300 text-primary focus:ring-primary h-4 w-4">
                    </label>
                    <label class="flex items-center justify-between cursor-pointer group">
                        <span
                            class="text-sm font-medium text-slate-700 group-hover:text-primary transition-colors">System
                            Updates</span>
                        <input type="checkbox" class="rounded border-slate-300 text-primary focus:ring-primary h-4 w-4">
                    </label>
                </div>
            </div>

            <div class="p-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-3 shrink-0">
                <button onclick="closeNotificationSettingsModal()"
                    class="px-5 py-2.5 text-slate-500 font-bold text-sm hover:bg-slate-100 rounded-xl transition-all">Cancel</button>
                <button onclick="closeNotificationSettingsModal(); alert('Notification Preferences Saved!')"
                    class="px-6 py-2.5 bg-primary text-white font-bold text-sm rounded-xl shadow-lg shadow-primary/20 hover:bg-blue-900 transition-all">Save
                    Changes</button>
            </div>
        </div>
    </div>

    <!-- Add Cabang Modal (NEW) -->
    <div id="addCabangModal"
        class="fixed inset-0 z-[130] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm hidden">
        <div
            class="bg-white w-full max-w-lg rounded-2xl shadow-2xl border border-slate-200 overflow-hidden transform transition-all">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center">
                        <span class="material-symbols-outlined text-primary">domain_add</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-slate-800 leading-tight">Tambah Kantor Cabang</h3>
                        <p class="text-xs text-slate-500 mt-0.5">Daftarkan entitas cabang baru ke dalam sistem</p>
                    </div>
                </div>
                <button onclick="closeAddCabangModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <form class="p-6 space-y-5" id="formTambahCabang" onsubmit="event.preventDefault(); saveBranch();">
                <div class="space-y-1.5">
                    <label class="text-sm font-semibold text-slate-700 flex items-center gap-1">Nama Kantor Cabang <span
                            class="text-rose-500">*</span></label>
                    <input
                        class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-sm placeholder:text-slate-400"
                        placeholder="Contoh: Surveyor Indonesia Cabang Balikpapan" type="text" required />
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1.5">
                        <label class="text-sm font-semibold text-slate-700 flex items-center gap-1">Kode Cabang <span
                                class="text-rose-500">*</span></label>
                        <input
                            class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-sm placeholder:text-slate-400"
                            placeholder="Contoh: SIBPP" type="text" required />
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-sm font-semibold text-slate-700 flex items-center gap-1">Lokasi / Kota <span
                                class="text-rose-500">*</span></label>
                        <input
                            class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-sm placeholder:text-slate-400"
                            placeholder="Contoh: Balikpapan" type="text" required />
                    </div>
                </div>
                <div class="space-y-1.5">
                    <label class="text-sm font-semibold text-slate-700 flex items-center gap-1">Target Desentralisasi
                        (Rp) <span class="text-rose-500">*</span></label>
                    <div class="relative">
                        <div
                            class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400 text-sm font-medium">
                            Rp</div>
                        <input id="cabangTarget"
                            class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-sm placeholder:text-slate-400"
                            min="0" placeholder="0" type="number" required />
                    </div>
                    <p class="text-[11px] text-slate-400 flex items-center gap-1 mt-1">
                        <span class="material-symbols-outlined text-[14px]">info</span>
                        Nilai ini menentukan target operasional mandiri dalam bentuk nominal
                    </p>
                </div>
                <div class="pt-2 flex justify-end items-center gap-3">
                    <button type="button" onclick="closeAddCabangModal()"
                        class="px-5 py-2.5 text-sm font-semibold text-slate-600 hover:bg-slate-100 rounded-xl transition-all border border-slate-200">Batal</button>
                    <button type="submit"
                        class="px-5 py-2.5 text-sm font-semibold text-white bg-primary hover:bg-blue-900 rounded-xl transition-all shadow-lg shadow-blue-900/20 flex items-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">save</span> Simpan Cabang
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Divisi Modal (NEW) -->
    <div id="addDivisiModal"
        class="fixed inset-0 z-[130] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm hidden">
        <div
            class="bg-white w-full max-w-lg rounded-2xl shadow-2xl border border-slate-200 overflow-hidden transform transition-all">
            <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <h3 class="text-lg font-bold text-primary flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">account_tree</span>
                    Tambah Divisi Bisnis
                </h3>
                <button onclick="closeAddDivisiModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <form class="p-6 space-y-5" id="formTambahDivisi"
                onsubmit="event.preventDefault(); addDivisiToTable(this); closeAddDivisiModal();">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1.5">Nama Divisi Bisnis</label>
                    <input
                        class="w-full px-4 py-2.5 border border-slate-300 bg-white rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-sm placeholder:text-slate-400"
                        placeholder="Contoh: Divisi Inspeksi Migas" type="text" required />
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1.5">Kode Divisi</label>
                        <input
                            class="w-full px-4 py-2.5 border border-slate-300 bg-white rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-sm placeholder:text-slate-400"
                            placeholder="Contoh: DIMG" type="text" required />
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1.5">Sektor Bisnis</label>
                        <div class="relative">
                            <select
                                class="w-full pl-4 pr-10 py-2.5 border border-slate-300 bg-white rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none appearance-none transition-all text-sm"
                                required>
                                <option value="">Pilih Sektor</option>
                                <option value="energi">Energi</option>
                                <option value="manufaktur">Manufaktur</option>
                                <option value="lingkungan">Lingkungan</option>
                            </select>
                            <span
                                class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">expand_more</span>
                        </div>
                    </div>
                </div>
                <div class="pt-2">
                    <p class="text-[11px] text-slate-500 bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <span class="font-bold text-blue-700">Catatan:</span> Pastikan kode divisi bersifat unik untuk
                        mempermudah identifikasi dalam sistem pelaporan.
                    </p>
                </div>
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" onclick="closeAddDivisiModal()"
                        class="px-5 py-2.5 text-sm font-semibold text-slate-600 border border-slate-300 rounded-xl hover:bg-slate-100 transition-colors">Batal</button>
                    <button type="submit"
                        class="px-5 py-2.5 text-sm font-semibold text-white bg-primary hover:bg-blue-900 rounded-xl shadow-md transition-all">Simpan
                        Divisi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Access Modal (UPDATED) -->
    <div id="addAksesModal"
        class="fixed inset-0 z-[130] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm hidden">
        <div
            class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl border border-slate-200 overflow-hidden transform transition-all flex flex-col max-h-[90vh]">
            <div class="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-white shrink-0">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    Manajemen Pengguna
                </h3>
                <button onclick="closeAddAksesModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-8 overflow-y-auto custom-scrollbar flex-1">
                <form class="space-y-5" id="formTambahAkses"
                    onsubmit="event.preventDefault(); addAksesToTable(this); closeAddAksesModal();">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <!-- Username -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1.5"
                                for="username">Username</label>
                            <input
                                class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all placeholder:text-slate-400"
                                id="username" placeholder="Buat username unik" type="text" required />
                        </div>

                        <!-- Password -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1.5"
                                for="password">Password</label>
                            <input
                                class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all placeholder:text-slate-400"
                                id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" type="password" required />
                        </div>

                        <!-- Nama Lengkap -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1.5" for="fullname">Nama
                                Lengkap</label>
                            <input
                                class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all placeholder:text-slate-400"
                                id="fullname" placeholder="Nama lengkap sesuai KTP" type="text" required />
                        </div>

                        <!-- Email (NEW) -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1.5" for="email">Email</label>
                            <input
                                class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all placeholder:text-slate-400"
                                id="email" placeholder="Alamat Email (ntuk Notifikasi)" type="email" />
                        </div>

                        <!-- WhatsApp (NEW) -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1.5"
                                for="phone_wa">WhatsApp</label>
                            <input
                                class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all placeholder:text-slate-400"
                                id="phone_wa" placeholder="Nomor WhatsApp (misal: 081234567890)" type="text" />
                        </div>

                        <!-- Role -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1.5" for="role">Role</label>
                            <div class="relative">
                                <select
                                    class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all appearance-none cursor-pointer bg-white"
                                    id="role" required>
                                    <option value="">-- Pilih Role --</option>
                                    <option value="admin_pusat">Admin Pusat</option>
                                    <option value="admin_cabang">Admin Cabang</option>
                                    <option value="petugas">Petugas Inspeksi</option>
                                    <option value="viewer">Viewer</option>
                                </select>
                                <span
                                    class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500">expand_more</span>
                            </div>
                        </div>

                        <!-- Cabang / Divisi (Editable Input) -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-slate-700 mb-1.5" for="unit">Cabang /
                                Divisi</label>
                            <input
                                class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all placeholder:text-slate-400"
                                id="unit" placeholder="Ketik nama Cabang atau Divisi" type="text" required />
                            <p class="text-[11px] text-slate-500 mt-1 ml-1">*Ketik manual nama unit kerja pengguna</p>
                        </div>
                    </div>
            </div>

            <!-- Modal Body End -> Footer Start -->
            <div class="px-8 py-5 bg-slate-50 border-t border-slate-100 flex justify-end gap-3 shrink-0">
                <button type="button" onclick="closeAddAksesModal()"
                    class="px-6 py-2.5 text-sm font-semibold text-slate-600 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors">
                    Batal
                </button>
                <button type="submit" form="formTambahAkses"
                    class="px-8 py-2.5 text-sm font-semibold text-white bg-primary hover:bg-blue-900 rounded-lg shadow-md transition-all">
                    Simpan
                </button>
            </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        const API = 'http://localhost:3000/api';
        let currentUser = null;
        let offerItems = [];

        // ===== API HELPER =====
        async function api(endpoint, method = 'GET', body = null) {
            const opts = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) opts.body = JSON.stringify(body);
            const res = await fetch(API + endpoint, opts);
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'API Error');
            return data;
        }

        // ===== LOAD PUBLIC MONITORING TABLE =====
        async function loadMonitoringTable() {
            try {
                const requests = await api('/requests');
                const tbody = document.querySelector('#public-content-monitoring table tbody');
                if (!tbody) return;
                tbody.innerHTML = '';
                requests.forEach(r => {
                    const stMap = {
                        'New Request': { color: 'orange', label: 'Review Admin' },
                        'Reviewing': { color: 'blue', label: 'Reviewing' },
                        'Negotiation': { color: 'amber', label: 'Negosiasi' },
                        'Deal': { color: 'emerald', label: 'Deal / PO' },
                        'Rejected': { color: 'rose', label: 'Rejected' },
                        'Uncompleted Data': { color: 'rose', label: 'Data Tidak Lengkap' }
                    };
                    const st = stMap[r.Status] || stMap['New Request'];

                    let actionBtn = `<button onclick="openPublicChatModal(${r.RequestID}, '${r.TicketNumber}')" class="p-1.5 rounded-lg text-primary bg-blue-50 hover:bg-primary hover:text-white transition-all flex items-center" title="Chat"><span class="material-symbols-outlined text-[18px]">chat_bubble</span></button>`;
                    if (r.Status === 'Negotiation' || r.Status === 'Reviewing') {
                        actionBtn = `<button onclick="openPublicRespondModal(${r.RequestID}, '${(r.TicketNumber || '').replace(/'/g, "\\'")}')" class="px-3 py-1.5 rounded-lg text-xs font-bold text-amber-600 bg-amber-50 hover:bg-amber-100 border border-amber-200 transition-all flex items-center gap-1" title="Respond"><span class="material-symbols-outlined text-[16px]">reply</span> Respond</button>`;
                    } else if (r.Status === 'Uncompleted Data') {
                        actionBtn = `<button onclick="openCompleteDataModal(${r.RequestID}, '${(r.TicketNumber || '').replace(/'/g, "\\'")}')" class="px-3 py-1.5 rounded-lg text-xs font-bold text-rose-600 bg-rose-50 hover:bg-rose-100 border border-rose-200 transition-all flex items-center gap-1" title="Lengkapi Data"><span class="material-symbols-outlined text-[16px]">edit_document</span> Lengkapi Data</button>`;
                    }

                    tbody.innerHTML += `<tr class="hover:bg-slate-50/50 transition-colors group">
                        <td class="px-6 py-5 font-semibold text-slate-700">${r.CompanyName || r.GuestName || '-'}</td>
                        <td class="px-6 py-5 text-sm text-slate-500 font-mono">${r.TicketNumber || '#REQ-' + r.RequestID}</td>
                        <td class="px-6 py-5 text-sm text-slate-600">${r.ServiceName || '-'}</td>
                        <td class="px-6 py-5 text-center"><span class="px-3 py-1.5 rounded-full text-[10px] font-bold text-${st.color}-600 bg-${st.color}-50 border border-${st.color}-100 uppercase tracking-wider inline-block min-w-[100px]">${st.label}</span></td>
                        <td class="px-6 py-5 text-center"><div class="flex items-center justify-center gap-2">
                        ${actionBtn}
                        </div></td></tr>`;
                });
                // Update stats
                const stats = await api('/dashboard/stats');
                const cards = document.querySelectorAll('#public-content-monitoring .grid h3');
                if (cards[0]) cards[0].textContent = stats.totalRequests;
                if (cards[1]) cards[1].textContent = stats.inProcess;
                if (cards[2]) cards[2].textContent = stats.deal;
            } catch (e) { console.error('Load monitoring:', e); }
        }

        // ===== LOAD ADMIN REQUESTS TABLE =====
        let adminRequestsData = [];
        let adminRequestsCurrentPage = 1;
        const adminRequestsPerPage = 5;
        let adminRequestsSortBy = 'Terbaru';
        let adminRequestsFilterSearch = '';
        let adminRequestsFilterStatus = 'All';

        async function loadAdminRequests(statusFilter) {
            try {
                if (statusFilter !== undefined) {
                    adminRequestsFilterStatus = statusFilter;
                    adminRequestsCurrentPage = 1;
                }
                const requests = await api('/requests');
                adminRequestsData = requests; // stores all
                applyAdminRequestsFilters();
            } catch (e) {
                console.error('Load requests:', e);
            }
        }

        function applyAdminRequestsFilters() {
            let filtered = [...adminRequestsData];

            // Filter Status
            if (adminRequestsFilterStatus && adminRequestsFilterStatus !== 'All') {
                filtered = filtered.filter(r => r.Status === adminRequestsFilterStatus);
            }

            // Search Filter
            if (adminRequestsFilterSearch) {
                const q = adminRequestsFilterSearch.toLowerCase();
                filtered = filtered.filter(r =>
                    (r.CompanyName && r.CompanyName.toLowerCase().includes(q)) ||
                    (r.GuestName && r.GuestName.toLowerCase().includes(q)) ||
                    (r.TicketNumber && r.TicketNumber.toLowerCase().includes(q)) ||
                    (r.ServiceName && r.ServiceName.toLowerCase().includes(q)) ||
                    (String(r.RequestID).includes(q))
                );
            }

            // Sort
            if (adminRequestsSortBy === 'Terbaru') {
                filtered.sort((a, b) => new Date(b.CreatedAt || 0) - new Date(a.CreatedAt || 0));
            } else if (adminRequestsSortBy === 'Terlama') {
                filtered.sort((a, b) => new Date(a.CreatedAt || 0) - new Date(b.CreatedAt || 0));
            } else if (adminRequestsSortBy === 'Nilai Tertinggi') {
                filtered.sort((a, b) => (b.TotalPrice || 0) - (a.TotalPrice || 0));
            } else if (adminRequestsSortBy === 'Nilai Terendah') {
                filtered.sort((a, b) => (a.TotalPrice || 0) - (b.TotalPrice || 0));
            }

            renderAdminRequestsTable(filtered);
        }

        function renderAdminRequestsTable(filtered) {
            const tbody = document.getElementById('adminRequestsBody');
            if (!tbody) return;

            const total = filtered.length;
            const totalPages = Math.ceil(total / adminRequestsPerPage) || 1;
            if (adminRequestsCurrentPage > totalPages) adminRequestsCurrentPage = totalPages;

            const startIdx = (adminRequestsCurrentPage - 1) * adminRequestsPerPage;
            const endIdx = startIdx + adminRequestsPerPage;
            const paginated = filtered.slice(startIdx, endIdx);

            tbody.innerHTML = '';
            if (paginated.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400 italic">Tidak ada permintaan ditemukan.</td></tr>`;
            } else {
                paginated.forEach(r => {
                    const initials = (r.CompanyName || r.GuestName || 'XX').split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
                    const colors = ['blue', 'purple', 'orange', 'emerald', 'cyan', 'rose'];
                    const clr = colors[r.RequestID % colors.length];
                    const stMap = { 'New Request': 'amber', 'Reviewing': 'slate', 'Negotiation': 'amber', 'Deal': 'emerald', 'Rejected': 'rose', 'Request Data': 'blue' };
                    const stClr = stMap[r.Status] || 'amber';

                    const ticket = r.TicketNumber || 'REQ-' + r.RequestID;
                    tbody.innerHTML += `<tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-6 py-4"><div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-${clr}-100 flex items-center justify-center text-${clr}-600 font-bold text-xs">${initials}</div>
                            <div><div class="font-bold text-slate-800">${r.CompanyName || r.GuestName || '-'}</div>
                            <div class="text-[10px] text-slate-400">ID: ${ticket}</div></div></div></td>
                        <td class="px-6 py-4 text-slate-600">${r.ServiceName || '-'}</td>
                        <td class="px-6 py-4 text-center"><span id="badge-REQ-${r.RequestID}" class="px-2.5 py-1 rounded-full text-[10px] font-bold bg-${stClr}-50 text-${stClr}-600 border border-${stClr}-100 uppercase tracking-wide">${r.Status}</span></td>
                        <td class="px-6 py-4 text-center"><div class="flex items-center justify-center gap-1.5">
                            <button onclick="openNewRequestModal(${r.RequestID})" class="p-1.5 rounded-lg text-slate-500 hover:bg-slate-100 hover:text-primary transition-all" title="Detail"><span class="material-symbols-outlined text-[20px]">visibility</span></button>
                            <button onclick="negotiateRequestById(${r.RequestID})" class="p-1.5 rounded-lg text-amber-500 hover:bg-amber-50 hover:text-amber-700 transition-all" title="Negosiasi"><span class="material-symbols-outlined text-[20px]">handshake</span></button>
                            <button onclick="acceptRequest(${r.RequestID})" class="p-1.5 rounded-lg text-emerald-500 hover:bg-emerald-50 hover:text-emerald-700 transition-all" title="Terima"><span class="material-symbols-outlined text-[20px]">check_circle</span></button>
                            <button onclick="rejectRequest(${r.RequestID})" class="p-1.5 rounded-lg text-rose-500 hover:bg-rose-50 hover:text-rose-700 transition-all" title="Tolak"><span class="material-symbols-outlined text-[20px]">cancel</span></button>
                        </div></td></tr>`;
                });
            }

            renderAdminRequestsPagination(total, startIdx, Math.min(endIdx, total), totalPages);
        }

        function renderAdminRequestsPagination(total, startIdx, endIdx, totalPages) {
            const container = document.getElementById('adminRequestsPaginationContainer');
            if (!container) return;

            if (total === 0) {
                container.innerHTML = '<p class="text-xs text-slate-500">Showing 0 results</p>';
                return;
            }

            let html = `
                <p class="text-xs text-slate-500">Showing <span class="font-bold text-slate-800">${startIdx + 1}-${endIdx}</span>
                    of <span class="font-bold text-slate-800">${total}</span> results</p>
                <div class="flex gap-1">
                    <button onclick="adminRequestsCurrentPage = Math.max(1, adminRequestsCurrentPage - 1); applyAdminRequestsFilters();"
                        class="w-8 h-8 flex items-center justify-center rounded-lg border border-slate-200 text-slate-400 hover:bg-slate-50 hover:text-primary transition-all disabled:opacity-50" ${adminRequestsCurrentPage === 1 ? 'disabled' : ''}>
                        <span class="material-symbols-outlined text-[16px]">chevron_left</span>
                    </button>
            `;

            for (let i = 1; i <= totalPages; i++) {
                if (i === adminRequestsCurrentPage) {
                    html += `<button class="w-8 h-8 flex items-center justify-center rounded-lg bg-primary text-white text-xs font-bold shadow-md shadow-primary/20">${i}</button>`;
                } else {
                    html += `<button onclick="adminRequestsCurrentPage = ${i}; applyAdminRequestsFilters();" class="w-8 h-8 flex items-center justify-center rounded-lg border border-slate-200 text-slate-600 text-xs font-bold hover:bg-slate-50 hover:text-primary transition-all">${i}</button>`;
                }
            }

            html += `
                    <button onclick="adminRequestsCurrentPage = Math.min(${totalPages}, adminRequestsCurrentPage + 1); applyAdminRequestsFilters();"
                        class="w-8 h-8 flex items-center justify-center rounded-lg border border-slate-200 text-slate-400 hover:bg-slate-50 hover:text-primary transition-all disabled:opacity-50" ${adminRequestsCurrentPage === totalPages ? 'disabled' : ''}>
                        <span class="material-symbols-outlined text-[16px]">chevron_right</span>
                    </button>
                </div>
            `;
            container.innerHTML = html;
        }

        // ===== ACCEPT / REJECT =====
        async function acceptRequest(id) {
            if (!confirm('Terima permintaan ini?')) return;
            try { await api('/requests/' + id, 'PUT', { Status: 'Reviewing' }); loadAdminRequests(); updateNewRequestBadge(); } catch (e) { alert('Error: ' + e.message); }
        }
        async function rejectRequest(id) {
            if (!confirm('Tolak permintaan ini?')) return;
            try { await api('/requests/' + id, 'PUT', { Status: 'Rejected' }); loadAdminRequests(); updateNewRequestBadge(); } catch (e) { alert('Error: ' + e.message); }
        }

        // --- NEGOTIATE / ADMIN VIEW NEGOTIATION ---
        async function negotiateRequestById(id) {
            // Open admin negotiation review modal
            let modal = document.getElementById('adminNegoReviewModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'adminNegoReviewModal';
                modal.className = 'fixed inset-0 z-[99] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto m-4">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <div>
                                <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2"><span class="material-symbols-outlined text-amber-500">gavel</span> Review Negosiasi Klien</h2>
                                <p id="adminNegoSubtitle" class="text-xs text-slate-400 mt-1"></p>
                            </div>
                            <button onclick="closeAdminNegoReviewModal()" class="p-2 hover:bg-slate-100 rounded-xl transition-colors"><span class="material-symbols-outlined">close</span></button>
                        </div>
                        <div id="adminNegoContent" class="p-6 space-y-4"></div>
                        <div class="p-6 border-t border-slate-100 flex flex-col sm:flex-row justify-end gap-3">
                            <button onclick="adminRejectNego()" class="px-5 py-3 bg-rose-500 hover:bg-rose-600 text-white rounded-xl font-bold text-sm transition-all flex items-center gap-2"><span class="material-symbols-outlined text-lg">cancel</span> Reject</button>
                            <button onclick="adminReNegotiate()" class="px-5 py-3 bg-amber-500 hover:bg-amber-600 text-white rounded-xl font-bold text-sm transition-all flex items-center gap-2"><span class="material-symbols-outlined text-lg">sync</span> Negosiasi Ulang</button>
                            <button onclick="adminAcceptNegoDeal()" class="px-5 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold text-sm transition-all flex items-center gap-2 shadow-md"><span class="material-symbols-outlined text-lg">check_circle</span> Deal</button>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
            }
            window._adminNegoRequestId = id;
            const content = document.getElementById('adminNegoContent');
            const subtitle = document.getElementById('adminNegoSubtitle');
            if (content) content.innerHTML = '<p class="text-center text-slate-400 py-8">Memuat data negosiasi...</p>';
            modal.classList.remove('hidden');
            try {
                const data = await api('/requests/' + id);
                if (subtitle) subtitle.textContent = `${data.CompanyName || 'Klien'} \u2014 ${data.TicketNumber || 'REQ-' + data.RequestID}`;
                let html = '';
                const originalPrice = data.GrandTotal || 0;
                html += `<div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-semibold text-blue-700">Harga Penawaran Awal (PTSI)</span>
                        <span class="text-lg font-bold text-blue-800">Rp ${originalPrice.toLocaleString('id-ID')}</span>
                    </div>
                </div>`;
                if (data.negotiations && data.negotiations.length > 0) {
                    html += `<div class="space-y-3"><h3 class="text-sm font-bold text-slate-700 flex items-center gap-2"><span class="material-symbols-outlined text-amber-500 text-lg">history</span> Riwayat Negosiasi</h3>`;
                    data.negotiations.forEach((n, i) => {
                        const isClient = n.ProposedBy === 'Client';
                        const color = isClient ? 'amber' : 'blue';
                        const diff = n.ProposedTotal - originalPrice;
                        const diffPct = originalPrice > 0 ? ((diff / originalPrice) * 100).toFixed(1) : 0;
                        html += `<div class="bg-${color}-50/50 rounded-xl p-4 border border-${color}-200">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-bold text-${color}-600 uppercase">${isClient ? 'Klien' : 'Admin PTSI'} \u2014 Ronde ${n.Round || (i + 1)}</span>
                                <span class="text-xs text-slate-400">${new Date(n.NegotiationDate).toLocaleDateString('id-ID')}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-slate-600">Harga Diajukan</span>
                                <div class="text-right">
                                    <span class="text-lg font-bold text-${color}-800">Rp ${Number(n.ProposedTotal).toLocaleString('id-ID')}</span>
                                    <span class="text-xs ml-2 ${diff < 0 ? 'text-emerald-600' : 'text-rose-600'}">(${diff >= 0 ? '+' : ''}${diffPct}%)</span>
                                </div>
                            </div>
                            ${n.Notes ? `<p class="text-xs text-slate-500 mt-2 italic">"${n.Notes}"</p>` : ''}
                        </div>`;
                    });
                    html += `</div>`;
                } else {
                    html += `<div class="bg-slate-50 rounded-xl p-4 border border-slate-200 text-center"><p class="text-sm text-slate-400 italic">Belum ada riwayat negosiasi.</p></div>`;
                }
                content.innerHTML = html;
            } catch (e) {
                if (content) content.innerHTML = '<p class="text-center text-rose-400 py-8">Gagal: ' + e.message + '</p>';
            }
        }
        function closeAdminNegoReviewModal() {
            const modal = document.getElementById('adminNegoReviewModal');
            if (modal) modal.classList.add('hidden');
        }
        async function adminAcceptNegoDeal() {
            if (!window._adminNegoRequestId) return;
            if (!confirm('Terima negosiasi ini dan ubah status menjadi DEAL?')) return;
            try {
                await api('/requests/' + window._adminNegoRequestId + '/status', 'PUT', { Status: 'Deal', ChangedBy: 'Admin' });
                alert('Status diubah menjadi Deal!');
                closeAdminNegoReviewModal();
                loadAdminRequests();
                updateNewRequestBadge();
            } catch (e) { alert('Error: ' + e.message); }
        }
        async function adminRejectNego() {
            if (!window._adminNegoRequestId) return;
            if (!confirm('Tolak negosiasi ini? Status akan diubah menjadi REJECTED.')) return;
            try {
                await api('/requests/' + window._adminNegoRequestId + '/status', 'PUT', { Status: 'Rejected', ChangedBy: 'Admin' });
                alert('Negosiasi ditolak.');
                closeAdminNegoReviewModal();
                loadAdminRequests();
                updateNewRequestBadge();
            } catch (e) { alert('Error: ' + e.message); }
        }
        async function adminReNegotiate() {
            closeAdminNegoReviewModal();
            let modal = document.getElementById('adminReNegoModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'adminReNegoModal';
                modal.className = 'fixed inset-0 z-[99] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto m-4">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <div>
                                <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2"><span class="material-symbols-outlined text-blue-600">sync_alt</span> Negosiasi Ulang</h2>
                                <p class="text-xs text-slate-400 mt-1">Kirim harga counter-offer ke klien</p>
                            </div>
                            <button onclick="document.getElementById('adminReNegoModal').classList.add('hidden')" class="p-2 hover:bg-slate-100 rounded-xl transition-colors"><span class="material-symbols-outlined">close</span></button>
                        </div>
                        <div class="p-6 space-y-4">
                            <div class="space-y-2">
                                <label class="text-sm font-bold text-slate-700">Harga Counter-Offer Admin</label>
                                <input type="number" id="adminReNegoPrice" class="w-full px-4 py-3 border border-blue-200 rounded-xl text-lg font-bold focus:ring-2 focus:ring-blue-300/30 focus:border-blue-400 outline-none" placeholder="Masukkan harga counter-offer" />
                            </div>
                            <div class="space-y-2">
                                <label class="text-sm font-bold text-slate-700">Catatan / Justifikasi</label>
                                <textarea id="adminReNegoNotes" rows="3" class="w-full px-4 py-3 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-300/30 outline-none resize-none" placeholder="Jelaskan alasan counter-offer..."></textarea>
                            </div>
                        </div>
                        <div class="p-6 border-t border-slate-100 flex justify-end gap-3">
                            <button onclick="document.getElementById('adminReNegoModal').classList.add('hidden')" class="px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold text-sm transition-all">Batal</button>
                            <button onclick="submitAdminReNegotiation()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold text-sm transition-all flex items-center gap-2 shadow-md"><span class="material-symbols-outlined text-lg">send</span> Kirim Counter-Offer</button>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
            }
            modal.classList.remove('hidden');
        }
        async function submitAdminReNegotiation() {
            if (!window._adminNegoRequestId) return;
            const proposedPrice = parseFloat(document.getElementById('adminReNegoPrice')?.value || 0);
            const notes = document.getElementById('adminReNegoNotes')?.value || '';
            if (proposedPrice <= 0) return alert('Masukkan harga counter-offer yang valid.');
            try {
                await api('/requests/' + window._adminNegoRequestId + '/negotiations', 'POST', {
                    ProposedBy: 'Admin',
                    ProposedPrice: proposedPrice,
                    Notes: notes
                });
                await api('/requests/' + window._adminNegoRequestId + '/status', 'PUT', { Status: 'Reviewing', ChangedBy: 'Admin' });
                alert('Counter-offer berhasil dikirim ke klien!');
                document.getElementById('adminReNegoModal').classList.add('hidden');
                loadAdminRequests();
            } catch (e) { alert('Gagal: ' + e.message); }
        }

        // ===== LOAD ADMIN SERVICES TABLE =====
        async function loadServicesTable() {
            try {
                const services = await api('/services');
                const tbody = document.querySelector('#admin-content-pricing table.w-full tbody');
                if (!tbody) return;
                tbody.innerHTML = '';
                services.forEach(s => {
                    tbody.innerHTML += `<tr class="group hover:bg-slate-50 transition-colors">
                        <td class="py-3 text-slate-600 font-medium">${s.ServiceName}</td>
                        <td class="py-3 font-bold text-slate-800">${s.PortfolioName || '-'}</td>
                        <td class="py-3"><span class="bg-cyan-100 text-cyan-700 px-2 py-0.5 rounded text-[10px] font-bold tracking-wide">AVAILABLE</span></td>
                        <td class="py-3 text-right"><div class="flex items-center justify-end gap-1">
                            <button onclick="openEditServiceModal('${s.ServiceName.replace(/'/g, "\\'")}','${(s.PortfolioName || '').replace(/'/g, "\\'")}'); editingServiceId=${s.ServiceID}" class="p-1.5 text-slate-400 hover:text-primary hover:bg-blue-50 rounded-lg transition-colors" title="Edit"><span class="material-symbols-outlined text-[18px]">edit</span></button>
                            <button onclick="deleteService(${s.ServiceID})" class="p-1.5 text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors" title="Hapus"><span class="material-symbols-outlined text-[18px]">delete</span></button>
                        </div></td></tr>`;
                });
            } catch (e) { console.error('Load services:', e); }
        }
        let editingServiceId = null;

        async function deleteService(id) {
            if (!confirm('Hapus layanan ini?')) return;
            try { await api('/services/' + id, 'DELETE'); loadServicesTable(); } catch (e) { alert('Error: ' + e.message); }
        }

        async function saveService(openParamModal = false) {
            const name = document.getElementById('editServiceName')?.value;
            const categoryName = document.getElementById('editServiceCategory')?.value;
            if (!name) return alert('Nama layanan wajib diisi');
            if (!categoryName) return alert('Sektor/Bidang wajib dipilih');
            try {
                let svcId = editingServiceId;
                if (svcId) {
                    await api('/services/' + svcId, 'PUT', { ServiceName: name, Description: '', CategoryName: categoryName });
                } else {
                    const newSvc = await api('/services', 'POST', { ServiceName: name, Description: '', CategoryName: categoryName });
                    svcId = newSvc.ServiceID;
                }
                window.currentParamServiceId = svcId; // Save for parameter modal

                closeEditServiceModal();
                if (!openParamModal) {
                    editingServiceId = null;
                }
                loadServicesTable();
                // Refresh service options in Create Offer form too
                loadServiceOptionsForOffer();

                return svcId;
            } catch (e) {
                alert('Error: ' + e.message);
                throw e;
            }
        }

        // ===== ADD PARAMETER TO CONTAINER =====
        async function addParameterToContainer(formEl) {
            if (!window.currentParamServiceId) {
                return alert('Service ID tidak ditemukan. Simpan layanan terlebih dahulu.');
            }
            const inputs = formEl.querySelectorAll('input');
            const select = formEl.querySelector('select');
            const name = inputs[0]?.value || 'Parameter Baru';
            const priceStr = inputs[1]?.value || '0';
            const price = parseFloat(priceStr.replace(/\./g, '').replace(/,/g, '')) || 0;
            const unit = select?.value || 'unit';

            try {
                const newParam = await api('/services/' + window.currentParamServiceId + '/parameters', 'POST', {
                    ParameterName: name,
                    UnitPrice: price
                });

                const container = document.getElementById('parameterBoxesContainer');
                if (!container) return;
                const box = document.createElement('div');
                box.className = 'param-box space-y-1.5 relative group border border-emerald-200 rounded-xl p-4 hover:border-emerald-300 transition-all bg-emerald-50/30';
                box.dataset.paramId = newParam.ParamID;
                box.innerHTML = `
                    <button type="button" onclick="deleteParameter(${newParam.ParamID}, this.closest('.param-box'))" class="absolute top-2 right-2 p-1 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all opacity-0 group-hover:opacity-100">
                        <span class="material-symbols-outlined !text-lg">close</span>
                    </button>
                    <label class="text-sm font-medium text-slate-700">${name} <span class="text-xs text-slate-400 font-normal">(Rp ${price.toLocaleString('id-ID')} / ${unit})</span></label>
                    <input class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-900 placeholder:text-slate-400 focus:ring-2 focus:ring-[#3498db]/20 focus:border-[#3498db] transition-all outline-none" placeholder="Masukkan jumlah..." type="number" value="0" readonly />
                `;
                container.appendChild(box);

                // Reset form fields
                inputs.forEach(inp => { if (!inp.readOnly) inp.value = ''; });
                if (select) select.selectedIndex = 0;
            } catch (e) {
                alert('Gagal menambah parameter: ' + e.message);
            }
        }

        // ===== LAINNYA DROPDOWN TOGGLE =====
        document.addEventListener('DOMContentLoaded', function () {
            const formSection = document.querySelector('#public-content-create section');
            if (formSection) {
                const jobSelect = formSection.querySelector('select');
                if (jobSelect) {
                    jobSelect.addEventListener('change', function () {
                        const customDesc = document.getElementById('customServiceDesc');
                        if (customDesc) {
                            if (this.value === 'lainnya') {
                                customDesc.classList.remove('hidden');
                            } else {
                                customDesc.classList.add('hidden');
                            }
                        }
                    });
                }
            }
        });
        function addOfferItem() {
            const serviceSelect = document.getElementById('offerServiceSelect');
            const paymentSelect = document.getElementById('offerPaymentTerms');
            if (!serviceSelect) return;
            let serviceType = serviceSelect.value || '';
            let serviceTypeText = serviceSelect.options[serviceSelect.selectedIndex]?.text || serviceType;
            if (serviceType === 'lainnya') {
                const customInput = document.getElementById('customServiceDesc')?.querySelector('textarea');
                serviceTypeText = customInput?.value || 'Lainnya';
            }
            if (!serviceType || serviceType === '') return alert('Pilih jenis pekerjaan terlebih dahulu');
            if (serviceType === 'lainnya' && serviceTypeText === 'Lainnya') return alert('Isi deskripsi layanan kustom terlebih dahulu');
            // Collect dynamic pricing parameter values with UnitPrice
            const paramRows = document.querySelectorAll('#dynamicParamInputs .param-price-row');
            let paramDetails = [];
            let paramValues = []; // For API submission
            let itemSubtotal = 0;
            paramRows.forEach(row => {
                const numInp = row.querySelector('.param-qty-input');
                const textInp = row.querySelector('.param-text-input');

                if (numInp) {
                    const qty = parseFloat(numInp.value) || 0;
                    const unitPrice = parseFloat(numInp.dataset.unitPrice) || 0;
                    const paramName = numInp.dataset.paramName || '';
                    const paramId = parseInt(numInp.dataset.paramId) || 0;
                    const sub = qty * unitPrice;
                    if (qty > 0) {
                        paramDetails.push(`${paramName}: ${qty} x Rp ${unitPrice.toLocaleString('id-ID')} = Rp ${sub.toLocaleString('id-ID')}`);
                        paramValues.push({ ParamID: paramId, InputValue: String(qty), CalculatedPrice: sub });
                        itemSubtotal += sub;
                    }
                } else if (textInp) {
                    const val = textInp.value.trim();
                    const paramName = textInp.dataset.paramName || '';
                    const paramId = parseInt(textInp.dataset.paramId) || 0;
                    if (val) {
                        paramDetails.push(`${paramName}: ${val}`);
                        paramValues.push({ ParamID: paramId, InputValue: val, CalculatedPrice: 0 });
                    }
                }
            });
            // Fallback for non-priced params
            if (paramRows.length === 0) {
                const paramInputs = document.querySelectorAll('#dynamicParamInputs input');
                paramInputs.forEach(inp => {
                    if (inp.value.trim()) paramDetails.push(inp.dataset.paramName + ': ' + inp.value.trim());
                });
            }
            const item = {
                ServiceType: serviceTypeText,
                ServiceID: serviceType,
                Location: paramDetails.length > 0 ? paramDetails.join('\n') : '-',
                Specification: '',
                WorkMethod: '',
                PaymentTerms: paymentSelect?.value || '1',
                paramValues: paramValues,
                SubTotal: itemSubtotal
            };
            offerItems.push(item);
            renderOfferItems();
            // Clear form
            serviceSelect.selectedIndex = 0;
            if (paymentSelect) paymentSelect.selectedIndex = 0;
            // Clear dynamic pricing fields
            const dynFields = document.getElementById('dynamicPricingFields');
            if (dynFields) dynFields.classList.add('hidden');
            const dynInputs = document.getElementById('dynamicParamInputs');
            if (dynInputs) dynInputs.innerHTML = '';
            const customDesc = document.getElementById('customServiceDesc');
            if (customDesc) { customDesc.classList.add('hidden'); const ta = customDesc.querySelector('textarea'); if (ta) ta.value = ''; }
        }

        function removeOfferItem(idx) {
            offerItems.splice(idx, 1);
            renderOfferItems();
        }

        function renderOfferItems() {
            const tbody = document.getElementById('offerItemsBody');
            const emptyState = document.getElementById('offerItemsEmptyState');
            if (!tbody) return;
            tbody.innerHTML = '';

            if (offerItems.length === 0) {
                if (emptyState) emptyState.classList.remove('hidden');
                return;
            } else {
                if (emptyState) emptyState.classList.add('hidden');
            }

            let grandTotal = 0;
            offerItems.forEach((item, i) => {
                grandTotal += item.SubTotal || 0;
                const locationHtml = (item.Location || '-').replace(/\n/g, '<br>');
                tbody.innerHTML += `<tr class="hover:bg-slate-50/50 transition-colors group">
                    <td class="px-6 py-4 font-semibold text-slate-700">${item.ServiceType}</td>
                    <td class="px-6 py-4 text-slate-600 text-xs">${locationHtml}</td>
                    <td class="px-6 py-4 text-slate-600 font-bold text-right">${item.SubTotal > 0 ? 'Rp ' + item.SubTotal.toLocaleString('id-ID') : '-'}</td>
                    <td class="px-6 py-4 text-right"><button type="button" onclick="removeOfferItem(${i})" class="p-1.5 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all" title="Hapus"><span class="material-symbols-outlined !text-lg">delete</span></button></td></tr>`;
            });
            if (offerItems.length > 0 && grandTotal > 0) {
                tbody.innerHTML += `<tr class="bg-emerald-50/50 border-t-2 border-emerald-200">
                    <td colspan="2" class="px-6 py-4 text-right font-bold text-slate-700 uppercase text-xs tracking-wider">Total Estimasi Harga</td>
                    <td class="px-6 py-4 text-right font-bold text-lg text-emerald-700">Rp ${grandTotal.toLocaleString('id-ID')}</td>
                    <td></td></tr>`;
            }
        }

        // ===== PUBLIC FORM: SUBMIT REQUEST =====
        async function submitRequest() {
            const form = document.querySelector('#public-content-create');
            if (!form) return;
            const inputs = form.querySelectorAll('input');
            const selects = form.querySelectorAll('select');
            const textarea = form.querySelector('textarea:last-of-type');
            const companyName = inputs[0]?.value;
            const picName = inputs[1]?.value;
            const email = inputs[2]?.value;
            const phone = inputs[3]?.value;
            if (!companyName) return alert('Nama perusahaan wajib diisi');
            try {
                const serviceIdFromItems = offerItems.length > 0 ? parseInt(offerItems[0].ServiceID) : null;
                const body = {
                    CompanyName: companyName, PICName: picName, PICEmail: email, PICPhone: phone,
                    GuestName: picName, GuestPhone: phone,
                    ServiceID: isNaN(serviceIdFromItems) ? null : serviceIdFromItems,
                    PaymentTerms: parseInt(selects[2]?.value) || 1,
                    AdditionalNotes: textarea?.value || '',
                    items: offerItems.map(it => ({
                        ServiceType: it.ServiceType, Location: it.Location,
                        Specification: it.Specification, WorkMethod: it.WorkMethod
                    }))
                };
                const result = await api('/requests', 'POST', body);
                alert('Permintaan berhasil dikirim! Ticket: ' + (result.TicketNumber || result.RequestID));
                // Reset form
                inputs.forEach(i => i.value = '');
                if (textarea) textarea.value = '';
                offerItems = [];
                renderOfferItems();
                switchPublicSection('monitoring');
                loadMonitoringTable();
            } catch (e) { alert('Gagal mengirim: ' + e.message); }
        }

        // ===== ADMIN: SEND PENAWARAN FROM MODAL =====
        async function sendPenawaran() {
            if (!currentNewRequestID) return;
            const reqId = currentNewRequestID.replace('REQ-', '');
            try {
                await api('/requests/' + reqId, 'PUT', { Status: 'Deal' });
                alert('Penawaran Terkirim!');
                closeNewRequestModal();
                loadAdminRequests();
            } catch (e) { alert('Error: ' + e.message); }
        }

        // ===== LOAD USERS TABLE =====
        async function loadUsersTable() {
            try {
                const users = await api('/users');
                const tbody = document.querySelector('#content-config-akses tbody');
                if (!tbody) return;
                tbody.innerHTML = '';
                users.forEach(u => {
                    tbody.innerHTML += `<tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-6 py-4 font-bold text-slate-800">${u.FullName}</td>
                        <td class="px-6 py-4 text-slate-600">${u.Username}</td>
                        <td class="px-6 py-4 text-slate-600">${u.Role}</td>
                        <td class="px-6 py-4 text-slate-600">${u.PortfolioName || '-'}</td>
                        <td class="px-6 py-4 text-right"><button onclick="deleteUser(${u.UserID})" class="p-1.5 text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors"><span class="material-symbols-outlined text-[18px]">delete</span></button></td></tr>`;
                });
            } catch (e) { console.error('Load users:', e); }
        }

        async function deleteUser(id) {
            if (!confirm('Hapus user ini?')) return;
            try { await api('/users/' + id, 'DELETE'); loadUsersTable(); } catch (e) { alert('Error: ' + e.message); }
        }

        async function saveNewUser() {
            const modal = document.getElementById('addAksesModal');
            if (!modal) return;
            const inputs = modal.querySelectorAll('input');
            const selects = modal.querySelectorAll('select');
            try {
                await api('/users', 'POST', {
                    FullName: inputs[0]?.value || '',
                    Username: inputs[1]?.value || '',
                    PasswordHash: inputs[2]?.value || '',
                    Role: selects[0]?.value || 'AdminDBS',
                    PortfolioID: parseInt(selects[1]?.value) || null
                });
                closeAddAksesModal();
                loadUsersTable();
            } catch (e) { alert('Error: ' + e.message); }
        }

        // ===== INIT: Load data on page ready =====
        document.addEventListener('DOMContentLoaded', () => {
            loadMonitoringTable();
            // Feature 3: Pre-load service options for the public Create Offer form
            loadServiceOptionsForOffer();
        });

        function toggleLoginModal() {
            const modal = document.getElementById('loginModal');
            if (modal) modal.classList.toggle('hidden');
        }
        function switchToPublicView() {
            const landing = document.getElementById('view-landing');
            const admin = document.getElementById('view-admin');
            const pub = document.getElementById('view-public');
            if (landing) landing.classList.add('hidden-view');
            if (admin) admin.classList.add('hidden-view');
            if (pub) pub.classList.remove('hidden-view');
            switchPublicSection('monitoring');
        }
        function switchToLandingView() {
            const landing = document.getElementById('view-landing');
            const admin = document.getElementById('view-admin');
            const pub = document.getElementById('view-public');
            if (pub) pub.classList.add('hidden-view');
            if (admin) admin.classList.add('hidden-view');
            if (landing) landing.classList.remove('hidden-view');
        }
        async function handleDemoLogin(e) {
            e.preventDefault();
            const form = document.getElementById('loginModal');
            const inputs = form ? form.querySelectorAll('input') : [];
            const username = inputs[0]?.value || '';
            const password = inputs[1]?.value || '';
            try {
                currentUser = await api('/login', 'POST', { username, password });
                toggleLoginModal();
                const landing = document.getElementById('view-landing');
                const admin = document.getElementById('view-admin');
                const pub = document.getElementById('view-public');
                if (landing) landing.classList.add('hidden-view');
                if (pub) pub.classList.add('hidden-view');
                if (admin) admin.classList.remove('hidden-view');
                // Feature 1: Hide Configuration for non-SuperAdmin users
                const configWrapper = document.getElementById('nav-configuration-wrapper');
                if (configWrapper) {
                    if (currentUser.Role !== 'SuperAdmin') {
                        configWrapper.style.display = 'none';
                    } else {
                        configWrapper.style.display = '';
                    }
                }
                // Update admin header with user info
                const adminNameEl = document.querySelector('#view-admin header .text-sm.font-bold');
                if (adminNameEl) adminNameEl.textContent = currentUser.FullName || 'Administrator';
                const adminRoleEl = document.querySelector('#view-admin header .text-xs.text-slate-500');
                if (adminRoleEl) adminRoleEl.textContent = currentUser.Role || 'Admin';
                switchAdminSection('dashboard');
            } catch (err) {
                alert('Login gagal: ' + err.message);
            }
        }
        function showLogoutModal() {
            const modal = document.getElementById('logoutModal');
            if (modal) modal.classList.remove('hidden');
        }
        function closeLogoutModal() {
            const modal = document.getElementById('logoutModal');
            if (modal) modal.classList.add('hidden');
        }
        function confirmLogout() { closeLogoutModal(); switchToPublicView(); }

        // --- NEW: ADMIN CONFIGURATION MODAL ---
        function openAdminConfigModal() {
            const modal = document.getElementById('adminConfigModal');
            if (modal) {
                if (typeof currentUser !== 'undefined' && currentUser) {
                    document.getElementById('adminConfigFullName').value = currentUser.FullName || '';
                    document.getElementById('adminConfigEmail').value = currentUser.Email || '';
                    document.getElementById('adminConfigDisplayTitle').textContent = currentUser.FullName || 'Admin';
                    document.getElementById('adminConfigDisplayRole').textContent = currentUser.Role || 'Administrator';
                    document.getElementById('adminConfigCurrPass').value = '';
                    document.getElementById('adminConfigNewPass').value = '';
                    document.getElementById('adminConfigConfPass').value = '';

                    const src = localStorage.getItem('sioneProfileImg');
                    if (src) {
                        document.getElementById('adminConfigProfileImg').src = src;
                        document.getElementById('adminConfigProfileImg').classList.remove('hidden');
                        document.getElementById('adminConfigProfileIcon').classList.add('hidden');
                    }
                }
                modal.classList.remove('hidden');
            }
        }

        async function saveAdminConfig() {
            const name = document.getElementById('adminConfigFullName') ? document.getElementById('adminConfigFullName').value : '';
            const email = document.getElementById('adminConfigEmail') ? document.getElementById('adminConfigEmail').value : '';
            const currP = document.getElementById('adminConfigCurrPass') ? document.getElementById('adminConfigCurrPass').value : '';
            const newP = document.getElementById('adminConfigNewPass') ? document.getElementById('adminConfigNewPass').value : '';
            const confP = document.getElementById('adminConfigConfPass') ? document.getElementById('adminConfigConfPass').value : '';

            if (newP || confP) {
                if (newP !== confP) return alert('Konfirmasi password baru tidak cocok!');
                if (!currP) return alert('Masukkan password saat ini untuk mengganti password!');
            }
            // we simulate saving
            alert('Pengaturan Admin berhasil disimpan!');

            if (typeof currentUser !== 'undefined' && currentUser) {
                currentUser.FullName = name;
                currentUser.Email = email;

                // update sidebar or header if it shows name
                const headerEls = document.querySelectorAll('header .text-slate-700');
                headerEls.forEach(el => {
                    if (el.textContent.includes('Administrator') || el.textContent === currentUser.FullName) {
                        el.textContent = name;
                    }
                });
            }

            closeAdminConfigModal();
        }

        function previewAdminProfileImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        localStorage.setItem('sioneProfileImg', e.target.result);
                    } catch (err) {
                        console.error('Failed to save to localstorage', err);
                    }
                    if (document.getElementById('adminConfigProfileImg')) {
                        document.getElementById('adminConfigProfileImg').src = e.target.result;
                        document.getElementById('adminConfigProfileImg').classList.remove('hidden');
                    }
                    if (document.getElementById('adminConfigProfileIcon')) {
                        document.getElementById('adminConfigProfileIcon').classList.add('hidden');
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        function togglePasswordVisibility(id, btn) {
            const input = document.getElementById(id);
            if (!input) return;
            if (input.type === 'password') {
                input.type = 'text';
                btn.innerHTML = '<span class="material-symbols-outlined text-[20px]">visibility</span>';
            } else {
                input.type = 'password';
                btn.innerHTML = '<span class="material-symbols-outlined text-[20px]">visibility_off</span>';
            }
        }

        function closeAdminConfigModal() {
            const modal = document.getElementById('adminConfigModal');
            if (modal) modal.classList.add('hidden');
        }

        // Ensure all references are safe to prevent TypeError: Cannot read properties of null
        function switchPublicSection(id) {
            ['monitoring', 'create'].forEach(sid => {
                let el = document.getElementById('public-content-' + sid);
                if (el) el.classList.add('hidden');
            });
            let target = document.getElementById('public-content-' + id);
            if (target) target.classList.remove('hidden');

            document.querySelectorAll('.sidebar-item-public').forEach(el => {
                el.classList.remove('active');
                el.classList.add('text-slate-500');
            });

            let nav = document.getElementById('pub-nav-' + id);
            if (nav) {
                nav.classList.add('active');
                nav.classList.remove('text-slate-500');
            }
            // Auto-load data
            if (id === 'monitoring') loadMonitoringTable();
            if (id === 'create') loadServiceOptionsForOffer();
        }

        function switchAdminSection(id) {
            ['dashboard', 'pricing', 'requests', 'monitoring', 'configuration'].forEach(sid => {
                const el = document.getElementById('admin-content-' + sid);
                if (el) el.classList.add('hidden');
            });
            const targetEl = document.getElementById('admin-content-' + id);
            if (targetEl) targetEl.classList.remove('hidden');

            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            const navEl = document.getElementById('nav-' + id);
            if (navEl) navEl.classList.add('active');

            const titles = {
                'dashboard': 'Executive Dashboard',
                'pricing': 'Monitoring & Pricing',
                'requests': 'Manajemen Permintaan',
                'monitoring': 'Monitoring Progres',
                'configuration': 'Konfigurasi Sistem'
            };
            const titleEl = document.getElementById('page-title');
            if (titleEl && titles[id]) titleEl.textContent = titles[id];
            // Auto-load data from DB for each section
            if (id === 'requests') { loadAdminRequests(); updateNewRequestBadge(); }
            if (id === 'pricing') loadServicesTable();
            if (id === 'configuration') { loadUsersTable(); loadBranchesTable(); }
            if (id === 'monitoring') loadMonitoringProgressCards();
            if (id === 'dashboard') { loadDashboardStats(); updateNewRequestBadge(); }
        }

        async function loadDashboardStats() {
            try {
                const stats = await api('/dashboard/stats');
                const cards = document.querySelectorAll('#admin-content-dashboard h3');
                if (cards[0]) cards[0].textContent = stats.totalRequests;
                if (cards[1]) cards[1].textContent = stats.inProcess;
                if (cards[2]) cards[2].textContent = stats.deal;
                if (cards[3]) cards[3].textContent = stats.rejected;
                // Feature 2: Load branch performance bars
                loadBranchPerformance();
            } catch (e) { console.error('Dashboard stats:', e); }
        }

        // ===== Feature 2: BRANCH PERFORMANCE BARS =====
        async function loadBranchPerformance() {
            try {
                const branches = await api('/branches/stats');
                const container = document.getElementById('branchPerformanceBars');
                if (!container) return;
                container.innerHTML = '';
                const colors = ['cyan', 'emerald', 'blue', 'indigo', 'violet', 'amber', 'rose', 'teal', 'sky', 'purple'];
                branches.forEach((b, i) => {
                    const color = colors[i % colors.length];
                    container.innerHTML += `
                        <div class="space-y-1.5">
                            <div class="flex justify-between text-xs font-semibold">
                                <span class="text-slate-600">Cabang ${b.BranchName}</span>
                                <span class="text-${color}-600">${b.Performance}%</span>
                            </div>
                            <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                                <div class="h-full bg-${color}-500 transition-all duration-700" style="width: ${b.Performance}%"></div>
                            </div>
                        </div>`;
                });
                if (branches.length === 0) {
                    container.innerHTML = '<p class="text-xs text-slate-400 italic">Belum ada data cabang.</p>';
                }
            } catch (e) {
                console.error('Branch performance:', e);
                const container = document.getElementById('branchPerformanceBars');
                if (container) container.innerHTML = '<p class="text-xs text-slate-400 italic">Tabel Branches belum tersedia di database.</p>';
            }
        }

        // ===== Feature 4: FILTER REQUESTS BY STATUS =====
        function filterRequests(status) {
            // Toggle active class on tab buttons
            const tabContainer = document.querySelector('#admin-content-requests .px-6.pt-4');
            if (tabContainer) {
                tabContainer.querySelectorAll('.tab-nav-item').forEach(btn => btn.classList.remove('active'));
                event.target.closest('.tab-nav-item')?.classList.add('active');
            }
            // Load filtered requests
            loadAdminRequests(status === 'All' ? null : status);
        }

        // ===== Feature 3: LOAD SERVICE OPTIONS FOR PUBLIC FORM =====
        async function loadServiceOptionsForOffer() {
            try {
                const services = await api('/services');
                const select = document.getElementById('offerServiceSelect');
                if (!select) return;
                // Keep first option (Pilih jenis...) and last (Lainnya)
                const firstOpt = select.querySelector('option[disabled]');
                const lainnyaOpt = select.querySelector('option[value="lainnya"]');
                select.innerHTML = '';
                if (firstOpt) select.appendChild(firstOpt);
                services.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.ServiceID;
                    opt.textContent = s.ServiceName;
                    select.appendChild(opt);
                });
                if (lainnyaOpt) select.appendChild(lainnyaOpt);
            } catch (e) { console.error('Load service options:', e); }
        }

        async function onOfferServiceSelected(serviceId) {
            const dynContainer = document.getElementById('dynamicPricingFields');
            const dynInputs = document.getElementById('dynamicParamInputs');
            if (!dynContainer || !dynInputs) return;

            // Handle Lainnya / custom
            const customDesc = document.getElementById('customServiceDesc');
            if (serviceId === 'lainnya') {
                if (customDesc) customDesc.classList.remove('hidden');
                dynContainer.classList.add('hidden');
                dynInputs.innerHTML = '';
                return;
            } else {
                if (customDesc) customDesc.classList.add('hidden');
            }

            if (!serviceId || serviceId === '') {
                dynContainer.classList.add('hidden');
                dynInputs.innerHTML = '';
                return;
            }

            try {
                const params = await api('/services/' + serviceId + '/parameters');
                dynInputs.innerHTML = '';
                if (params.length === 0) {
                    dynContainer.classList.add('hidden');
                    return;
                }
                dynContainer.classList.remove('hidden');
                params.forEach(p => {
                    const unitPrice = p.UnitPrice || 0;
                    if (unitPrice > 0) {
                        dynInputs.innerHTML += `
                            <div class="space-y-1 param-price-row" data-param-id="${p.ParamID}" data-param-name="${p.ParameterName}" data-unit-price="${unitPrice}">
                                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">${p.ParameterName}
                                    <span class="text-emerald-600 normal-case">(Rp ${Number(unitPrice).toLocaleString('id-ID')} / unit)</span>
                                </label>
                                <div class="flex items-center gap-2">
                                    <input type="number" min="0" data-param-id="${p.ParamID}" data-param-name="${p.ParameterName}" data-unit-price="${unitPrice}"
                                        class="param-qty-input flex-1 px-3 py-2 bg-white border border-emerald-200 rounded-lg focus:ring-2 focus:ring-emerald-300/30 focus:border-emerald-400 transition-all outline-none text-sm"
                                        placeholder="Jumlah" oninput="calcParamSubtotal(this)" />
                                    <span class="param-subtotal-display text-sm font-bold text-emerald-700 min-w-[120px] text-right">Rp 0</span>
                                </div>
                            </div>`;
                    } else {
                        dynInputs.innerHTML += `
                            <div class="space-y-1 param-price-row" data-param-id="${p.ParamID}" data-param-name="${p.ParameterName}" data-unit-price="0">
                                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">${p.ParameterName}</label>
                                <div class="flex items-center gap-2">
                                    <input type="text" data-param-id="${p.ParamID}" data-param-name="${p.ParameterName}" data-unit-price="0"
                                        class="param-text-input flex-1 px-3 py-2 bg-white border border-emerald-200 rounded-lg focus:ring-2 focus:ring-emerald-300/30 focus:border-emerald-400 transition-all outline-none text-sm"
                                        placeholder="Keterangan (misal: Lokasi...)" />
                                </div>
                            </div>`;
                    }
                });
                // Add portfolio total display
                dynInputs.innerHTML += `
                    <div class="pt-3 mt-3 border-t border-emerald-200 flex justify-between items-center">
                        <span class="text-xs font-bold text-slate-600 uppercase tracking-wider">Total Harga Portofolio</span>
                        <span id="portfolioTotalDisplay" class="text-lg font-bold text-emerald-700">Rp 0</span>
                    </div>`;
            } catch (e) { console.error('Load pricing params:', e); }
        }

        function calcParamSubtotal(inputEl) {
            const qty = parseFloat(inputEl.value) || 0;
            const unitPrice = parseFloat(inputEl.dataset.unitPrice) || 0;
            const subtotal = qty * unitPrice;
            const row = inputEl.closest('.param-price-row');
            if (row) {
                const display = row.querySelector('.param-subtotal-display');
                if (display) display.textContent = 'Rp ' + subtotal.toLocaleString('id-ID');
            }
            // Recalculate portfolio total
            let total = 0;
            document.querySelectorAll('.param-qty-input').forEach(inp => {
                const q = parseFloat(inp.value) || 0;
                const up = parseFloat(inp.dataset.unitPrice) || 0;
                total += q * up;
            });
            const totalDisplay = document.getElementById('portfolioTotalDisplay');
            if (totalDisplay) totalDisplay.textContent = 'Rp ' + total.toLocaleString('id-ID');
        }

        // ===== Feature 6: LOAD PORTFOLIO OPTIONS FOR SERVICE MODAL =====
        async function loadPortfolioOptions(selectedOwner, selectedCategory = '') {
            try {
                const portfolios = await api('/portfolios');
                const select = document.getElementById('editServiceOwner');
                if (!select) return;
                select.innerHTML = '<option value="">-- Pilih Divisi --</option>';
                portfolios.forEach(p => {
                    if (p.PortfolioName.toLowerCase().includes('lintas dbs')) return; // Exclude Lintas DBS
                    const opt = document.createElement('option');
                    opt.value = p.PortfolioName;
                    opt.textContent = p.PortfolioName;
                    if (selectedOwner && p.PortfolioName === selectedOwner) opt.selected = true;
                    select.appendChild(opt);
                });

                if (selectedOwner) {
                    loadCategoryOptions(selectedOwner, selectedCategory);
                } else {
                    const catSelect = document.getElementById('editServiceCategory');
                    if (catSelect) catSelect.innerHTML = '<option value="">-- Pilih Bidang / Sektor --</option>';
                }
            } catch (e) { console.error('Load portfolios:', e); }
        }

        async function loadCategoryOptions(portfolioName, selectedCategory = '') {
            try {
                const select = document.getElementById('editServiceCategory');
                if (!select) return;
                select.innerHTML = '<option value="">Memuat...</option>';
                if (!portfolioName) {
                    select.innerHTML = '<option value="">-- Pilih Bidang / Sektor --</option>';
                    return;
                }
                const excelCategoriesMapping = {
                    "DBS Oil Gas & Renewable Energy": [
                        "Infrastruktur (Sektor Migas & Panas Bumi)",
                        "Verifikasi",
                        "Survei Kebumian",
                        "Inspeksi Pengeboran",
                        "Konsultansi EBT",
                        "Sertifikasi Ketenagalistrikan"
                    ],
                    "DBS Sustainability & Environment": [
                        "Infrastruktur (Sektor Naker / Umum)",
                        "Konsultansi",
                        "Perizinan",
                        "SNE (Kelistrikan)"
                    ],
                    "DBS Coal & Mineral": [
                        "Marine Survey",
                        "Coal & Mineral Handling",
                        "Studi Kelayakan"
                    ],
                    "DBS Infrastructur & Transportasi": [
                        "Manajemen Aset",
                        "Engineering",
                        "Konstruksi",
                        "Infrastruktur Penunjang"
                    ],
                    "DBS Industrial Services": [
                        "Verifikasi",
                        "Sertifikasi"
                    ],
                    "Lintas DBS (Oil Gas / SNE)": [
                        "NDT"
                    ],
                    "DBS Government & Institution": [
                        "Konsultansi",
                        "Verifikasi"
                    ]
                };

                const filtered = excelCategoriesMapping[portfolioName] || [];

                select.innerHTML = '<option value="">-- Pilih Bidang / Sektor --</option>';
                filtered.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    if (selectedCategory && c === selectedCategory) opt.selected = true;
                    select.appendChild(opt);
                });
            } catch (e) { console.error('Load categories:', e); }
        }

        // ===== LOAD BRANCHES TABLE (Configuration tab) =====
        async function loadBranchesTable() {
            try {
                const branches = await api('/branches');
                const tbody = document.getElementById('branchesTableBody');
                const countInfo = document.getElementById('branchCountInfo');
                if (!tbody) return;
                tbody.innerHTML = '';
                if (branches.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400 italic">Belum ada data cabang.</td></tr>';
                    if (countInfo) countInfo.textContent = '0 cabang';
                    return;
                }
                branches.forEach((b, i) => {
                    const isHO = b.BranchID === 1 || b.BranchName.toLowerCase().includes('pusat');
                    // Use Phone as Code, Fax as Target (mapped from modal inputs)
                    const code = b.Phone || b.BranchName.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 4);
                    const location = b.Address || '-';
                    tbody.innerHTML += `<tr class="hover:bg-slate-50/80 transition-colors group">
                        <td class="px-6 py-4 font-semibold text-slate-800">
                            ${b.BranchName}
                            ${isHO ? '<span class="ml-2 px-1.5 py-0.5 bg-green-100 text-green-700 text-[10px] rounded uppercase">Active</span>' : ''}
                        </td>
                        <td class="px-6 py-4">
                            <span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-bold border border-blue-100">${code}</span>
                        </td>
                        <td class="px-6 py-4 text-slate-600">${location}</td>
                        <td class="px-6 py-4">
                            <div class="flex justify-center gap-2">
                                <button onclick="editBranch(${b.BranchID}, '${b.BranchName}', '${code}', '${location}', '${b.Fax || 0}')" class="p-1.5 text-amber-500 hover:bg-amber-50 rounded-lg transition-colors" title="Edit"><span class="material-symbols-outlined text-[20px]">edit</span></button>
                                <button onclick="deleteBranch(${b.BranchID})" class="p-1.5 text-rose-500 hover:bg-rose-50 rounded-lg transition-colors" title="Delete"><span class="material-symbols-outlined text-[20px]">delete</span></button>
                                <button class="p-1.5 text-primary hover:bg-blue-50 rounded-lg transition-colors" title="Target Desentralisasi"><span class="material-symbols-outlined text-[20px]">track_changes</span></button>
                            </div>
                        </td>
                    </tr>`;
                });
                if (countInfo) countInfo.textContent = `Menampilkan ${branches.length} cabang`;
            } catch (e) {
                console.error('Load branches:', e);
                const tbody = document.getElementById('branchesTableBody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-rose-400 italic">Gagal memuat data cabang.</td></tr>';
            }
        }

        // ===== UPDATE NEW REQUEST BADGE =====
        async function updateNewRequestBadge() {
            try {
                const requests = await api('/requests?status=New Request');
                const count = requests.length;
                // Sidebar badge
                const sidebarBadge = document.getElementById('sidebarNewRequestBadge');
                if (sidebarBadge) {
                    if (count > 0) {
                        sidebarBadge.textContent = count;
                        sidebarBadge.classList.remove('hidden');
                    } else {
                        sidebarBadge.classList.add('hidden');
                    }
                }
                // Tab badge
                const tabBadge = document.getElementById('badgeNewRequestCount');
                if (tabBadge) tabBadge.textContent = count;
            } catch (e) { console.error('Update badge:', e); }
        }

        // ===== SUBMIT REQUEST (Public offer form) =====
        async function submitRequest() {
            if (offerItems.length === 0) return alert('Tambahkan minimal 1 item layanan ke daftar terlebih dahulu.');
            // Get company data from first section
            const form = document.querySelector('#public-content-create');
            if (!form) return;
            const companySection = form.querySelector('section');
            const inputs = companySection ? companySection.querySelectorAll('input') : [];
            const CompanyName = inputs[0]?.value || '';
            const PICName = inputs[1]?.value || '';
            const PICEmail = inputs[2]?.value || '';
            const PICPhone = inputs[3]?.value || '';
            if (!CompanyName.trim()) return alert('Nama perusahaan wajib diisi.');
            if (!PICName.trim()) return alert('Nama PIC wajib diisi.');
            // Get notes
            const notesTextarea = form.querySelector('textarea');
            const AdditionalNotes = notesTextarea?.value || '';
            // Get service ID from first item
            const ServiceID = offerItems[0]?.ServiceID && offerItems[0].ServiceID !== 'lainnya' ? parseInt(offerItems[0].ServiceID) : null;
            // Build request
            const payload = {
                CompanyName, PICName, PICPhone, PICEmail,
                ServiceID,
                ProjectLocation: offerItems.map(it => it.Location).join('; '),
                ProjectValue: 0,
                DurationMonths: 0,
                GuestName: PICName,
                GuestPhone: PICPhone,
                PaymentTerms: parseInt(offerItems[0]?.PaymentTerms || '1'),
                AdditionalNotes,
                items: offerItems.map(it => ({
                    ServiceType: it.ServiceType,
                    Location: it.Location,
                    Specification: it.Specification,
                    WorkMethod: it.WorkMethod,
                    CustomDescription: it.ServiceType,
                    EstimatedPrice: 0
                }))
            };
            try {
                const result = await api('/requests', 'POST', payload);
                alert('Permintaan berhasil dikirim! Nomor tiket: ' + (result.TicketNumber || result.RequestID));
                // Clear form
                offerItems = [];
                renderOfferItems();
                if (inputs[0]) inputs[0].value = '';
                if (inputs[1]) inputs[1].value = '';
                if (inputs[2]) inputs[2].value = '';
                if (inputs[3]) inputs[3].value = '';
                if (notesTextarea) notesTextarea.value = '';
                // Switch to monitoring to see the submitted request
                switchPublicSection('monitoring');
                loadMonitoringTable();
            } catch (e) {
                alert('Gagal mengirim permintaan: ' + e.message);
            }
        }

        function switchConfigTab(tabId) {
            const cabangTab = document.getElementById('tab-cabang');
            const divisiTab = document.getElementById('tab-divisi');
            const aksesTab = document.getElementById('tab-akses');

            const cabangContent = document.getElementById('content-config-cabang');
            const divisiContent = document.getElementById('content-config-divisi');
            const aksesContent = document.getElementById('content-config-akses');

            const btnText = document.getElementById('textTambahConfig');

            // Reset all tabs
            [cabangTab, divisiTab, aksesTab].forEach(tab => {
                if (tab) tab.className = "px-6 py-4 text-sm font-medium text-slate-500 hover:text-primary border-b-[3px] border-transparent flex items-center gap-2 transition-colors whitespace-nowrap";
            });

            // Hide all content
            if (cabangContent) cabangContent.classList.add('hidden');
            if (divisiContent) divisiContent.classList.add('hidden');
            if (aksesContent) aksesContent.classList.add('hidden');

            // Activate specific tab
            if (tabId === 'cabang') {
                if (cabangTab) cabangTab.className = "px-6 py-4 text-sm font-semibold border-b-[3px] border-primary text-primary flex items-center gap-2 transition-colors whitespace-nowrap";
                if (cabangContent) cabangContent.classList.remove('hidden');
                if (btnText) btnText.innerText = "Tambah Cabang";
            } else if (tabId === 'divisi') {
                if (divisiTab) divisiTab.className = "px-6 py-4 text-sm font-semibold border-b-[3px] border-primary text-primary flex items-center gap-2 transition-colors whitespace-nowrap";
                if (divisiContent) divisiContent.classList.remove('hidden');
                if (btnText) btnText.innerText = "Tambah Divisi";
            } else if (tabId === 'akses') {
                if (aksesTab) aksesTab.className = "px-6 py-4 text-sm font-semibold border-b-[3px] border-primary text-primary flex items-center gap-2 transition-colors whitespace-nowrap";
                if (aksesContent) aksesContent.classList.remove('hidden');
                if (btnText) btnText.innerText = "Tambah User";
                if (typeof loadUsersTable === 'function') loadUsersTable();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // In case it loads with akses tab active implicitly
            if (typeof loadUsersTable === 'function') {
                loadUsersTable();
            }
        });

        // --- NEW: CONFIGURATION MODAL LOGIC ---
        function handleAddConfig() {
            const btnText = document.getElementById('textTambahConfig');
            if (btnText) {
                if (btnText.innerText === "Tambah Cabang") {
                    openAddCabangModal();
                } else if (btnText.innerText === "Tambah Divisi") {
                    openAddDivisiModal();
                } else if (btnText.innerText === "Tambah User") {
                    openAddAksesModal();
                }
            }
        }

        function openAddCabangModal() {
            const modal = document.getElementById('addCabangModal');
            if (modal) modal.classList.remove('hidden');
        }

        function closeAddCabangModal() {
            const modal = document.getElementById('addCabangModal');
            if (modal) modal.classList.add('hidden');
        }

        function openAddDivisiModal() {
            const modal = document.getElementById('addDivisiModal');
            if (modal) modal.classList.remove('hidden');
        }

        function closeAddDivisiModal() {
            const modal = document.getElementById('addDivisiModal');
            if (modal) modal.classList.add('hidden');
        }

        function openAddAksesModal() {
            const modal = document.getElementById('addAksesModal');
            if (modal) modal.classList.remove('hidden');
        }

        function closeAddAksesModal() {
            const modal = document.getElementById('addAksesModal');
            if (modal) modal.classList.add('hidden');
        }

        // --- NEW: PROGRESS MODAL LOGIC (TERMIN BASED) ---
        function openProgressModal(projectName) {
            const modal = document.getElementById('progressUpdateModal');
            if (projectName) {
                const title = document.getElementById('progressModalProjectName');
                if (title) title.innerText = projectName;
            }

            // Generate termin based on default dropdown value
            generateTerms();

            if (modal) modal.classList.remove('hidden');
        }

        function closeProgressModal() {
            const modal = document.getElementById('progressUpdateModal');
            if (modal) modal.classList.add('hidden');
        }

        // --- NEW: SHARE WALLET MODAL LOGIC ---

        function openWalletModal(projectName) {
            const modal = document.getElementById('walletModal');
            if (projectName) {
                const title = document.getElementById('walletModalProjectName');
                if (title) title.innerText = projectName;
            }
            if (modal) modal.classList.remove('hidden');
            calcWallet(); // Hitung awal
        }

        function closeWalletModal() {
            const modal = document.getElementById('walletModal');
            if (modal) modal.classList.add('hidden');
        }

        function calcWallet() {
            const totalMarginInput = document.getElementById('walletTotalMarginInput');
            if (!totalMarginInput) return;
            const currentWalletTotal = parseFloat(totalMarginInput.value) || 0;

            const percentInputs = document.querySelectorAll('.wallet-percent');
            const nominalInputs = document.querySelectorAll('.wallet-nominal');
            let totalPercent = 0;

            // Loop dan kalkulasi
            percentInputs.forEach((input, index) => {
                let p = parseFloat(input.value) || 0;
                totalPercent += p;
                let nominal = (p / 100) * currentWalletTotal;
                // Format rupiah tanpa desimal
                if (nominalInputs[index]) nominalInputs[index].value = Math.round(nominal).toLocaleString('id-ID');
            });

            // Validasi Total 100%
            const remainingText = document.getElementById('walletRemaining');
            if (!remainingText) return;
            if (totalPercent === 100) {
                remainingText.innerText = 'Valid (100%)';
                remainingText.classList.remove('text-rose-500', 'bg-rose-50');
                remainingText.classList.add('text-emerald-600', 'bg-emerald-50');
            } else {
                remainingText.innerText = 'Total: ' + totalPercent + '% (Sisa ' + (100 - totalPercent) + '%)';
                remainingText.classList.add('text-rose-500', 'bg-rose-50');
                remainingText.classList.remove('text-emerald-600', 'bg-emerald-50');
            }
        }

        // --- NEW: EDIT SERVICE MODAL LOGIC ---
        function openEditServiceModal(name = '', owner = '', category = '', status = 'On Progress') {
            const modal = document.getElementById('editServiceModal');
            if (!modal) return;

            const titleEl = modal.querySelector('h3');
            if (titleEl) {
                titleEl.innerText = name ? 'Edit Layanan & Pricing' : 'Tambah Layanan & Pricing';
            }

            const nameEl = document.getElementById('editServiceName');
            if (nameEl) nameEl.value = name;

            // Feature 6: Load portfolio dropdown then set selected value. Category will auto-load.
            loadPortfolioOptions(owner, category);

            const statusEl = document.getElementById('editServiceStatus');
            if (statusEl) statusEl.value = status;

            modal.classList.remove('hidden');
        }

        function closeEditServiceModal() {
            const modal = document.getElementById('editServiceModal');
            if (modal) modal.classList.add('hidden');
        }

        // --- NEW: PARAMETER MODAL LOGIC ---
        async function openParameterModal() {
            const modal = document.getElementById('parameterModal');
            if (!modal) return;

            const serviceId = window.currentParamServiceId;
            if (!serviceId) {
                alert('Silakan simpan layanan terlebih dahulu.');
                return;
            }

            // Ambil nama layanan dari input edit untuk ditampilkan sebagai subtitle di popup parameter
            const nameEl = document.getElementById('editServiceName');
            const subtitleEl = document.getElementById('parameterModalSubtitle');
            if (nameEl && subtitleEl) {
                subtitleEl.innerText = nameEl.value;
            }

            const container = document.getElementById('parameterBoxesContainer');
            if (container) container.innerHTML = '';

            try {
                const params = await api('/services/' + serviceId + '/parameters');
                if (container) {
                    params.forEach(p => {
                        const box = document.createElement('div');
                        box.className = 'param-box space-y-1.5 relative group border border-emerald-200 rounded-xl p-4 hover:border-emerald-300 transition-all bg-emerald-50/30';
                        box.dataset.paramId = p.ParamID;
                        box.innerHTML = `
                            <button type="button" onclick="deleteParameter(${p.ParamID}, this.closest('.param-box'))" class="absolute top-2 right-2 p-1 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all opacity-0 group-hover:opacity-100">
                                <span class="material-symbols-outlined !text-lg">close</span>
                            </button>
                            <label class="text-sm font-medium text-slate-700">${p.ParameterName} <span class="text-xs text-slate-400 font-normal">(Rp ${(p.UnitPrice || 0).toLocaleString('id-ID')} / unit)</span></label>
                            <input class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-900 placeholder:text-slate-400 focus:ring-2 focus:ring-[#3498db]/20 focus:border-[#3498db] transition-all outline-none" placeholder="Masukkan jumlah..." type="number" value="0" readonly />
                        `;
                        container.appendChild(box);
                    });
                }
            } catch (e) {
                console.error('Failed to load params:', e);
            }

            modal.classList.remove('hidden');
        }

        async function deleteParameter(paramId, boxEl) {
            if (!confirm('Hapus parameter ini?')) return;
            try {
                await api('/services/' + window.currentParamServiceId + '/parameters/' + paramId, 'DELETE');
                if (boxEl) boxEl.remove();
            } catch (e) {
                alert('Gagal menghapus parameter: ' + e.message);
            }
        }

        function closeParameterModal() {
            const modal = document.getElementById('parameterModal');
            if (modal) modal.classList.add('hidden');
        }

        // --- NEW: ADD PARAMETER DETAIL MODAL LOGIC ---
        function openAddParameterDetailModal() {
            const modal = document.getElementById('addParameterDetailModal');
            if (modal) modal.classList.remove('hidden');
        }

        function closeAddParameterDetailModal() {
            const modal = document.getElementById('addParameterDetailModal');
            if (modal) modal.classList.add('hidden');
        }

        // --- NEW: REQUEST DATA MODAL LOGIC ---
        function openRequestDataModal(clientName, reqNo) {
            const modal = document.getElementById('requestDataModal');
            if (!modal) return;
            if (clientName) {
                const el = document.getElementById('reqDataClientName');
                if (el) el.innerText = clientName;
            }
            if (reqNo) {
                const el = document.getElementById('reqDataNo');
                if (el) el.innerText = reqNo;
            }

            modal.classList.remove('hidden');
        }

        function closeRequestDataModal() {
            const modal = document.getElementById('requestDataModal');
            if (modal) modal.classList.add('hidden');
        }

        // --- NEW: NEGOTIATION MODAL LOGIC ---
        function openNegotiationModal(clientName, reqNo) {
            const modal = document.getElementById('negotiationModal');
            if (modal) modal.classList.remove('hidden');
        }

        function closeNegotiationModal() {
            const modal = document.getElementById('negotiationModal');
            if (modal) modal.classList.add('hidden');
        }

        function openRespondCounterOfferModal() {
            const negModal = document.getElementById('negotiationModal');
            const respModal = document.getElementById('respondCounterOfferModal');
            if (negModal) negModal.classList.add('hidden');
            if (respModal) respModal.classList.remove('hidden');
        }

        function closeRespondCounterOfferModal() {
            const modal = document.getElementById('respondCounterOfferModal');
            if (modal) modal.classList.add('hidden');
        }

        // --- NEW: NEW REQUEST PRICING MODAL LOGIC ---
        let currentNewRequestID = null;

        async function openNewRequestModal(requestId) {
            const modal = document.getElementById('newRequestModal');
            if (!modal) return;
            currentNewRequestID = requestId;
            const content = document.getElementById('newRequestModalContent');
            const subtitle = document.getElementById('newRequestSubtitle');
            if (content) content.innerHTML = '<p class="text-center text-slate-400 py-8">Memuat data...</p>';
            if (subtitle) subtitle.textContent = 'Memuat data permintaan...';
            modal.classList.remove('hidden');
            try {
                const data = await api('/requests/' + requestId);
                if (subtitle) subtitle.textContent = `Permintaan dari ${data.CompanyName || data.GuestName || 'Klien'} â€” ${data.TicketNumber || 'REQ-' + data.RequestID}`;
                let html = '';
                // Company Info
                html += `<div class="bg-white border border-slate-200 rounded-xl p-5">
                    <h3 class="text-sm font-semibold text-slate-800 mb-3 flex items-center"><span class="material-symbols-outlined text-primary mr-2 text-lg">business</span> Data Perusahaan</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div><span class="text-[10px] uppercase text-slate-400 font-bold block">Perusahaan</span><span class="text-slate-700 font-semibold">${data.CompanyName || '-'}</span></div>
                        <div><span class="text-[10px] uppercase text-slate-400 font-bold block">PIC</span><span class="text-slate-700">${data.PICName || data.GuestName || '-'}</span></div>
                        <div><span class="text-[10px] uppercase text-slate-400 font-bold block">Email</span><span class="text-slate-700">${data.PICEmail || '-'}</span></div>
                        <div><span class="text-[10px] uppercase text-slate-400 font-bold block">Telepon</span><span class="text-slate-700">${data.PICPhone || data.GuestPhone || '-'}</span></div>
                    </div>
                </div>`;
                // Status & Info
                const stMap = { 'New Request': 'amber', 'Reviewing': 'blue', 'Negotiation': 'amber', 'Deal': 'emerald', 'Rejected': 'rose' };
                const stClr = stMap[data.Status] || 'amber';
                html += `<div class="flex flex-wrap gap-3 items-center">
                    <span class="px-3 py-1.5 rounded-full text-[10px] font-bold bg-${stClr}-50 text-${stClr}-600 border border-${stClr}-100 uppercase tracking-wide">${data.Status}</span>
                    <span class="text-xs text-slate-400">Layanan: <strong class="text-slate-600">${data.ServiceName || '-'}</strong></span>
                    <span class="text-xs text-slate-400">Pembayaran: <strong class="text-slate-600">${data.PaymentTerms || 1} Termin</strong></span>
                    <span class="text-xs text-slate-400">Tanggal: <strong class="text-slate-600">${new Date(data.RequestDate).toLocaleDateString('id-ID')}</strong></span>
                </div>`;
                // Items
                if (data.items && data.items.length > 0) {
                    data.items.forEach((item, i) => {
                        html += `<div>
                            <h3 class="text-sm font-semibold text-slate-800 mb-3 flex items-center"><span class="w-2 h-2 bg-primary rounded-full mr-2"></span> Item ${i + 1}: ${item.ServiceType || item.CustomDescription || '-'}</h3>
                            <div class="overflow-x-auto rounded-xl border border-slate-200 bg-white shadow-sm">
                                <table class="w-full text-left border-collapse">
                                    <thead><tr class="bg-slate-50 text-[10px] uppercase tracking-wider text-slate-500">
                                        <th class="px-4 py-3 font-semibold">Parameter</th>
                                        <th class="px-4 py-3 font-semibold">Detail</th>
                                    </tr></thead>
                                    <tbody class="text-sm divide-y divide-slate-100">
                                        <tr><td class="px-4 py-3 font-medium text-slate-700">Lokasi</td><td class="px-4 py-3 text-slate-500">${item.Location || '-'}</td></tr>
                                        ${item.Specification ? `<tr><td class="px-4 py-3 font-medium text-slate-700">Spesifikasi</td><td class="px-4 py-3 text-slate-500">${item.Specification}</td></tr>` : ''}
                                        ${item.WorkMethod ? `<tr><td class="px-4 py-3 font-medium text-slate-700">Metode Kerja</td><td class="px-4 py-3 text-slate-500">${item.WorkMethod}</td></tr>` : ''}
                                        ${item.CustomDescription ? `<tr><td class="px-4 py-3 font-medium text-slate-700">Deskripsi</td><td class="px-4 py-3 text-slate-500">${item.CustomDescription}</td></tr>` : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>`;
                    });
                } else {
                    // Fallback: show header-level data as items
                    html += `<div class="bg-white border border-slate-200 rounded-xl p-5">
                        <h3 class="text-sm font-semibold text-slate-800 mb-3 flex items-center"><span class="w-2 h-2 bg-primary rounded-full mr-2"></span> Detail Layanan</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                            <div><span class="text-[10px] uppercase text-slate-400 font-bold block">Lokasi Proyek</span><span class="text-slate-700">${data.ProjectLocation || '-'}</span></div>
                            <div><span class="text-[10px] uppercase text-slate-400 font-bold block">Spesifikasi</span><span class="text-slate-700">${data.Specification || '-'}</span></div>
                            <div><span class="text-[10px] uppercase text-slate-400 font-bold block">Metode Kerja</span><span class="text-slate-700">${data.WorkMethod || '-'}</span></div>
                        </div>
                    </div>`;
                }
                // Notes
                if (data.AdditionalNotes) {
                    html += `<div class="bg-white border border-slate-200 rounded-xl p-5">
                        <h3 class="text-sm font-semibold text-slate-800 mb-3 flex items-center"><span class="material-symbols-outlined text-primary mr-2 text-lg">description</span> Catatan Tambahan</h3>
                        <p class="text-sm text-slate-600 italic">"${data.AdditionalNotes}"</p>
                    </div>`;
                }
                // Pricing Inputs
                html += `<div class="bg-white border border-slate-200 rounded-xl p-5 mb-5">
                    <h3 class="text-sm font-semibold text-slate-800 mb-3 flex items-center"><span class="material-symbols-outlined text-primary mr-2 text-lg">payments</span> Rincian Penawaran</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs font-semibold text-slate-500">Harga Portofolio (SubTotal)</label>
                            <input type="number" id="inputSubTotal" value="${data.SubTotal || 0}" oninput="calculateGrandTotal()" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-semibold text-slate-500">Harga Penyesuaian</label>
                            <input type="number" id="inputAdjustment" value="${data.AdjustmentAmount || 0}" oninput="calculateGrandTotal()" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-semibold text-slate-500">Total Harga (GrandTotal)</label>
                            <input type="number" id="inputGrandTotal" value="${data.GrandTotal || 0}" readonly class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold text-slate-700">
                        </div>
                    </div>
                </div>`;
                content.innerHTML = html;

                // Toggle Buttons based on Status
                const btnNegotiate = document.getElementById('btnNegotiate');
                const btnSendOffer = document.getElementById('btnSendOffer');
                const btnIncompleteData = document.getElementById('btnIncompleteData');
                if (btnNegotiate) btnNegotiate.classList.add('hidden');
                if (btnSendOffer) btnSendOffer.classList.add('hidden');
                if (btnIncompleteData) btnIncompleteData.classList.add('hidden');

                if (data.Status === 'New Request') {
                    if (btnSendOffer) btnSendOffer.classList.remove('hidden');
                    if (btnIncompleteData) btnIncompleteData.classList.remove('hidden');
                } else if (data.Status === 'Reviewing' || data.Status === 'Negotiation') {
                    // User said "Awal data... penawaran saja".
                    // If already Reviewing (Offer Sent), allow Negotiation or Re-sending offer?
                    // For now, allow Negotiation if status is Reviewing or Negotiation.
                    if (btnNegotiate) btnNegotiate.classList.remove('hidden');
                }
            } catch (e) {
                if (content) content.innerHTML = '<p class="text-center text-rose-400 py-8">Gagal memuat data: ' + e.message + '</p>';
            }
        }

        function closeNewRequestModal() {
            const modal = document.getElementById('newRequestModal');
            if (modal) modal.classList.add('hidden');
        }

        // --- NEGOTIATE REQUEST ---
        async function negotiateRequestById(id) {
            if (!confirm('Ubah status menjadi Negotiation?')) return;
            try {
                await api('/requests/' + id, 'PUT', { Status: 'Negotiation' });
                loadAdminRequests();
                updateNewRequestBadge();
            } catch (e) { alert('Error: ' + e.message); }
        }

        async function negotiateRequest() {
            if (!currentNewRequestID) return alert('Belum ada request yang dipilih.');
            if (!confirm('Ubah status menjadi Negotiation?')) return;
            try {
                await api('/requests/' + currentNewRequestID, 'PUT', { Status: 'Negotiation' });
                alert('Status diubah menjadi Negotiation.');
                closeNewRequestModal();
                loadAdminRequests();
                updateNewRequestBadge();
            } catch (e) { alert('Error: ' + e.message); }
        }

        function calculateGrandTotal() {
            const sub = parseFloat(document.getElementById('inputSubTotal')?.value || 0);
            const adj = parseFloat(document.getElementById('inputAdjustment')?.value || 0);
            const total = sub + adj;
            // Tax logic if needed, but for now just sum
            const grandInput = document.getElementById('inputGrandTotal');
            if (grandInput) grandInput.value = total;
        }

        async function sendOfferFromModal() {
            if (!currentNewRequestID) return alert('Belum ada request yang dipilih.');

            const SubTotal = parseFloat(document.getElementById('inputSubTotal')?.value || 0);
            const AdjustmentAmount = parseFloat(document.getElementById('inputAdjustment')?.value || 0);
            const GrandTotal = parseFloat(document.getElementById('inputGrandTotal')?.value || 0);

            if (GrandTotal <= 0) {
                if (!confirm('Total harga 0. Lanjutkan kirim penawaran?')) return;
            } else {
                if (!confirm(`Kirim penawaran dengan Total Rp ${GrandTotal.toLocaleString()}?`)) return;
            }

            try {
                // Update prices and set status to Reviewing
                await api('/requests/' + currentNewRequestID, 'PUT', {
                    Status: 'Reviewing',
                    SubTotal, AdjustmentAmount, GrandTotal
                });
                alert('Penawaran berhasil dikirim!');
                closeNewRequestModal();
                loadAdminRequests();
                updateNewRequestBadge();
            } catch (e) { alert('Gagal mengirim penawaran: ' + e.message); }
        }


        async function markDataIncomplete() {
            if (!currentNewRequestID) return alert('Belum ada request yang dipilih.');
            if (!confirm('Tandai data sebagai tidak lengkap? Permintaan akan dikembalikan ke klien untuk dilengkapi.')) return;
            try {
                await api('/requests/' + currentNewRequestID, 'PUT', { Status: 'Uncompleted Data' });
                alert('Permintaan dikembalikan ke klien karena data tidak lengkap.');
                closeNewRequestModal();
                loadAdminRequests();
                updateNewRequestBadge();
            } catch (e) { alert('Error: ' + e.message); }
        }

        // --- COMPLETE DATA LOGIC (PUBLIC) ---
        let currentCompletingReqID = null;

        async function openCompleteDataModal(reqId, ticketNumber) {
            currentCompletingReqID = reqId;
            const modal = document.getElementById('completeDataModal');
            const noEl = document.getElementById('completeDataReqNo');
            const noteEl = document.getElementById('completeDataNotes');
            const paramsContainer = document.getElementById('completeDataParams');
            const paramsList = paramsContainer?.querySelector('ul');

            if (noEl) noEl.textContent = ticketNumber;
            if (noteEl) noteEl.value = '';
            if (modal) modal.classList.remove('hidden');

            if (paramsContainer && paramsList) {
                paramsContainer.classList.add('hidden');
                paramsList.innerHTML = '<li>Memuat...</li>';

                try {
                    const reqData = await api('/requests/' + reqId);
                    if (reqData && reqData.ServiceID) {
                        const params = await api('/services/' + reqData.ServiceID + '/parameters');
                        if (params && params.length > 0) {
                            paramsContainer.classList.remove('hidden');
                            paramsList.innerHTML = '';
                            params.forEach(p => {
                                paramsList.innerHTML += `<li><span class="font-semibold text-slate-700">${p.ParameterName}</span></li>`;
                            });
                        }
                    }
                } catch (e) {
                    console.error('Failed to load params for complete data modal', e);
                }
            }
        }

        function closeCompleteDataModal() {
            const modal = document.getElementById('completeDataModal');
            if (modal) modal.classList.add('hidden');
            currentCompletingReqID = null;
        }

        async function submitCompletedData() {
            if (!currentCompletingReqID) return;
            const noteEl = document.getElementById('completeDataNotes');
            if (!noteEl || noteEl.value.trim() === '') {
                return alert('Silakan isi informasi tambahan terlebih dahulu.');
            }

            try {
                // Fetch existing request to append notes
                const data = await api('/requests/' + currentCompletingReqID);
                const existingNotes = data.AdditionalNotes || '';
                const newNotes = existingNotes
                    + (existingNotes ? '\\n\\n' : '')
                    + '[Update Data Klien]: ' + noteEl.value.trim();

                // Put the request back to 'New Request' with updated notes
                await api('/requests/' + currentCompletingReqID, 'PUT', {
                    Status: 'New Request',
                    AdditionalNotes: newNotes
                });

                alert('Data berhasil dikirim kembali ke Admin SI-ONE.');
                closeCompleteDataModal();
                loadMonitoringTable();
            } catch (e) {
                alert('Gagal mengirim data: ' + e.message);
            }
        }

        // --- MONITORING PROGRESS CARDS (Dynamic from Deal requests) ---
        async function loadMonitoringProgressCards() {
            const grid = document.getElementById('monitoringProgressGrid');
            if (!grid) return;
            grid.innerHTML = '<div class="col-span-full text-center py-12 text-slate-400"><span class="material-symbols-outlined text-4xl mb-2">hourglass_empty</span><p class="text-sm">Memuat proyek...</p></div>';
            try {
                const requests = await api('/requests?status=Deal');
                grid.innerHTML = '';
                if (requests.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center py-12 text-slate-400"><span class="material-symbols-outlined text-4xl mb-2">folder_off</span><p class="text-sm">Belum ada proyek aktif (status Deal).</p></div>';
                    return;
                }
                const colors = ['primary', 'emerald', 'amber', 'blue', 'purple', 'cyan'];
                requests.forEach((r, i) => {
                    const color = colors[i % colors.length];
                    const initials = (r.CompanyName || 'XX').split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
                    const progress = Math.floor(Math.random() * 60) + 20; // Simulated progress
                    grid.innerHTML += `<div class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm hover:shadow-md transition-all relative overflow-hidden group">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="font-bold text-slate-800 text-lg mb-1 line-clamp-1">${r.CompanyName || r.GuestName || '-'}</h3>
                            <button onclick="openProgressModal('${(r.CompanyName || '').replace(/'/g, "\\'")}')" class="text-slate-400 hover:text-primary transition-colors p-1.5 rounded-lg hover:bg-slate-50" title="Update Progress">
                                <span class="material-symbols-outlined text-xl">edit_square</span>
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mb-4 font-medium">${r.ServiceName || '-'}</p>
                        <div class="space-y-2 mb-6">
                            <div class="flex justify-between text-xs font-bold text-slate-700">
                                <span>Progress</span><span>${progress}%</span>
                            </div>
                            <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                                <div class="h-full bg-${color} rounded-full relative" style="width: ${progress}%"><div class="absolute right-0 top-0 bottom-0 w-1 bg-white/30 animate-pulse"></div></div>
                            </div>
                            <p class="text-[10px] text-slate-400 text-right">Tanggal Request: ${new Date(r.RequestDate).toLocaleDateString('id-ID')}</p>
                        </div>
                        <div class="flex items-center justify-between pt-4 border-t border-slate-100">
                            <div class="flex -space-x-2">
                                <div class="w-8 h-8 rounded-full bg-${color}-100 border-2 border-white flex items-center justify-center text-xs font-bold text-${color}-600 shadow-sm">${initials}</div>
                            </div>
                            <button onclick="openNewRequestModal(${r.RequestID})" class="text-xs font-bold text-primary hover:text-blue-700 flex items-center gap-1 transition-colors px-3 py-1.5 hover:bg-blue-50 rounded-lg">
                                Detail Proyek <span class="material-symbols-outlined text-sm">arrow_forward</span>
                            </button>
                        </div>
                    </div>`;
                });
            } catch (e) {
                console.error('Load monitoring progress:', e);
                grid.innerHTML = '<div class="col-span-full text-center py-12 text-rose-400"><span class="material-symbols-outlined text-4xl mb-2">error</span><p class="text-sm">Gagal memuat data proyek.</p></div>';
            }
        }

        // --- PUBLIC RESPOND MODAL (RESPON KLIEN TERHADAP PENAWARAN PTSI) ---
        let currentRespondRequestId = null;
        async function openPublicRespondModal(requestId, ticketNo) {
            currentRespondRequestId = requestId;
            // Create modal if it doesn't exist
            let modal = document.getElementById('clientRespondModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'clientRespondModal';
                modal.className = 'fixed inset-0 z-[99] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto m-4">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <div>
                                <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2"><span class="material-symbols-outlined text-primary">receipt_long</span> Respon Penawaran PTSI</h2>
                                <p id="clientRespondSubtitle" class="text-xs text-slate-400 mt-1">Memuat...</p>
                            </div>
                            <button onclick="closeClientRespondModal()" class="p-2 hover:bg-slate-100 rounded-xl transition-colors"><span class="material-symbols-outlined">close</span></button>
                        </div>
                        <div id="clientRespondContent" class="p-6 space-y-4"></div>
                        <div class="p-6 border-t border-slate-100 flex flex-col sm:flex-row justify-end gap-3">
                            <button onclick="clientNegotiate()" class="px-6 py-3 bg-amber-500 hover:bg-amber-600 text-white rounded-xl font-bold text-sm transition-all flex items-center gap-2 shadow-md"><span class="material-symbols-outlined text-lg">handshake</span> Negosiasi</button>
                            <button onclick="clientAcceptDeal()" class="px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold text-sm transition-all flex items-center gap-2 shadow-md"><span class="material-symbols-outlined text-lg">check_circle</span> Deal / Setuju</button>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
            }
            const content = document.getElementById('clientRespondContent');
            const subtitle = document.getElementById('clientRespondSubtitle');
            if (content) content.innerHTML = '<p class="text-center text-slate-400 py-8">Memuat data penawaran...</p>';
            if (subtitle) subtitle.textContent = ticketNo || 'Memuat...';
            modal.classList.remove('hidden');
            try {
                const data = await api('/requests/' + requestId);
                if (subtitle) subtitle.textContent = `${data.CompanyName || 'Klien'} — ${data.TicketNumber || 'REQ-' + data.RequestID}`;
                let html = `<div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
                    <h3 class="text-sm font-bold text-slate-700 mb-2">Detail Penawaran dari PTSI</h3>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div><span class="text-[10px] text-slate-400 uppercase font-bold block">Layanan</span><span class="text-slate-700 font-semibold">${data.ServiceName || '-'}</span></div>
                        <div><span class="text-[10px] text-slate-400 uppercase font-bold block">Pembayaran</span><span class="text-slate-700">${data.PaymentTerms || 1} Termin</span></div>
                    </div>
                </div>`;
                // Items pricing table
                if (data.parameterValues && data.parameterValues.length > 0) {
                    html += `<div class="overflow-x-auto rounded-xl border border-slate-200 bg-white"><table class="w-full text-left"><thead><tr class="bg-slate-50 text-[10px] uppercase tracking-wider text-slate-500">
                        <th class="px-4 py-3">Parameter</th><th class="px-4 py-3 text-right">Jumlah</th><th class="px-4 py-3 text-right">Harga Satuan</th><th class="px-4 py-3 text-right">Subtotal</th>
                    </tr></thead><tbody class="text-sm divide-y divide-slate-100">`;
                    let paramTotal = 0;
                    data.parameterValues.forEach(pv => {
                        const sub = pv.CalculatedPrice || 0;
                        paramTotal += sub;
                        html += `<tr><td class="px-4 py-3 font-medium text-slate-700">${pv.ParameterName || 'Parameter'}</td>
                            <td class="px-4 py-3 text-right">${pv.InputValue || '-'}</td>
                            <td class="px-4 py-3 text-right">Rp ${Number(pv.UnitPrice || 0).toLocaleString('id-ID')}</td>
                            <td class="px-4 py-3 text-right font-bold">Rp ${sub.toLocaleString('id-ID')}</td></tr>`;
                    });
                    html += `</tbody></table></div>`;
                }
                // Totals
                const subTotal = data.SubTotal || 0;
                const adj = data.AdjustmentAmount || 0;
                const grand = data.GrandTotal || 0;
                html += `<div class="bg-emerald-50 rounded-xl p-4 border border-emerald-200 space-y-2">
                    <div class="flex justify-between text-sm"><span class="text-slate-600">SubTotal</span><span class="font-bold text-slate-800">Rp ${subTotal.toLocaleString('id-ID')}</span></div>
                    <div class="flex justify-between text-sm"><span class="text-slate-600">Penyesuaian</span><span class="font-bold text-slate-800">Rp ${adj.toLocaleString('id-ID')}</span></div>
                    <div class="flex justify-between text-lg border-t border-emerald-300 pt-2 mt-2"><span class="font-bold text-emerald-800">Grand Total</span><span class="font-bold text-emerald-700">Rp ${grand.toLocaleString('id-ID')}</span></div>
                </div>`;
                if (data.AdditionalNotes) {
                    html += `<div class="bg-white rounded-xl p-4 border border-slate-200"><p class="text-sm text-slate-500 italic">"${data.AdditionalNotes}"</p></div>`;
                }
                content.innerHTML = html;
            } catch (e) {
                if (content) content.innerHTML = '<p class="text-center text-rose-400 py-8">Gagal memuat: ' + e.message + '</p>';
            }
        }
        function closeClientRespondModal() {
            const modal = document.getElementById('clientRespondModal');
            if (modal) modal.classList.add('hidden');
        }
        async function clientAcceptDeal() {
            if (!currentRespondRequestId) return;
            if (!confirm('Anda yakin menerima penawaran ini? Status akan diubah menjadi DEAL.')) return;
            try {
                await api('/requests/' + currentRespondRequestId + '/status', 'PUT', { Status: 'Deal', ChangedBy: 'Client' });
                alert('Penawaran diterima! Status: Deal.');
                closeClientRespondModal();
                loadMonitoringTable();
            } catch (e) { alert('Error: ' + e.message); }
        }
        async function clientNegotiate() {
            closeClientRespondModal();
            openClientNegotiationModal(currentRespondRequestId);
        }

        // --- CLIENT NEGOTIATION MODAL (KLIEN MENGAJUKAN NEGOSIASI) ---
        let currentNegotiateRequestId = null;
        async function openClientNegotiationModal(requestId) {
            currentNegotiateRequestId = requestId;
            let modal = document.getElementById('clientNegotiationModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'clientNegotiationModal';
                modal.className = 'fixed inset-0 z-[99] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto m-4">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <div>
                                <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2"><span class="material-symbols-outlined text-amber-500">handshake</span> Ajukan Negosiasi</h2>
                                <p id="clientNegoSubtitle" class="text-xs text-slate-400 mt-1"></p>
                            </div>
                            <button onclick="closeClientNegotiationModal()" class="p-2 hover:bg-slate-100 rounded-xl transition-colors"><span class="material-symbols-outlined">close</span></button>
                        </div>
                        <div id="clientNegoContent" class="p-6 space-y-4"></div>
                        <div class="p-6 border-t border-slate-100 flex justify-end gap-3">
                            <button onclick="closeClientNegotiationModal()" class="px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold text-sm transition-all">Batal</button>
                            <button onclick="submitClientNegotiation()" class="px-6 py-3 bg-amber-500 hover:bg-amber-600 text-white rounded-xl font-bold text-sm transition-all flex items-center gap-2 shadow-md"><span class="material-symbols-outlined text-lg">send</span> Kirim Negosiasi</button>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
            }
            const content = document.getElementById('clientNegoContent');
            const subtitle = document.getElementById('clientNegoSubtitle');
            if (content) content.innerHTML = '<p class="text-center text-slate-400 py-8">Memuat...</p>';
            modal.classList.remove('hidden');
            try {
                const data = await api('/requests/' + requestId);
                if (subtitle) subtitle.textContent = `${data.CompanyName || 'Klien'} — ${data.TicketNumber || ''}`;
                const grand = data.GrandTotal || 0;
                let html = `
                    <div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-slate-600">Harga Penawaran PTSI</span>
                            <span class="text-lg font-bold text-slate-800">Rp ${grand.toLocaleString('id-ID')}</span>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <label class="text-sm font-bold text-slate-700">Harga yang Anda Ajukan</label>
                        <input type="number" id="clientProposedPrice" class="w-full px-4 py-3 border border-amber-200 rounded-xl text-lg font-bold focus:ring-2 focus:ring-amber-300/30 focus:border-amber-400 outline-none" placeholder="Masukkan harga negosiasi Anda" />
                    </div>
                    <div class="space-y-3">
                        <label class="text-sm font-bold text-slate-700">Catatan / Alasan Negosiasi</label>
                        <textarea id="clientNegoNotes" rows="3" class="w-full px-4 py-3 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-amber-300/30 outline-none resize-none" placeholder="Jelaskan alasan negosiasi..."></textarea>
                    </div>`;
                content.innerHTML = html;
            } catch (e) {
                if (content) content.innerHTML = '<p class="text-center text-rose-400 py-8">Gagal: ' + e.message + '</p>';
            }
        }
        function closeClientNegotiationModal() {
            const modal = document.getElementById('clientNegotiationModal');
            if (modal) modal.classList.add('hidden');
        }
        async function submitClientNegotiation() {
            if (!currentNegotiateRequestId) return;
            const proposedPrice = parseFloat(document.getElementById('clientProposedPrice')?.value || 0);
            const notes = document.getElementById('clientNegoNotes')?.value || '';
            if (proposedPrice <= 0) return alert('Masukkan harga negosiasi yang valid.');
            try {
                // Save negotiation history
                await api('/requests/' + currentNegotiateRequestId + '/negotiations', 'POST', {
                    ProposedBy: 'Client',
                    ProposedPrice: proposedPrice,
                    Notes: notes
                });
                // Update status to Negotiation
                await api('/requests/' + currentNegotiateRequestId + '/status', 'PUT', { Status: 'Negotiation', ChangedBy: 'Client' });
                alert('Negosiasi berhasil dikirim!');
                closeClientNegotiationModal();
                loadMonitoringTable();
            } catch (e) { alert('Gagal mengirim negosiasi: ' + e.message); }
        }

        // --- NEW: PUBLIC CHAT MODAL LOGIC ---
        let currentChatReqID = null;

        async function loadPublicChatMessages() {
            const body = document.getElementById('chatModalBody');
            if (!body || !currentChatReqID) return;
            try {
                const messages = await api('/requests/' + currentChatReqID + '/messages');
                body.innerHTML = '';
                if (messages.length === 0) {
                    body.innerHTML = '<div class="flex justify-center"><span class="text-[10px] font-bold text-slate-400 bg-white border border-slate-100 px-4 py-1 rounded-full uppercase tracking-widest shadow-sm">Belum ada pesan</span></div>';
                    return;
                }
                messages.forEach(msg => {
                    const isClient = msg.Sender === 'Client';
                    const timeStr = new Date(msg.Timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

                    const attachmentHtml = msg.AttachmentData ? `<div class="mt-2"><a href="${msg.AttachmentData}" target="_blank" class="inline-flex items-center gap-1 text-[11px] bg-white/20 px-2 py-1 rounded-lg hover:bg-white/30 transition-colors"><span class="material-symbols-outlined text-[14px]">attach_file</span> Lampiran</a></div>` : '';
                    const inlineAttachmentHtml = msg.AttachmentData ? `<div class="mt-2"><a href="${msg.AttachmentData}" target="_blank" class="inline-flex items-center gap-1 text-[11px] bg-slate-200 px-2 py-1 rounded-lg hover:bg-slate-300 transition-colors text-slate-700"><span class="material-symbols-outlined text-[14px]">attach_file</span> Lampiran</a></div>` : '';

                    if (isClient) {
                        body.innerHTML += `
                        <div class="flex items-start justify-end gap-3 group">
                            <button onclick="deleteChatMessage('${msg.MessageID}', false)" class="text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100 p-1 mt-4" title="Hapus pesan">
                                <span class="material-symbols-outlined text-[14px]">delete</span>
                            </button>
                            <div class="space-y-1.5 flex flex-col items-end">
                                <p class="text-[10px] font-bold text-primary uppercase tracking-tight mr-1">Anda</p>
                                <div class="bg-primary text-white rounded-2xl rounded-tr-none p-4 max-w-[85%] text-sm leading-relaxed shadow-md break-words">${msg.MessageText || ''}${attachmentHtml}</div>
                                <span class="text-[10px] text-slate-400 px-1 font-medium text-right flex items-center gap-1.5">${timeStr} <span class="material-symbols-outlined text-[14px] text-primary">done_all</span></span>
                            </div>
                        </div>`;
                    } else {
                        body.innerHTML += `
                        <div class="flex items-start gap-3">
                            <div class="w-9 h-9 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center">
                                <span class="material-symbols-outlined text-slate-500 text-sm">support_agent</span>
                            </div>
                            <div class="space-y-1.5">
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-tight ml-1">Admin SI-ONE</p>
                                <div class="bg-slate-100 text-slate-700 rounded-2xl rounded-tl-none p-4 max-w-[85%] text-sm leading-relaxed shadow-sm border border-slate-200 break-words">${msg.MessageText || ''}${inlineAttachmentHtml}</div>
                                <span class="text-[10px] text-slate-400 px-1 font-medium">${timeStr}</span>
                            </div>
                        </div>`;
                    }
                });
                body.scrollTop = body.scrollHeight; // Auto-scroll to bottom
            } catch (e) {
                body.innerHTML = '<div class="text-center text-sm text-rose-500 pt-4">Gagal memuat pesan.</div>';
            }
        }

        function openPublicChatModal(reqId, ticketNumber) {
            const modal = document.getElementById('publicChatModal');
            if (!modal) return;

            // Allow calling with old signature openPublicChatModal(ticketNumber) mostly from static HTML
            if (!ticketNumber && typeof reqId === 'string' && reqId.startsWith('REQ')) {
                ticketNumber = reqId;
                reqId = parseInt(reqId.replace('REQ-', '').split('-')[2] || reqId.replace('REQ-', '').split('-')[1]);
                if (isNaN(reqId)) {
                    // try extracting it from substring
                    const parts = ticketNumber.split('-');
                    reqId = parseInt(parts[parts.length - 1]);
                }
            }

            currentChatReqID = reqId;
            const el = document.getElementById('chatModalReqNo');
            if (el && ticketNumber) el.innerText = ticketNumber;

            modal.classList.remove('hidden');
            loadPublicChatMessages();
        }

        let publicChatAttachmentBase64 = null;
        function handlePublicChatAttachment(event) {
            const file = event.target.files[0];
            if (!file) {
                publicChatAttachmentBase64 = null;
                document.getElementById('publicChatAttachmentName').classList.add('hidden');
                return;
            }
            if (file.size > 5 * 1024 * 1024) return alert('File terlalu besar (Maks 5MB)');
            const reader = new FileReader();
            reader.onload = function (e) {
                publicChatAttachmentBase64 = e.target.result;
                const nameEl = document.getElementById('publicChatAttachmentName');
                nameEl.textContent = file.name;
                nameEl.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        async function sendPublicChatMessage() {
            if (!currentChatReqID) return;
            const input = document.getElementById('chatModalInput');
            const msg = input?.value.trim();
            if (!msg && !publicChatAttachmentBase64) return;

            try {
                await api('/requests/' + currentChatReqID + '/messages', 'POST', {
                    Sender: 'Client',
                    MessageText: msg || '',
                    AttachmentData: publicChatAttachmentBase64 || null
                });
                if (input) input.value = '';
                publicChatAttachmentBase64 = null;
                document.getElementById('publicChatAttachmentName').classList.add('hidden');
                document.getElementById('publicChatAttachment').value = '';
                loadPublicChatMessages();
            } catch (e) {
                alert('Gagal mengirim pesan: ' + e.message);
            }
        }

        function closePublicChatModal() {
            const modal = document.getElementById('publicChatModal');
            if (modal) modal.classList.add('hidden');
            currentChatReqID = null;
        }

        // --- NEW: ADMIN CHAT MODAL LOGIC ---
        let currentAdminChatReqID = null;

        async function loadAdminChatThreads() {
            const listObj = document.getElementById('adminChatThreadList');
            if (!listObj) return;
            try {
                // Fetch all requests for now, and ideally we'd filter those with messages or active Negotiation
                const requests = await api('/requests');
                listObj.innerHTML = '';

                // Sort by date or just show recent
                if (requests.length === 0) {
                    listObj.innerHTML = '<div class="p-4 text-center text-xs text-slate-400 italic">Belum ada percakapan</div>';
                    return;
                }

                requests.forEach(r => {
                    const ticket = r.TicketNumber || ('REQ-' + r.RequestID);
                    const name = r.CompanyName || r.GuestName || 'Client';
                    const activeClass = currentAdminChatReqID === r.RequestID ? 'border-l-4 border-primary bg-blue-50' : 'border-l-4 border-transparent hover:bg-slate-100';

                    listObj.innerHTML += `
                    <div onclick="selectAdminChatThread(${r.RequestID}, '${name} - ${ticket}')" class="p-4 cursor-pointer transition-colors ${activeClass}">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-bold text-sm text-slate-800 line-clamp-1">${name}</span>
                        </div>
                        <p class="text-xs text-slate-500 line-clamp-1 font-mono">${ticket}</p>
                    </div>`;
                });
            } catch (e) {
                listObj.innerHTML = '<div class="p-4 text-center text-xs text-rose-500">Gagal memuat</div>';
            }
        }

        async function selectAdminChatThread(reqId, title) {
            currentAdminChatReqID = reqId;
            document.getElementById('adminChatHeader').classList.remove('hidden');
            document.getElementById('adminChatActiveName').innerText = title.split(' - ')[0];
            document.getElementById('adminChatActiveReq').innerText = title.split(' - ')[1];

            document.getElementById('adminChatInput').disabled = false;
            document.getElementById('adminChatSendBtn').disabled = false;

            // Re-render sidebar to update active class
            loadAdminChatThreads();
            loadAdminChatMessages();
        }

        async function loadAdminChatMessages() {
            const body = document.getElementById('adminChatBody');
            if (!body || !currentAdminChatReqID) return;
            try {
                const messages = await api('/requests/' + currentAdminChatReqID + '/messages');
                body.innerHTML = '';
                if (messages.length === 0) {
                    body.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-slate-400 italic text-sm">Belum ada pesan. Mulai percakapan.</div>';
                    return;
                }
                messages.forEach(msg => {
                    const isAdmin = msg.Sender === 'Admin';
                    const timeStr = new Date(msg.Timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

                    const attachmentHtml = msg.AttachmentData ? `<div class="mt-2"><a href="${msg.AttachmentData}" target="_blank" class="inline-flex items-center gap-1 text-[11px] bg-white/20 px-2 py-1 rounded-lg hover:bg-white/30 transition-colors"><span class="material-symbols-outlined text-[14px]">attach_file</span> Lampiran</a></div>` : '';
                    const inlineAttachmentHtml = msg.AttachmentData ? `<div class="mt-2"><a href="${msg.AttachmentData}" target="_blank" class="inline-flex items-center gap-1 text-[11px] bg-slate-200 px-2 py-1 rounded-lg hover:bg-slate-300 transition-colors text-slate-700"><span class="material-symbols-outlined text-[14px]">attach_file</span> Lampiran</a></div>` : '';

                    if (isAdmin) {
                        body.innerHTML += `
                        <div class="flex flex-col items-end ml-auto max-w-[80%] group">
                            <div class="flex items-center gap-2">
                                <button onclick="deleteChatMessage('${msg.MessageID}', true)" class="text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100 p-1" title="Hapus pesan">
                                    <span class="material-symbols-outlined text-[14px]">delete</span>
                                </button>
                                <div class="bg-primary text-white p-3 rounded-2xl rounded-tr-none text-sm shadow-md break-words">${msg.MessageText || ''}${attachmentHtml}</div>
                            </div>
                            <div class="flex items-center gap-1 mt-1 mr-1">
                                <span class="text-[10px] text-slate-400">${timeStr}</span>
                                <span class="material-symbols-outlined text-[14px] text-blue-500">done_all</span>
                            </div>
                        </div>`;
                    } else {
                        body.innerHTML += `
                        <div class="flex flex-col items-start max-w-[80%]">
                            <div class="flex items-center gap-1 mb-1 ml-1"><span class="text-[10px] font-bold text-slate-500 uppercase">Klien</span></div>
                            <div class="bg-slate-100 text-slate-800 p-3 rounded-2xl rounded-tl-none text-sm shadow-sm break-words">${msg.MessageText || ''}${inlineAttachmentHtml}</div>
                            <span class="text-[10px] text-slate-400 mt-1 ml-1">${timeStr}</span>
                        </div>`;
                    }
                });
                body.scrollTop = body.scrollHeight;
            } catch (e) {
                body.innerHTML = '<div class="text-center text-sm text-rose-500 pt-4">Gagal memuat pesan.</div>';
            }
        }

        let adminChatAttachmentBase64 = null;
        function handleAdminChatAttachment(event) {
            const file = event.target.files[0];
            if (!file) {
                adminChatAttachmentBase64 = null;
                document.getElementById('adminChatAttachmentName').classList.add('hidden');
                return;
            }
            if (file.size > 5 * 1024 * 1024) return alert('File terlalu besar (Maks 5MB)');
            const reader = new FileReader();
            reader.onload = function (e) {
                adminChatAttachmentBase64 = e.target.result;
                const nameEl = document.getElementById('adminChatAttachmentName');
                nameEl.textContent = file.name;
                nameEl.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        async function sendAdminChatMessage() {
            if (!currentAdminChatReqID) return;
            const input = document.getElementById('adminChatInput');
            const msg = input?.value.trim();
            if (!msg && !adminChatAttachmentBase64) return;

            try {
                // Post to Backend
                await api('/requests/' + currentAdminChatReqID + '/messages', 'POST', {
                    Sender: 'Admin',
                    MessageText: msg || '',
                    AttachmentData: adminChatAttachmentBase64 || null
                });
                if (input) input.value = '';
                adminChatAttachmentBase64 = null;
                document.getElementById('adminChatAttachmentName').classList.add('hidden');
                document.getElementById('adminChatAttachment').value = '';
                loadAdminChatMessages();
            } catch (e) {
                alert('Gagal mengirim pesan: ' + e.message);
            }
        }

        async function deleteChatMessage(id, isAdmin) {
            if (!confirm('Hapus pesan ini?')) return;
            try {
                await api('/messages/' + id, 'DELETE');
                if (isAdmin) loadAdminChatMessages();
                else loadPublicChatMessages();
            } catch (e) {
                alert('Gagal hapus pesan: ' + e.message);
            }
        }

        function openAdminChatModal() {
            const modal = document.getElementById('adminChatModal');
            if (modal) {
                modal.classList.remove('hidden');
                loadAdminChatThreads();
            }
        }

        function closeAdminChatModal() {
            const modal = document.getElementById('adminChatModal');
            if (modal) modal.classList.add('hidden');
        }

        // --- NEW: NOTIFICATION MODAL LOGIC ---
        function openNotificationModal() {
            const modal = document.getElementById('notificationModal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function closeNotificationModal() {
            const modal = document.getElementById('notificationModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // --- NEW: NOTIFICATION SETTINGS MODAL LOGIC ---
        function openNotificationSettingsModal() {
            const modal = document.getElementById('notificationSettingsModal');
            // Optional: Close the main panel first or keep it open in background
            // closeNotificationModal(); 
            if (modal) modal.classList.remove('hidden');
        }

        function closeNotificationSettingsModal() {
            const modal = document.getElementById('notificationSettingsModal');
            if (modal) modal.classList.add('hidden');
        }

        async function saveDraftNewRequest() {
            if (currentNewRequestID) {
                const reqId = currentNewRequestID.replace('REQ-', '');
                try {
                    await api('/requests/' + reqId, 'PUT', { Status: 'Reviewing' });
                    closeNewRequestModal();
                    alert('Draft disimpan! Status diubah menjadi Reviewing.');
                    loadAdminRequests();
                } catch (e) { alert('Error: ' + e.message); }
            }
        }

        function generateTerms() {
            const selectEl = document.getElementById('paymentTerms');
            if (!selectEl) return;
            const termsCount = parseInt(selectEl.value);
            const container = document.getElementById('termsContainer');
            if (!container) return;

            container.innerHTML = ''; // Kosongkan kontainer

            for (let i = 1; i <= termsCount; i++) {
                const termDiv = document.createElement('div');
                termDiv.className = 'flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 bg-white border border-slate-200 rounded-xl shadow-sm hover:border-primary/50 transition-colors gap-4';
                termDiv.innerHTML = `
                    <label class="flex items-center gap-3 cursor-pointer group w-full sm:w-auto">
                        <input type="checkbox" class="term-checkbox w-5 h-5 rounded border-slate-300 text-primary focus:ring-primary cursor-pointer transition-colors" onchange="updateTermProgress()">
                        <div>
                            <h4 class="font-bold text-slate-800 text-sm group-hover:text-primary transition-colors">Termin ${i}</h4>
                            <p class="text-[10px] text-slate-500 term-status">Tandai jika pekerjaan/pembayaran selesai</p>
                        </div>
                    </label>
                    <div class="w-full sm:w-auto flex items-center gap-2">
                        <label class="px-3 py-2 bg-blue-50 text-blue-600 hover:bg-blue-100 hover:text-blue-700 rounded-lg text-xs font-bold flex items-center justify-center gap-1.5 transition-colors border border-blue-100 cursor-pointer">
                            <span class="material-symbols-outlined text-[16px]">upload_file</span>
                            <span class="bast-label">Upload BAST</span>
                            <input type="file" class="hidden bast-file-input" accept=".pdf,.doc,.docx,.jpg,.png" />
                        </label>
                    </div>
                `;
                // Wire BAST file input to auto-check
                const fileInput = termDiv.querySelector('.bast-file-input');
                const checkbox = termDiv.querySelector('.term-checkbox');
                const bastLabel = termDiv.querySelector('.bast-label');
                const statusText = termDiv.querySelector('.term-status');
                fileInput.addEventListener('change', function () {
                    if (this.files && this.files.length > 0) {
                        checkbox.checked = true;
                        bastLabel.textContent = this.files[0].name;
                        statusText.textContent = 'BAST terupload â€” otomatis ditandai selesai';
                        statusText.classList.add('text-emerald-600', 'font-semibold');
                        statusText.classList.remove('text-slate-500');
                        // Visual feedback
                        termDiv.classList.add('border-emerald-300', 'bg-emerald-50/30');
                        termDiv.classList.remove('border-slate-200');
                        updateTermProgress();
                    }
                });
                container.appendChild(termDiv);
            }
            updateTermProgress(); // Reset & Kalkulasi ulang progress saat termin berubah
        }

        function updateTermProgress() {
            const checkboxes = document.querySelectorAll('.term-checkbox');
            const total = checkboxes.length;
            let checked = 0;

            checkboxes.forEach(cb => {
                if (cb.checked) checked++;
            });

            // Kalkulasi persentase
            const percentage = total === 0 ? 0 : Math.round((checked / total) * 100);

            const progressText = document.getElementById('modalProgressText');
            const progressFill = document.getElementById('modalProgressFill');

            if (progressText) progressText.innerText = percentage + '%';
            if (progressFill) progressFill.style.width = percentage + '%';

            // Ubah warna menjadi hijau jika 100% selesai
            if (percentage === 100) {
                if (progressFill) {
                    progressFill.classList.remove('bg-primary');
                    progressFill.classList.add('bg-emerald-500');
                }
                if (progressText) {
                    progressText.classList.remove('text-primary');
                    progressText.classList.add('text-emerald-500');
                }
            } else {
                if (progressFill) {
                    progressFill.classList.remove('bg-emerald-500');
                    progressFill.classList.add('bg-primary');
                }
                if (progressText) {
                    progressText.classList.remove('text-emerald-500');
                    progressText.classList.add('text-primary');
                }
            }
        }

        // --- NEW: NOTIFICATION LOGIC ---
        let activeNotifTab = 'all';
        let notifications = [];

        async function loadNotifications() {
            try {
                const data = await api('/notifications');
                notifications = data;
                renderNotifications();
            } catch (err) {
                console.error('Failed to load notifications:', err);
            }
        }

        function renderNotifications() {
            const container = document.getElementById('dynamic-notification-container');
            const countText = document.getElementById('notif-count-text');
            const bellBadge = document.getElementById('notif-badge-indicator'); // Optional badge on the bell icon if it exists

            if (!container) return;

            container.innerHTML = '';

            let unreadCount = 0;
            let visibleCount = 0;

            notifications.forEach(notif => {
                const isRead = notif.IsRead;
                const isArchived = false; // Add archive logic later if DB supports it

                if (!isRead) unreadCount++;

                // Filter logic
                let shouldShow = false;
                if (activeNotifTab === 'all') shouldShow = !isArchived;
                else if (activeNotifTab === 'unread') shouldShow = !isRead && !isArchived;
                else if (activeNotifTab === 'archive') shouldShow = isArchived;

                if (!shouldShow) return;
                visibleCount++;

                // Styling based on Type
                let icon = 'notifications';
                let colorClass = 'slate';
                let typeLabel = notif.Type;

                if (notif.Type === 'New Request') {
                    icon = 'priority_high';
                    colorClass = 'orange';
                } else if (notif.Type === 'Negotiation') {
                    icon = 'payments';
                    colorClass = 'amber';
                } else if (notif.Type === 'Status Update') {
                    icon = 'verified';
                    colorClass = 'emerald';
                } else if (notif.Type === 'Message') {
                    icon = 'chat';
                    colorClass = 'blue';
                }

                // Format timestamp
                const timeStr = new Date(notif.Timestamp).toLocaleString();

                const html = `
                    <div class="notif-item p-6 border-b border-slate-50 hover:bg-slate-50 transition-colors relative group cursor-pointer"
                        onclick="markSingleNotifRead(${notif.NotificationID})">
                        ${!isRead ? `<div class="notif-indicator absolute left-0 top-0 bottom-0 w-1 bg-primary transition-colors"></div>` : ''}
                        <div class="flex gap-4">
                            <div class="flex-shrink-0 w-10 h-10 bg-${colorClass}-100 rounded-lg flex items-center justify-center">
                                <span class="material-symbols-outlined text-${colorClass}-600 text-[20px]">${icon}</span>
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="text-[10px] font-bold uppercase tracking-wider text-${colorClass}-600 bg-${colorClass}-50 px-2 py-0.5 rounded">${typeLabel}</span>
                                    <span class="text-[11px] text-slate-400">${timeStr}</span>
                                </div>
                                <h3 class="text-sm font-semibold text-slate-900 mb-1">${notif.Title}</h3>
                                <p class="text-xs text-slate-500 leading-relaxed">${notif.Message}</p>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });

            // Update Counts
            if (countText) countText.innerText = `You have ${unreadCount} unread alerts`;
            if (bellBadge) {
                if (unreadCount > 0) {
                    bellBadge.classList.remove('hidden');
                    bellBadge.innerText = unreadCount;
                } else {
                    bellBadge.classList.add('hidden');
                }
            }

            // Show Empty State
            const emptyState = document.getElementById('notif-empty-state');
            if (emptyState) {
                emptyState.style.display = visibleCount === 0 ? 'flex' : 'none';
            }
        }

        function switchNotifTab(tabName) {
            activeNotifTab = tabName;

            // Update button styles
            const tabs = ['all', 'unread', 'archive'];
            tabs.forEach(t => {
                const btn = document.getElementById('btn-notif-' + t);
                if (btn) {
                    if (t === tabName) {
                        btn.className = "px-4 py-1.5 bg-primary text-white text-sm font-medium rounded-full shadow-sm shadow-primary/20 transition-all";
                    } else {
                        btn.className = "px-4 py-1.5 bg-slate-100 text-slate-600 text-sm font-medium rounded-full hover:bg-slate-200 transition-colors";
                    }
                }
            });

            renderNotifications();
        }

        async function markAllNotifsRead() {
            try {
                await api('/notifications/read-all', 'PUT');
                loadNotifications(); // Reload to refresh UI
            } catch (err) {
                console.error('Failed to mark all as read:', err);
            }
        }

        async function markSingleNotifRead(id) {
            try {
                await api(`/notifications/${id}/read`, 'PUT');
                loadNotifications(); // Reload to refresh UI
            } catch (err) {
                console.error('Failed to mark read:', err);
            }
        }

        // Start polling notifications every 30 seconds
        setInterval(() => {
            if (document.getElementById('admin-dashboard') && document.getElementById('admin-dashboard').style.display !== 'none') {
                loadNotifications();
            }
        }, 10000); // 10 seconds for faster UX
        // ===== ADD WALLET RECIPIENT =====
        function addWalletRecipient() {
            const list = document.getElementById('walletDistributionList');
            if (!list) return;
            const row = document.createElement('div');
            row.className = 'flex flex-col sm:flex-row items-center gap-3 relative group';
            row.innerHTML = `
                <button type="button" onclick="this.closest('.flex').remove(); calcWallet();" class="absolute -top-2 -right-2 w-6 h-6 bg-rose-500 text-white rounded-full flex items-center justify-center text-xs font-bold shadow-md opacity-0 group-hover:opacity-100 transition-all hover:bg-rose-600 z-10">&times;</button>
                <div class="w-full sm:flex-1 relative">
                    <label class="text-[10px] font-bold text-slate-400 block mb-1">Penerima Alokasi</label>
                    <div class="relative">
                        <select class="w-full px-3 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all appearance-none cursor-pointer">
                            <option value="Divisi Operasional">Divisi Operasional</option>
                            <option value="Divisi Pemasaran / Sales">Divisi Pemasaran / Sales</option>
                            <option value="Manajemen / Kas Perusahaan">Manajemen / Kas Perusahaan</option>
                            <option value="Pihak Ketiga / Vendor">Pihak Ketiga / Vendor</option>
                        </select>
                        <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-slate-400">
                            <span class="material-symbols-outlined text-lg">expand_more</span>
                        </div>
                    </div>
                </div>
                <div class="w-full sm:w-28 relative">
                    <label class="text-[10px] font-bold text-slate-400 block mb-1">Porsi (%)</label>
                    <input type="number" value="0" class="wallet-percent w-full px-3 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-700 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none pr-8 text-right transition-all" oninput="calcWallet()">
                    <span class="absolute right-3 top-[34px] text-sm font-bold text-slate-400">%</span>
                </div>
                <div class="w-full sm:flex-1 relative">
                    <label class="text-[10px] font-bold text-slate-400 block mb-1">Nominal Diterima</label>
                    <span class="absolute left-3 top-[34px] text-sm font-bold text-slate-400">Rp</span>
                    <input type="text" readonly value="0" class="wallet-nominal w-full px-3 py-2.5 pl-9 bg-emerald-50/50 border border-emerald-100 rounded-xl text-sm font-bold text-emerald-700 outline-none text-right">
                </div>
            `;
            list.appendChild(row);
            calcWallet();
        }

        // ===== ADD CABANG TO TABLE =====
        // ===== BRANCH CRUD OPERATIONS =====
        let editingBranchId = null;

        function openAddCabangModal() {
            editingBranchId = null;
            const form = document.getElementById('formTambahCabang');
            if (form) form.reset();
            const title = document.querySelector('#addCabangModal h3');
            if (title) title.textContent = 'Tambah Kantor Cabang';
            const modal = document.getElementById('addCabangModal');
            if (modal) modal.classList.remove('hidden');
        }

        function editBranch(id, name, code, location, target) {
            editingBranchId = id;
            const form = document.getElementById('formTambahCabang');
            if (!form) return;
            const inputs = form.querySelectorAll('input');
            if (inputs[0]) inputs[0].value = name;
            if (inputs[1]) inputs[1].value = code;
            if (inputs[2]) inputs[2].value = location;
            if (inputs[3]) inputs[3].value = target;

            const title = document.querySelector('#addCabangModal h3');
            if (title) title.textContent = 'Edit Kantor Cabang';

            const modal = document.getElementById('addCabangModal');
            if (modal) modal.classList.remove('hidden');
        }

        async function saveBranch() {
            const form = document.getElementById('formTambahCabang');
            if (!form) return;
            const inputs = form.querySelectorAll('input');
            const BranchName = inputs[0]?.value || '';
            const Phone = inputs[1]?.value || ''; // Map Code to Phone
            const Address = inputs[2]?.value || ''; // Map Location to Address
            const Fax = inputs[3]?.value || '0'; // Map Target to Fax

            if (!BranchName || !Address) return alert('Nama dan Lokasi wajib diisi');

            const payload = { BranchName, Address, Phone, Fax };
            try {
                if (editingBranchId) {
                    await api(`/branches/${editingBranchId}`, 'PUT', payload);
                } else {
                    await api('/branches', 'POST', payload);
                }
                closeAddCabangModal();
                loadBranchesTable();
                alert(editingBranchId ? 'Cabang berhasil diperbarui' : 'Cabang berhasil ditambahkan');
            } catch (e) {
                alert('Gagal menyimpan cabang: ' + e.message);
            }
        }

        async function deleteBranch(id) {
            if (!confirm('Yakin ingin menghapus cabang ini?')) return;
            try {
                await api(`/branches/${id}`, 'DELETE');
                loadBranchesTable();
            } catch (e) {
                alert('Gagal menghapus cabang: ' + e.message);
            }
        }


        // ===== ADD DIVISI TO TABLE =====
        function addDivisiToTable(formEl) {
            const inputs = formEl.querySelectorAll('input');
            const select = formEl.querySelector('select');
            const name = inputs[0]?.value || '';
            const code = inputs[1]?.value || '';
            const sector = select?.options[select.selectedIndex]?.text || '-';
            if (!name) return alert('Nama divisi wajib diisi');
            const tbody = document.querySelector('#content-config-divisi tbody');
            // If divisi table doesn't have tbody, find where to insert
            const container = document.getElementById('content-config-divisi');
            if (!container) return;
            // Check if table exists
            let table = container.querySelector('table');
            if (!table) {
                // Create table if it doesn't exist
                table = document.createElement('table');
                table.className = 'w-full text-left border-collapse';
                table.innerHTML = `
                    <thead>
                        <tr class="bg-slate-50 text-slate-500 uppercase text-[11px] font-bold tracking-widest border-y border-slate-200">
                            <th class="px-6 py-4">Nama Divisi</th>
                            <th class="px-6 py-4">Kode</th>
                            <th class="px-6 py-4">Sektor</th>
                            <th class="px-6 py-4 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200 text-sm"></tbody>
                `;
                container.insertBefore(table, container.firstChild);
            }
            let tbodyEl = table.querySelector('tbody');
            if (!tbodyEl) {
                tbodyEl = document.createElement('tbody');
                tbodyEl.className = 'divide-y divide-slate-200 text-sm';
                table.appendChild(tbodyEl);
            }
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-slate-50/80 transition-colors group';
            tr.innerHTML = `
                <td class="px-6 py-4 font-semibold text-slate-800">${name}</td>
                <td class="px-6 py-4"><span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-bold border border-blue-100">${code}</span></td>
                <td class="px-6 py-4 text-slate-600">${sector}</td>
                <td class="px-6 py-4">
                    <div class="flex justify-center gap-2">
                        <button class="p-1.5 text-amber-500 hover:bg-amber-50 rounded-lg transition-colors" title="Edit"><span class="material-symbols-outlined text-[20px]">edit</span></button>
                        <button onclick="this.closest('tr').remove()" class="p-1.5 text-rose-500 hover:bg-rose-50 rounded-lg transition-colors" title="Delete"><span class="material-symbols-outlined text-[20px]">delete</span></button>
                    </div>
                </td>
            `;
            tbodyEl.appendChild(tr);
            formEl.reset();
            alert('Divisi "' + name + '" berhasil ditambahkan!');
        }

        // ===== ADD USER TO TABLE =====
        async function addAksesToTable(formEl) {
            const username = document.getElementById('username')?.value || '';
            const password = document.getElementById('password')?.value || '';
            const fullname = document.getElementById('fullname')?.value || '';
            const email = document.getElementById('email')?.value || '';
            const phone_wa = document.getElementById('phone_wa')?.value || '';
            const role = document.getElementById('role');
            const roleText = role?.options[role.selectedIndex]?.text || '-';
            const roleValue = role?.value || '';
            const unit = document.getElementById('unit')?.value || '-';
            if (!username || !fullname) return alert('Username dan Nama Lengkap wajib diisi');
            try {
                // Post to API
                const payload = {
                    Username: username,
                    PasswordHash: password,
                    FullName: fullname,
                    Email: email,
                    PhoneWA: phone_wa,
                    Role: roleValue
                };

                await api('/users', 'POST', payload);

                const tbody = document.querySelector('#content-config-akses tbody');
                if (tbody) {
                    const initials = fullname.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
                    const colors = ['bg-primary/10 text-primary', 'bg-orange-100 text-orange-600', 'bg-emerald-100 text-emerald-600', 'bg-violet-100 text-violet-600'];
                    const colorClass = colors[Math.floor(Math.random() * colors.length)];
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-slate-50/80 transition-colors group';
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-semibold text-slate-800">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full ${colorClass} flex items-center justify-center font-bold text-xs">${initials}</div>
                                <span>${fullname}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4"><span class="px-2.5 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">${roleText}</span></td>
                        <td class="px-6 py-4 text-slate-600">${unit}</td>
                        <td class="px-6 py-4 text-center"><span class="w-2.5 h-2.5 rounded-full bg-emerald-500 inline-block"></span></td>
                        <td class="px-6 py-4">
                            <div class="flex justify-center gap-2">
                                <button onclick="editUser(this)" class="p-1.5 text-amber-500 hover:bg-amber-50 rounded-lg transition-colors"><span class="material-symbols-outlined text-[20px]">edit</span></button>
                                <button onclick="this.closest('tr').remove()" class="p-1.5 text-rose-500 hover:bg-rose-50 rounded-lg transition-colors"><span class="material-symbols-outlined text-[20px]">delete</span></button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
                formEl.reset();
                alert('Pengguna "' + fullname + '" berhasil ditambahkan!');

                // Refresh table if load function exists
                if (typeof window.loadUsersTable === 'function') {
                    window.loadUsersTable();
                }

            } catch (err) {
                alert('Gagal menambahkan/mengupdate pengguna: ' + err.message);
            }
        }

        // ===== LOAD USERS TABLE =====
        async function loadUsersTable() {
            try {
                const users = await api('/users');
                const tbody = document.getElementById('usersTableBody');
                const countInfo = document.getElementById('userCountInfo');
                if (!tbody) return;

                tbody.innerHTML = '';
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400 italic">Belum ada data pengguna</td></tr>';
                    if (countInfo) countInfo.textContent = '0 pengguna';
                    return;
                }

                users.forEach(u => {
                    const initials = (u.FullName || 'U').split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
                    const colors = ['bg-primary/10 text-primary', 'bg-orange-100 text-orange-600', 'bg-emerald-100 text-emerald-600', 'bg-violet-100 text-violet-600'];
                    const colorClass = colors[Math.floor(Math.random() * colors.length)];

                    let roleBadge = '<span class="px-2.5 py-1 bg-slate-100 text-slate-600 rounded-full text-xs font-bold">Viewer</span>';
                    let roleDisplay = 'Sistem Viewer';
                    if (u.Role === 'admin_pusat' || u.Role === 'AdminDBS') { roleBadge = '<span class="px-2.5 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">Super Admin</span>'; roleDisplay = 'admin_pusat'; }
                    if (u.Role === 'admin_cabang') { roleBadge = '<span class="px-2.5 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-bold">Admin Cabang</span>'; roleDisplay = 'admin_cabang'; }
                    if (u.Role === 'petugas') { roleBadge = '<span class="px-2.5 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-bold">Petugas Lapangan</span>'; roleDisplay = 'petugas'; }

                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-slate-50/80 transition-colors group';
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-semibold text-slate-800">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full ${colorClass} flex items-center justify-center font-bold text-xs">${initials}</div>
                                <div>
                                    <span class="block">${u.FullName}</span>
                                    <span class="text-[10px] text-slate-400 font-normal">@${u.Username}</span>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">${roleBadge}</td>
                        <td class="px-6 py-4">
                            <div class="text-xs text-slate-600 flex flex-col gap-0.5">
                                <span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-[14px]">mail</span> ${u.Email || '-'}</span>
                                <span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-[14px]">forum</span> ${u.PhoneWA || '-'}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 hidden js-hidden-data" data-userid="${u.UserID}" data-role="${roleDisplay}"></td>
                        <td class="px-6 py-4">
                            <div class="flex justify-center gap-2">
                                <button onclick="editUser(this)" class="p-1.5 text-amber-500 hover:bg-amber-50 rounded-lg transition-colors"><span class="material-symbols-outlined text-[20px]">edit</span></button>
                                <button onclick="deleteUser(${u.UserID})" class="p-1.5 text-rose-500 hover:bg-rose-50 rounded-lg transition-colors"><span class="material-symbols-outlined text-[20px]">delete</span></button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                if (countInfo) countInfo.textContent = `Menampilkan ${users.length} pengguna`;
            } catch (err) {
                console.error('Error loading users:', err);
                const tbody = document.getElementById('usersTableBody');
                if (tbody) tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-rose-500 font-bold">Gagal memuat data</td></tr>`;
            }
        }

        async function deleteUser(id) {
            if (!confirm('Hapus pengguna ini?')) return;
            try {
                await api('/users/' + id, 'DELETE');
                loadUsersTable();
            } catch (e) {
                alert(e.message);
            }
        }

        // Ensure load is called on config tab switching
        const origSwitchTabConfig = window.switchTabConfig;
        window.switchTabConfig = function (tabId, element) {
            if (origSwitchTabConfig) origSwitchTabConfig(tabId, element);
            if (tabId === 'akses') {
                loadUsersTable();
            }
        }


        // ===== EDIT USER =====
        function editUser(btn) {
            const tr = btn.closest('tr');

            // If it's a dynamic row (from addAksesToTable direct injection without refresh)
            let emailTxt = '';
            let waTxt = '';
            let roleValue = 'viewer';
            let fullname = '';

            // Check if it's the new DB-loaded row mapping
            const hiddenData = tr.querySelector('.js-hidden-data');
            if (hiddenData) {
                fullname = tr.querySelector('td:nth-child(1) span.block').innerText;
                roleValue = hiddenData.dataset.role;
                const badges = tr.querySelectorAll('td:nth-child(3) span.flex');
                if (badges.length > 0) {
                    emailTxt = badges[0].innerText.trim();
                    waTxt = badges[1].innerText.trim();
                }
            } else {
                // Fallback for simple injected row
                fullname = tr.querySelector('td:nth-child(1) span').innerText;
                const roleText = tr.querySelector('td:nth-child(2) span').innerText;
                if (roleText.includes('Super Admin')) roleValue = 'admin_pusat';
                else if (roleText.includes('Admin Cabang')) roleValue = 'admin_cabang';
                else if (roleText.includes('Petugas')) roleValue = 'petugas';
            }

            document.getElementById('fullname').value = fullname;
            document.getElementById('unit').value = '-';
            document.getElementById('role').value = roleValue;

            document.getElementById('email').value = (emailTxt === '-') ? '' : emailTxt;
            document.getElementById('phone_wa').value = (waTxt === '-') ? '' : waTxt;

            // Generate dummy username based on fullname
            document.getElementById('username').value = fullname.split(' ')[0].toLowerCase() + Math.floor(Math.random() * 100);
            document.getElementById('password').value = '********'; // placeholder

            // Hide the row since we will re-add it on save (simple edit flow)
            tr.dataset.editing = 'true';
            tr.style.display = 'none';

            openAddAksesModal();
        }

        // ===== SATUAN LAINNYA TOGGLE =====
        document.addEventListener('DOMContentLoaded', function () {
            const satuanSelect = document.getElementById('paramSatuanSelect');
            if (satuanSelect) {
                satuanSelect.addEventListener('change', function () {
                    const customDiv = document.getElementById('paramSatuanCustom');
                    if (customDiv) {
                        if (this.value === 'lainnya') {
                            customDiv.classList.remove('hidden');
                        } else {
                            customDiv.classList.add('hidden');
                        }
                    }
                });
            }
        });
    </script>
</body>

</html>